<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daggerheart Adversary Converter</title>
  <style>
    :root {
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --bg-input: #0f0f23;
      --text-primary: #e4e4e7;
      --text-secondary: #c4c4cc;
      --accent: #c9a227;
      --accent-hover: #e4b82e;
      --accent-secondary: #6366f1;
      --accent-secondary-hover: #818cf8;
      --border: #333355;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --focus-ring: 0 0 0 2px var(--bg-dark), 0 0 0 4px var(--accent);
    }

    /* Light mode */
    :root.light-mode {
      --bg-dark: #f5f5f7;
      --bg-card: #ffffff;
      --bg-input: #e8e8ed;
      --text-primary: #1a1a2e;
      --text-secondary: #52525b;
      --border: #d4d4d8;
      --focus-ring: 0 0 0 2px var(--bg-card), 0 0 0 4px var(--accent);
    }

    :root.light-mode .json-output {
      color: #1e40af;
    }

    :root.light-mode .stat-block {
      background: var(--bg-card);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Navigation Bar */
    .navbar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 60px;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--accent);
      font-weight: 700;
      font-size: 1.25rem;
    }

    .navbar-brand-icon {
      font-size: 1.5rem;
    }

    .navbar-nav {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.95rem;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .nav-link:hover {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    .nav-link.active {
      color: var(--accent);
      background: var(--bg-input);
      border-color: var(--accent);
    }

    .nav-link svg {
      width: 18px;
      height: 18px;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .coffee-link {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      opacity: 0.7;
      transition: all 0.2s;
    }

    .coffee-link:hover {
      color: #ffdd00;
      opacity: 1;
    }

    .btn-login {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.25rem;
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-login:hover {
      background: var(--accent-hover);
    }

    /* Login Modal */
    .login-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .login-modal.hidden {
      display: none;
    }

    .login-modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      overflow: hidden;
    }

    .login-modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .login-modal-header h2 {
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .login-modal-header p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .login-modal-body {
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .login-modal-footer {
      padding: 1rem 1.5rem;
      background: var(--bg-input);
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .btn-sso {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.875rem 1.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-sso:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .btn-sso svg {
      width: 24px;
      height: 24px;
    }

    .btn-sso.discord {
      border-color: #5865F2;
    }

    .btn-sso.discord:hover {
      background: rgba(88, 101, 242, 0.1);
    }

    /* Page Views */
    .page-view {
      display: none;
    }

    .page-view.active {
      display: block;
    }

    /* Community Library Page */
    .community-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .community-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .community-header h1 {
      color: var(--accent);
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .community-header p {
      color: var(--text-secondary);
    }

    /* Admin Page Styles */
    .admin-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .admin-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .admin-header h1 {
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .admin-header p {
      color: var(--text-secondary);
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .admin-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }

    .admin-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .admin-tab:hover {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    .admin-tab.active {
      color: var(--accent);
      background: var(--bg-card);
      border-color: var(--border);
      border-bottom-color: var(--bg-card);
      margin-bottom: -1px;
    }

    .admin-tab-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0 8px 8px 8px;
      padding: 1rem;
    }

    .admin-toolbar {
      margin-bottom: 1rem;
    }

    .admin-search {
      max-width: 400px;
    }

    .admin-table-container {
      overflow-x: auto;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .admin-table th,
    .admin-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .admin-table th {
      background: var(--bg-input);
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .admin-table td {
      color: var(--text-primary);
    }

    .admin-table tr:hover td {
      background: var(--bg-input);
    }

    .admin-table .loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 2rem;
    }

    .admin-author {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .admin-author img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }

    .admin-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .admin-badge.published {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .admin-badge.unpublished {
      background: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }

    .admin-badge.banned {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .admin-badge.admin {
      background: rgba(201, 162, 39, 0.2);
      color: var(--accent);
    }

    .admin-badge.active {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .admin-actions {
      display: flex;
      gap: 0.5rem;
    }

    .admin-btn {
      padding: 0.35rem 0.6rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg-input);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .admin-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .admin-btn.danger {
      color: #f44336;
    }

    .admin-btn.danger:hover {
      background: rgba(244, 67, 54, 0.1);
      border-color: #f44336;
    }

    .admin-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .admin-pagination span {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    /* My Library Page Styles - Folder-based Drag & Drop */
    .my-library-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .my-library-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .my-library-header h1 {
      color: var(--accent);
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .my-library-header p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .my-library-container {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 1rem;
      min-height: 550px;
    }

    /* Folders Sidebar */
    .folders-sidebar {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .folders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
    }

    .folders-title {
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .folder-add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .folder-add-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }

    .folders-tree {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .folders-list {
      padding-left: 0.5rem;
      margin: 0.25rem 0;
    }

    .folder-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text-primary);
      border: 2px solid transparent;
      margin-bottom: 2px;
    }

    .folder-item:hover {
      background: var(--bg-input);
    }

    .folder-item.active {
      background: var(--bg-input);
      border-color: var(--accent);
    }

    .folder-item.drag-over {
      background: rgba(201, 162, 39, 0.15);
      border-color: var(--accent);
      border-style: dashed;
    }

    .folder-icon {
      display: flex;
      align-items: center;
      color: var(--accent);
      flex-shrink: 0;
    }

    .folder-name {
      flex: 1;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .folder-name-input {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--accent);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
    }

    .folder-count {
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: var(--bg-dark);
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    .folder-root {
      font-weight: 500;
    }

    .folder-ungrouped {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }

    .folders-help {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--border);
      background: var(--bg-input);
    }

    .folders-help small {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    /* Library Content Area */
    .library-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .library-content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
      gap: 1rem;
      flex-wrap: wrap;
    }

    .library-title-section {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }

    .library-title-section h2 {
      color: var(--accent);
      font-size: 1.1rem;
      margin: 0;
      font-weight: 600;
    }

    .library-item-count {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .library-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .library-search {
      padding: 0.4rem 0.75rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.85rem;
      width: 180px;
    }

    .library-search:focus {
      outline: none;
      border-color: var(--accent);
    }

    .folder-edit-actions {
      display: flex;
      gap: 0.25rem;
    }

    .icon-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--bg-dark);
      color: var(--text-primary);
      border-color: var(--text-secondary);
    }

    .icon-btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      border-color: var(--error);
    }

    .library-items-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      position: relative;
    }

    .library-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 0.75rem;
    }

    .library-empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      text-align: center;
      padding: 2rem;
    }

    .library-empty-state.hidden {
      display: none;
    }

    .empty-icon-large {
      margin-bottom: 1rem;
      color: var(--text-secondary);
    }

    .empty-title {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .empty-hint {
      font-size: 0.85rem;
      opacity: 0.7;
      max-width: 300px;
    }

    /* Draggable Adversary Cards */
    .adversary-card {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.875rem;
      cursor: grab;
      transition: all 0.15s;
      position: relative;
    }

    .adversary-card:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .adversary-card:active {
      cursor: grabbing;
    }

    .adversary-card.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }

    .adversary-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.4rem;
    }

    .adversary-card-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
      line-height: 1.3;
      flex: 1;
      margin-right: 0.5rem;
    }

    .adversary-card-tier {
      background: var(--accent);
      color: var(--bg-dark);
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .adversary-card-type {
      color: var(--text-secondary);
      font-size: 0.8rem;
      margin-bottom: 0.4rem;
    }

    .adversary-card-stats {
      display: flex;
      gap: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .adversary-card-drag-hint {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      color: var(--text-secondary);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .adversary-card:hover .adversary-card-drag-hint {
      opacity: 0.5;
    }

    /* Drag Ghost Styling */
    .drag-ghost {
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Add to Group Modal */
    .modal-small {
      max-width: 400px;
    }

    .add-to-group-name {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .group-select-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 250px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .group-select-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .group-select-item:hover {
      border-color: var(--accent);
      background: var(--bg-dark);
    }

    .create-new-group-inline {
      display: flex;
      gap: 0.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .create-new-group-inline input {
      flex: 1;
    }

    @media (max-width: 900px) {
      .my-library-container {
        grid-template-columns: 200px 1fr;
      }
    }

    @media (max-width: 768px) {
      .my-library-container {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .folders-sidebar {
        max-height: 200px;
      }

      .library-search {
        width: 140px;
      }
    }

    @media (max-width: 768px) {
      .navbar-inner {
        flex-wrap: wrap;
        height: auto;
        padding: 0.75rem 0;
        gap: 0.75rem;
      }

      .navbar-brand {
        font-size: 1.1rem;
      }

      .navbar-nav {
        order: 3;
        width: 100%;
        justify-content: center;
      }

      .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
      }

      .nav-link span {
        display: none;
      }

      .navbar-right {
        gap: 0.5rem;
      }

      .community-page {
        padding: 1rem;
      }

      .my-library-page {
        padding: 1rem;
      }

      .my-library-container {
        grid-template-columns: 1fr;
      }

      .groups-sidebar {
        order: 1;
      }

      .groups-list {
        max-height: 200px;
      }

      .group-content {
        order: 2;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--accent);
    }

    .header-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      position: relative;
    }

    h1 {
      font-size: 2rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    /* Theme Toggle */
    .theme-toggle {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .theme-toggle:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .theme-icon-light {
      display: none;
    }

    :root.light-mode .theme-icon-dark {
      display: none;
    }

    :root.light-mode .theme-icon-light {
      display: inline;
    }

    @media (max-width: 768px) {
      .header-row {
        flex-direction: column;
      }

      .theme-toggle {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .keyboard-hints {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }

    .keyboard-hint {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    kbd {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.15rem 0.4rem;
      font-family: monospace;
      font-size: 0.75rem;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Tablet breakpoint */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      .keyboard-hints {
        display: none;
      }

      .panel {
        padding: 1rem;
      }

      .btn {
        min-height: 44px;
        padding: 0.75rem 1rem;
      }

      .btn-small {
        min-height: 44px;
        padding: 0.5rem 0.75rem;
      }

      .btn-icon {
        min-width: 44px;
        min-height: 44px;
        padding: 0.5rem;
      }

      .tab {
        min-height: 44px;
        padding: 0.75rem 1rem;
      }

      .mode-btn {
        min-height: 44px;
        padding: 0.75rem;
      }

      .sample-buttons {
        display: none;
      }

      .stat-grid {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 0.75rem;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .recent-menu {
        max-width: calc(100vw - 2rem);
        right: auto;
        left: 0;
      }

      .panel-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .panel-header .btn-group {
        width: 100%;
        flex-wrap: wrap;
      }

      .undo-toolbar {
        margin-left: 0;
      }
    }

    /* Small phone breakpoint */
    @media (max-width: 480px) {
      .container {
        padding: 0.75rem;
      }

      h1 {
        font-size: 1.25rem;
      }

      .subtitle {
        font-size: 0.85rem;
      }

      .panel {
        padding: 0.75rem;
        border-radius: 8px;
      }

      .stat-block {
        padding: 1rem;
      }

      .stat-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .tabs {
        gap: 0.25rem;
      }

      .tab {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        flex: 1;
        text-align: center;
      }

      .btn-group {
        width: 100%;
      }

      .btn-group .btn {
        flex: 1;
        justify-content: center;
      }

      .feature-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .feature-actions {
        opacity: 1;
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
      }

      .feature {
        position: relative;
      }

      textarea {
        min-height: 200px;
        font-size: 0.85rem;
      }

      .live-parse-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .confidence-legend {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
    }

    .panel {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid var(--border);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
    }

    /* Focus indicators for accessibility */
    *:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    button:focus-visible, a:focus-visible, input:focus-visible,
    select:focus-visible, textarea:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    /* Ensure all interactive elements have visible focus */
    .feature-type:focus-visible,
    .tag:focus-visible,
    .collapsible-header:focus-visible,
    .batch-item-header:focus-visible,
    .image-placeholder:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    /* Drop zone */
    .drop-zone {
      position: relative;
      width: 100%;
    }

    .drop-zone.drag-over textarea {
      border-color: var(--accent);
      background: rgba(201, 162, 39, 0.1);
    }

    .drop-zone.drag-over::after {
      content: 'Drop file here';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(201, 162, 39, 0.2);
      border: 2px dashed var(--accent);
      border-radius: 8px;
      font-size: 1.2rem;
      color: var(--accent);
      pointer-events: none;
    }

    textarea {
      width: 100%;
      min-height: 250px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      color: var(--text-primary);
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9rem;
      resize: vertical;
      transition: border-color 0.2s, background 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    textarea::placeholder {
      color: var(--text-secondary);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-dark);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text-primary);
    }

    .btn-secondary:hover:not(:disabled) {
      background: #444466;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #16a34a;
    }

    .btn-small {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }

    .btn-icon {
      padding: 0.4rem;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-icon:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.4rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .form-input, .form-select {
      width: 100%;
      padding: 0.6rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Mode toggle */
    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .mode-btn {
      flex: 1;
      padding: 0.5rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .mode-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }

    .mode-btn:hover:not(.active) {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Recent conversions dropdown */
    .recent-dropdown {
      position: relative;
      display: inline-block;
    }

    .recent-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      min-width: 200px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-top: 0.25rem;
      z-index: 100;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .recent-menu.show {
      display: block;
    }

    .recent-item {
      padding: 0.6rem 0.8rem;
      cursor: pointer;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recent-item:last-child {
      border-bottom: none;
    }

    .recent-item:hover {
      background: var(--bg-input);
    }

    .recent-item-name {
      font-weight: 500;
    }

    .recent-item-tier {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .recent-item-delete {
      color: var(--text-secondary);
      padding: 0.2rem;
      cursor: pointer;
    }

    .recent-item-delete:hover {
      color: var(--error);
    }

    /* Live Parse Preview */
    .live-parse {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-input);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .live-parse-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .live-parse-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .parse-field {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.6rem;
      background: var(--bg-card);
      border-radius: 4px;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .parse-field-label {
      color: var(--text-secondary);
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .parse-field-value {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }

    /* Confidence Badges - now with shape and text for accessibility */
    .confidence-badge {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: white;
    }

    .confidence-high {
      background: var(--success);
      border-radius: 50%; /* Circle = good */
    }
    .confidence-high::after {
      content: 'âœ“';
      font-size: 10px;
    }

    .confidence-medium {
      background: var(--warning);
      border-radius: 2px; /* Square = uncertain */
    }
    .confidence-medium::after {
      content: '~';
      font-size: 12px;
    }

    .confidence-low {
      background: var(--error);
      border-radius: 0;
      clip-path: polygon(50% 0%, 100% 100%, 0% 100%); /* Triangle = warning */
      width: 14px;
      height: 12px;
    }
    .confidence-low::after {
      content: '!';
      font-size: 8px;
      margin-top: 2px;
    }

    .confidence-legend {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.75rem;
    }

    .confidence-legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    /* Adjustments */
    .adjustments-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .adjustments-title {
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
      color: var(--accent);
    }

    /* Undo/Redo toolbar */
    .undo-toolbar {
      display: flex;
      gap: 0.25rem;
      margin-left: auto;
    }

    /* Stat Block Preview */
    .stat-block {
      background: var(--bg-input);
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 1.5rem;
      font-family: 'Segoe UI', sans-serif;
    }

    .stat-block-header {
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.75rem;
      margin-bottom: 1rem;
    }

    .stat-block-name {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 0.25rem;
    }

    .stat-block-type {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .stat-block-desc {
      font-style: italic;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    /* Image Section */
    .stat-block-image-section {
      margin-bottom: 1rem;
    }

    .stat-block-image-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: 6px;
      border: 2px solid var(--border);
      object-fit: cover;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .stat-block-image-preview:hover {
      border-color: var(--accent);
    }

    .image-url-input {
      width: 100%;
      padding: 0.4rem 0.6rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.85rem;
    }

    .image-url-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .image-url-input::placeholder {
      color: var(--text-secondary);
    }

    .image-placeholder {
      width: 200px;
      height: 120px;
      border: 2px dashed var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .image-placeholder:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Collapsible sections */
    .collapsible {
      border-top: 1px solid var(--border);
      margin-top: 1rem;
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      cursor: pointer;
      user-select: none;
    }

    .collapsible-header:hover {
      color: var(--accent);
    }

    .collapsible-title {
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .collapsible-icon {
      transition: transform 0.2s;
      font-size: 0.75rem;
    }

    .collapsible.collapsed .collapsible-icon {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      padding-bottom: 0.5rem;
    }

    .collapsible.collapsed .collapsible-content {
      display: none;
    }

    /* Editable stat line */
    .stat-line {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }

    .stat-label {
      color: var(--accent);
      font-weight: 600;
      flex-shrink: 0;
    }

    .stat-value-editable {
      background: transparent;
      border: none;
      border-bottom: 1px dashed transparent;
      color: var(--text-primary);
      font-size: inherit;
      font-family: inherit;
      padding: 0.1rem 0.3rem;
      flex: 1;
      min-width: 0;
    }

    .stat-value-editable:hover {
      border-bottom-color: var(--border);
    }

    .stat-value-editable:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    /* Editable stat grid */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.5rem;
      margin: 1rem 0;
      padding: 0.75rem;
      background: rgba(201, 162, 39, 0.1);
      border-radius: 6px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-item-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .stat-item-value {
      font-size: 1rem;
      font-weight: bold;
    }

    .stat-item-input {
      font-size: 1rem;
      font-weight: bold;
      background: transparent;
      border: none;
      border-bottom: 1px dashed transparent;
      color: var(--text-primary);
      text-align: center;
      width: 100%;
      padding: 0.1rem;
    }

    .stat-item-input:hover {
      border-bottom-color: var(--border);
    }

    .stat-item-input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    /* Features Section */
    .features-section {
      padding-top: 0.5rem;
    }

    .feature {
      margin-bottom: 0.75rem;
      padding: 0.5rem;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .feature:hover {
      background: rgba(201, 162, 39, 0.05);
    }

    .feature-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .feature-name-input {
      font-weight: 600;
      color: var(--text-primary);
      background: transparent;
      border: none;
      border-bottom: 1px dashed var(--border);
      padding: 0.1rem 0.3rem;
      font-size: inherit;
      font-family: inherit;
      min-width: 100px;
      flex: 1;
    }

    .feature-name-input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    .feature-type {
      font-size: 0.75rem;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      text-transform: uppercase;
      cursor: pointer;
      transition: opacity 0.2s;
      border: none;
    }

    .feature-type:hover {
      opacity: 0.8;
    }

    .feature-type-passive { background: #334155; color: #94a3b8; }
    .feature-type-action { background: #7c2d12; color: #fed7aa; }
    .feature-type-reaction { background: #1e3a5f; color: #93c5fd; }

    .feature-desc-input {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 0.25rem;
      background: transparent;
      border: none;
      border-bottom: 1px dashed transparent;
      padding: 0.1rem 0;
      font-family: inherit;
      width: 100%;
      resize: none;
      overflow: hidden;
    }

    .feature-desc-input:hover {
      border-bottom-color: var(--border);
    }

    .feature-desc-input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    .feature-actions {
      margin-left: auto;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .feature:hover .feature-actions {
      opacity: 1;
    }

    .feature-btn {
      background: none;
      border: 1px solid transparent;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.5rem;
      font-size: 1rem;
      min-width: 44px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .feature-btn:hover {
      color: var(--error);
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--error);
    }

    .add-feature-btn {
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      margin-top: 0.5rem;
    }

    .add-feature-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Tags */
    .tags-section {
      padding-top: 0.5rem;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .tag {
      font-size: 0.8rem;
      padding: 0.4rem 0.75rem;
      background: rgba(201, 162, 39, 0.2);
      color: var(--accent);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      min-height: 32px;
      border: 1px solid transparent;
    }

    .tag:hover {
      background: rgba(201, 162, 39, 0.4);
      border-color: var(--accent);
    }

    .tag-remove {
      margin-left: 0.25rem;
      opacity: 0.7;
      font-size: 1rem;
      padding: 0.25rem;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      min-height: 20px;
    }

    .tag-remove:hover {
      opacity: 1;
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .add-tag-input {
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--text-primary);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      width: 80px;
    }

    .add-tag-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Read-only stat block styles for community viewing */
    .stat-block-image-section-readonly {
      text-align: center;
      margin: 1rem 0;
    }

    .stat-block-image-readonly {
      max-width: 100%;
      max-height: 250px;
      border-radius: 8px;
      border: 2px solid var(--border);
    }

    .stat-line-readonly {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .stat-line-readonly .stat-value {
      color: var(--text-primary);
    }

    .stat-grid-readonly {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 0.5rem;
      margin: 1rem 0;
      padding: 0.75rem;
      background: var(--bg-dark);
      border-radius: 6px;
    }

    .stat-item-readonly {
      text-align: center;
      padding: 0.5rem;
    }

    .stat-item-readonly .stat-item-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .stat-item-readonly .stat-item-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .features-section-readonly {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .features-section-readonly .section-title,
    .tags-section-readonly .section-title {
      font-size: 0.9rem;
      color: var(--accent);
      margin-bottom: 0.75rem;
      font-weight: 600;
    }

    .feature-readonly {
      background: var(--bg-dark);
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .feature-header-readonly {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
    }

    .feature-name-readonly {
      font-weight: 600;
      color: var(--text-primary);
    }

    .feature-desc-readonly {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .tags-section-readonly {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .tags-readonly {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag-readonly {
      background: var(--bg-dark);
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .tab.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }

    .tab:hover:not(.active) {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* JSON Output */
    .json-output {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 500px;
      overflow-y: auto;
      color: #93c5fd;
    }

    /* Markdown Output */
    .markdown-output {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Text Output */
    .text-output {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Segoe UI', sans-serif;
      font-size: 0.9rem;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      max-width: calc(100vw - 2rem);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.paused {
      /* Keeps toast visible when hovered */
    }

    .toast-success { background: var(--success); }
    .toast-error { background: var(--error); }
    .toast-info { background: var(--info); }

    .toast-message {
      flex: 1;
    }

    .toast-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .toast-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 0 0 0 8px;
      transition: width 0.1s linear;
    }

    @media (max-width: 480px) {
      .toast {
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
      }
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    .sample-btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
    }

    .empty-state {
      text-align: center;
      color: var(--text-secondary);
      padding: 3rem;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .draft-indicator {
      font-size: 0.75rem;
      color: var(--warning);
      margin-left: 0.5rem;
    }

    .batch-separator {
      text-align: center;
      padding: 1rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .batch-results {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .batch-item {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .batch-item-header {
      background: var(--bg-input);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .batch-item-header:hover {
      background: rgba(201, 162, 39, 0.1);
    }

    .batch-item-content {
      padding: 1rem;
    }

    .batch-item.collapsed .batch-item-content {
      display: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-input);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* Print styles */
    @media print {
      body {
        background: white;
        color: black;
      }

      .container {
        max-width: 100%;
        padding: 0;
      }

      header, .keyboard-hints, .panel:first-child,
      .tabs, .btn-group, .adjustments-section,
      .live-parse, .toast, .mode-toggle {
        display: none !important;
      }

      .main-grid {
        display: block;
      }

      .panel {
        border: none;
        padding: 0;
        background: white;
      }

      .stat-block {
        border: 2px solid #c9a227;
        padding: 1.5rem;
        background: white;
        page-break-inside: avoid;
      }

      .stat-block-name {
        color: #c9a227;
      }

      .stat-label {
        color: #c9a227;
      }

      .collapsible-header {
        display: none;
      }

      .stat-block-image-section {
        text-align: center;
        margin-bottom: 1rem;
      }

      .stat-block-image-preview {
        max-width: 150px;
        max-height: 150px;
        border: 1px solid #c9a227;
      }

      .image-url-input,
      .image-placeholder {
        display: none !important;
      }

      .collapsible-content {
        display: block !important;
      }

      .feature-actions, .tag-remove, .add-feature-btn,
      .add-tag-input, .collapsible-icon {
        display: none !important;
      }

      .stat-value-editable, .stat-item-input,
      .feature-name-input, .feature-desc-input {
        border: none !important;
      }
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Auth UI */
    .auth-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .auth-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-oauth {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-oauth:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .btn-oauth svg {
      width: 18px;
      height: 18px;
    }

    .user-menu {
      position: relative;
    }

    .user-menu-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .user-menu-toggle:hover {
      border-color: var(--accent);
      background: var(--bg-input);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      color: var(--bg-dark);
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 180px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-top: 0.25rem;
      z-index: 200;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    :root.light-mode .user-dropdown {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .user-dropdown.show {
      display: block;
    }

    .user-dropdown-item {
      padding: 0.6rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      display: block;
      width: 100%;
      text-align: left;
      background: var(--bg-card);
      border: none;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
      transition: background 0.15s;
    }

    .user-dropdown-item:last-child {
      border-bottom: none;
    }

    .user-dropdown-item:hover {
      background: var(--bg-input);
    }

    .user-dropdown-item.danger {
      color: var(--error);
    }

    .user-dropdown-item.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Community Tab Styles */
    .community-container {
      min-height: 400px;
    }

    .community-filters {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .community-filters .search-input {
      flex: 1;
      min-width: 200px;
      padding: 0.6rem 1rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .community-filters .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .community-filters select {
      padding: 0.6rem;
      min-width: 120px;
      width: auto;
    }

    .community-filters .form-input,
    .community-filters .form-select {
      width: auto;
    }

    .community-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    .community-item {
      display: flex;
      flex-direction: column;
      padding: 1rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      gap: 0.5rem;
      position: relative;
    }

    .community-item:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .community-item-main {
      flex: 1;
      min-width: 0;
    }

    .community-item-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
      padding-right: 36px;
    }

    .community-item-name {
      font-weight: 600;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .community-item-source {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 3px;
      background: var(--accent);
      color: var(--bg-dark);
      font-weight: 500;
      white-space: nowrap;
    }

    .community-item-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
      flex-wrap: wrap;
    }

    .community-item-stat {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .community-item-stat strong {
      color: var(--text-primary);
    }

    .community-item-meta {
      display: flex;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      flex-wrap: wrap;
      align-items: center;
    }

    .community-item-tag {
      background: var(--bg-dark);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .community-item-tag.tier {
      background: var(--accent);
      color: var(--bg-dark);
      font-weight: 600;
    }

    .community-item-author {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .community-item-author img {
      width: 18px;
      height: 18px;
      border-radius: 50%;
    }

    .community-item-votes {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem;
      min-width: 50px;
    }

    .community-item-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
    }

    .share-link-btn {
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.2rem 0.35rem;
      font-size: 0.75rem;
      opacity: 0.5;
      transition: all 0.2s;
      margin-left: 0;
      flex-shrink: 0;
    }

    .share-link-btn:hover {
      color: var(--accent);
      opacity: 1;
    }

    .community-filters-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }

    .filter-btn {
      padding: 0.4rem 0.8rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: var(--accent);
    }

    .filter-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }

    .vote-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.25rem;
      color: var(--text-secondary);
      transition: color 0.2s;
      font-size: 1.1rem;
    }

    .vote-btn:hover {
      color: var(--accent);
    }

    .vote-btn.active.upvote {
      color: var(--success);
    }

    .vote-btn.active.downvote {
      color: var(--error);
    }

    .vote-score {
      font-weight: bold;
      font-size: 1rem;
    }

    .vote-score.positive {
      color: var(--success);
    }

    .vote-score.negative {
      color: var(--error);
    }

    .community-empty {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .community-pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .community-pagination button {
      padding: 0.5rem 1rem;
    }

    /* Community Detail Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--accent);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.25rem;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .modal-vote-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .modal-actions-secondary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.5rem;
      background: var(--bg-input);
      border-top: 1px solid var(--border);
      font-size: 0.85rem;
    }

    .modal-author {
      color: var(--text-secondary);
    }

    .modal-author img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 0.35rem;
    }

    .report-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
    }

    .report-btn:hover {
      color: var(--error);
      opacity: 1;
    }

    /* Share button */
    .btn-share {
      background: var(--accent-secondary);
      color: white;
    }

    .btn-share:hover {
      background: var(--accent-secondary-hover);
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .community-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem;
      gap: 1rem;
    }

    /* My Submissions section */
    .my-submissions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
      .auth-section {
        order: -1;
        width: 100%;
        justify-content: center;
      }

      .community-filters {
        flex-direction: column;
      }

      .community-filters .search-input,
      .community-filters select {
        width: 100%;
      }

      .community-item {
        flex-direction: column;
        align-items: stretch;
      }

      .community-item-votes {
        flex-direction: row;
        justify-content: center;
        border-top: 1px solid var(--border);
        margin-top: 0.75rem;
        padding-top: 0.75rem;
      }

      .modal-footer {
        flex-direction: column;
      }

      .modal-footer .btn-group {
        width: 100%;
      }
    }

    /* Footer */
    .site-footer {
      text-align: center;
      padding: 1.5rem 1rem;
      margin-top: 2rem;
      border-top: 1px solid var(--border);
    }

    .site-footer p {
      font-size: 0.7rem;
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.4;
      opacity: 0.7;
    }

    .footer-links {
      margin-top: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .footer-links a {
      font-size: 0.65rem;
      color: var(--text-secondary);
      opacity: 0.6;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .footer-links a:hover {
      opacity: 1;
      text-decoration: underline;
    }

    .footer-divider {
      color: var(--text-secondary);
      opacity: 0.4;
    }

    .coffee-footer-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .coffee-footer-link:hover svg {
      color: #ffdd00;
    }

    /* Privacy Modal */
    .privacy-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .privacy-modal.active {
      display: flex;
    }

    .privacy-modal-content {
      background: var(--bg-dark);
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
    }

    .privacy-modal-content h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--text);
    }

    .privacy-modal-content h3 {
      color: var(--accent);
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .privacy-modal-content p,
    .privacy-modal-content li {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .privacy-modal-content ul {
      padding-left: 1.5rem;
      margin: 0.5rem 0;
    }

    .privacy-modal-content .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.25rem 0.5rem;
    }

    .privacy-modal-content .close-btn:hover {
      color: var(--text);
    }

    .zs-credits {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }

    .zs-credits a {
      color: var(--text-secondary);
      text-decoration: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .zs-credits a:hover {
      opacity: 1;
      color: var(--accent);
    }

    .zs-credits span {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
    }

    @media print {
      .site-footer {
        display: none;
      }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="sr-only">Skip to main content</a>

  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-inner">
      <a href="#" class="navbar-brand" onclick="navigateTo('converter'); return false;">
        <span class="navbar-brand-icon">âš”ï¸</span>
        <span>Daggerheart Tools</span>
      </a>

      <div class="navbar-nav">
        <a href="#" class="nav-link active" data-page="converter" onclick="navigateTo('converter'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
          <span>Converter</span>
        </a>
        <a href="#" class="nav-link" data-page="myLibrary" onclick="navigateTo('myLibrary'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            <line x1="12" y1="6" x2="12" y2="12"/>
            <line x1="9" y1="9" x2="15" y2="9"/>
          </svg>
          <span>My Library</span>
        </a>
        <a href="#" class="nav-link" data-page="community" onclick="navigateTo('community'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <span>Community Library</span>
        </a>
        <a href="#" class="nav-link admin-only hidden" id="adminNavLink" data-page="admin" onclick="navigateTo('admin'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 15v2"/>
            <path d="M12 11v.01"/>
            <path d="M3 21h18"/>
            <path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"/>
            <path d="M9 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"/>
          </svg>
          <span>Admin</span>
        </a>
      </div>

      <div class="navbar-right">
        <a href="https://buymeacoffee.com/marcusu" target="_blank" rel="noopener" class="coffee-link" title="Buy me a coffee">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
            <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
            <line x1="6" y1="2" x2="6" y2="4"/>
            <line x1="10" y1="2" x2="10" y2="4"/>
            <line x1="14" y1="2" x2="14" y2="4"/>
          </svg>
        </a>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle light/dark mode" title="Toggle theme">
          <span class="theme-icon-dark" aria-hidden="true">â˜€ï¸</span>
          <span class="theme-icon-light" aria-hidden="true">ðŸŒ™</span>
        </button>
        <div id="authSection">
          <!-- Auth UI populated by JavaScript -->
        </div>
      </div>
    </div>
  </nav>

  <!-- Login Modal -->
  <div id="loginModal" class="login-modal hidden" onclick="closeLoginModal(event)">
    <div class="login-modal-content" onclick="event.stopPropagation()">
      <div class="login-modal-header">
        <h2>Welcome Back</h2>
        <p>Sign in to share conversions and vote</p>
      </div>
      <div class="login-modal-body">
        <a href="/auth/discord" class="btn-sso discord">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.317 4.492c-1.53-.69-3.17-1.2-4.885-1.49a.075.075 0 0 0-.079.036c-.21.369-.444.85-.608 1.23a18.566 18.566 0 0 0-5.487 0 12.36 12.36 0 0 0-.617-1.23A.077.077 0 0 0 8.562 3c-1.714.29-3.354.8-4.885 1.491a.07.07 0 0 0-.032.027C.533 9.093-.32 13.555.099 17.961a.08.08 0 0 0 .031.055 20.03 20.03 0 0 0 5.993 2.98.078.078 0 0 0 .084-.026c.462-.63.874-1.295 1.226-1.963a.074.074 0 0 0-.041-.104 13.201 13.201 0 0 1-1.872-.878.075.075 0 0 1-.008-.125c.126-.093.252-.19.372-.287a.075.075 0 0 1 .078-.01c3.927 1.764 8.18 1.764 12.061 0a.075.075 0 0 1 .079.009c.12.098.245.195.372.288a.075.075 0 0 1-.006.125c-.598.344-1.22.635-1.873.877a.075.075 0 0 0-.041.105c.36.687.772 1.341 1.225 1.962a.077.077 0 0 0 .084.028 19.963 19.963 0 0 0 6.002-2.981.076.076 0 0 0 .032-.054c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 0 0-.031-.028zM8.02 15.278c-1.182 0-2.157-1.069-2.157-2.38 0-1.312.956-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.956 2.38-2.157 2.38zm7.975 0c-1.183 0-2.157-1.069-2.157-2.38 0-1.312.955-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.946 2.38-2.157 2.38z"/>
          </svg>
          Continue with Discord
        </a>
      </div>
      <div class="login-modal-footer">
        By signing in, you agree to share your creations with the community.
      </div>
    </div>
  </div>

  <!-- Converter Page -->
  <div id="converterPage" class="page-view active">
    <div class="container">
      <header class="page-header">
        <h1>Adversary Converter</h1>
        <p class="subtitle">Transform any creature from other popular TTRPGs into a Daggerheart stat block. Just paste and convert.</p>
        <div class="keyboard-hints" role="note" aria-label="Keyboard shortcuts">
          <span class="keyboard-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> Convert</span>
          <span class="keyboard-hint"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>C</kbd> Copy JSON</span>
          <span class="keyboard-hint"><kbd>Ctrl</kbd>+<kbd>Z</kbd> Undo</span>
          <span class="keyboard-hint"><kbd>Ctrl</kbd>+<kbd>Y</kbd> Redo</span>
          <span class="keyboard-hint"><kbd>Esc</kbd> Clear</span>
        </div>
      </header>

      <main id="main-content" class="main-grid">
      <!-- Input Panel -->
      <div class="panel" role="region" aria-label="Input panel">
        <div class="panel-header">
          <span class="panel-title">
            TTRPG Stat Block
            <span id="draftIndicator" class="draft-indicator hidden" title="Draft auto-saved">Draft saved</span>
          </span>
          <div class="btn-group">
            <div class="recent-dropdown">
              <button class="btn btn-secondary btn-small" onclick="toggleRecentMenu()"
                      aria-haspopup="true" aria-expanded="false" id="recentBtn">
                Recent
              </button>
              <div class="recent-menu" id="recentMenu" role="menu" aria-labelledby="recentBtn">
                <div id="recentList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- System Selector -->
        <div class="system-selector" style="margin-bottom: 1rem;">
          <label class="form-label" for="systemSelect">Source System</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <select id="systemSelect" class="form-select" style="flex: 1;" onchange="handleSystemChange()">
              <option value="auto">Auto-Detect</option>
              <option value="dnd5e">D&D 5th Edition</option>
              <option value="pf2e">Pathfinder 2e</option>
              <option value="dnd35e">D&D 3.5e / Pathfinder 1e</option>
              <option value="osr">OSR / B/X / Old-School</option>
            </select>
            <span id="detectedSystem" class="detected-system" style="font-size: 0.8rem; color: var(--text-secondary);"></span>
          </div>
        </div>

        <!-- Sample Buttons by System -->
        <div class="sample-buttons" style="margin-bottom: 1rem;">
          <span style="font-size: 0.8rem; color: var(--text-secondary); margin-right: 0.5rem;">Samples:</span>
          <div class="btn-group" id="sampleButtons">
            <button class="btn btn-secondary sample-btn" onclick="loadSample('dnd5e', 'ogre')">5e Ogre</button>
            <button class="btn btn-secondary sample-btn" onclick="loadSample('dnd5e', 'wight')">5e Wight</button>
            <button class="btn btn-secondary sample-btn" onclick="loadSample('pf2e', 'ironscale')">PF2e Warrior</button>
            <button class="btn btn-secondary sample-btn" onclick="loadSample('dnd35e', 'ogre')">3.5e Ogre</button>
            <button class="btn btn-secondary sample-btn" onclick="loadSample('osr', 'goblin')">OSR Goblin</button>
          </div>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle" role="tablist" aria-label="Conversion mode">
          <button class="mode-btn active" role="tab" aria-selected="true" data-mode="single" onclick="setMode('single')">
            Single
          </button>
          <button class="mode-btn" role="tab" aria-selected="false" data-mode="batch" onclick="setMode('batch')">
            Batch (separate with ---)
          </button>
        </div>

        <div class="drop-zone" id="dropZone">
          <textarea
            id="inputText"
            aria-label="TTRPG stat block input"
            placeholder="Paste a creature stat block here, or drag & drop a .txt file...

For batch mode, separate multiple stat blocks with ---

Supports most popular TTRPG stat block formats.
The converter will auto-detect the source system."
            oninput="handleLiveParse()"></textarea>
        </div>

        <div class="btn-group" style="margin-top: 1rem;">
          <button class="btn btn-primary" onclick="convert()" id="convertBtn" aria-describedby="convertHint">
            Convert to Daggerheart
          </button>
          <button class="btn btn-secondary" onclick="clearAll()" aria-label="Clear all input and output">
            Clear
          </button>
          <span id="convertHint" class="sr-only">Press Ctrl+Enter to convert</span>
        </div>

        <!-- Live Parse Preview -->
        <div id="liveParsePreview" class="live-parse hidden" role="status" aria-live="polite">
          <div class="live-parse-title">
            <span class="pulse" aria-hidden="true">â—</span> Live Detection
          </div>
          <div class="live-parse-grid" id="liveParseGrid"></div>
          <div class="confidence-legend">
            <span class="confidence-legend-item"><span class="confidence-badge confidence-high" aria-hidden="true"></span> Detected</span>
            <span class="confidence-legend-item"><span class="confidence-badge confidence-medium" aria-hidden="true"></span> Inferred</span>
            <span class="confidence-legend-item"><span class="confidence-badge confidence-low" aria-hidden="true"></span> Not found</span>
          </div>
        </div>

        <!-- Adjustments -->
        <div id="adjustments" class="adjustments-section hidden">
          <div class="adjustments-title">Adjustments (Optional)</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="overrideTier">Override Tier</label>
              <select id="overrideTier" class="form-select" onchange="reconvert()">
                <option value="">Auto-detect</option>
                <option value="1">Tier 1 (CR 0-1)</option>
                <option value="2">Tier 2 (CR 2-4)</option>
                <option value="3">Tier 3 (CR 5-10)</option>
                <option value="4">Tier 4 (CR 11+)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="overrideType">Override Type</label>
              <select id="overrideType" class="form-select" onchange="reconvert()">
                <option value="">Auto-detect</option>
                <option value="Bruiser">Bruiser (high HP, melee)</option>
                <option value="Horde">Horde (groups, weak)</option>
                <option value="Leader">Leader (commands allies)</option>
                <option value="Minion">Minion (1 HP, fodder)</option>
                <option value="Ranged">Ranged (attacks from distance)</option>
                <option value="Skulk">Skulk (stealth, ambush)</option>
                <option value="Social">Social (non-combat)</option>
                <option value="Solo">Solo (fights whole party)</option>
                <option value="Standard">Standard (balanced)</option>
                <option value="Support">Support (buffs/debuffs)</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Output Panel -->
      <div class="panel" role="region" aria-label="Output panel">
        <div class="panel-header">
          <span class="panel-title">Daggerheart Output</span>
          <div class="undo-toolbar">
            <button class="btn btn-icon btn-small" onclick="undo()" id="undoBtn" disabled
                    aria-label="Undo" title="Undo (Ctrl+Z)">â†¶</button>
            <button class="btn btn-icon btn-small" onclick="redo()" id="redoBtn" disabled
                    aria-label="Redo" title="Redo (Ctrl+Y)">â†·</button>
          </div>
          <div class="btn-group">
            <button class="btn btn-success btn-small" onclick="copyJSON()" id="copyBtn" disabled>
              Copy JSON
            </button>
            <button class="btn btn-secondary btn-small" onclick="copyMarkdown()" id="copyMdBtn" disabled>
              Copy MD
            </button>
            <button class="btn btn-secondary btn-small" onclick="copyText()" id="copyTextBtn" disabled>
              Copy Text
            </button>
            <button class="btn btn-secondary btn-small" onclick="downloadJSON()" id="downloadBtn" disabled>
              Download
            </button>
            <button class="btn btn-secondary btn-small" onclick="addToLibrary()" id="libraryBtn" disabled
                    title="Add to DM Screen library">
              + Library
            </button>
            <button class="btn btn-secondary btn-small" onclick="addConvertedToGroup()" id="groupBtn" disabled
                    title="Add to a group">
              + Group
            </button>
            <button class="btn btn-share btn-small" onclick="shareToCommunity()" id="shareBtn" disabled
                    title="Share to community library">
              Share
            </button>
            <button class="btn btn-secondary btn-small" onclick="window.print()" id="printBtn" disabled
                    title="Print stat block">
              Print
            </button>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <button class="tab active" onclick="switchTab('preview')" data-tab="preview" role="tab" aria-selected="true">
            Preview
          </button>
          <button class="tab" onclick="switchTab('json')" data-tab="json" role="tab" aria-selected="false">
            JSON
          </button>
          <button class="tab" onclick="switchTab('markdown')" data-tab="markdown" role="tab" aria-selected="false">
            Markdown
          </button>
          <button class="tab" onclick="switchTab('text')" data-tab="text" role="tab" aria-selected="false">
            Text
          </button>
        </div>

        <!-- Preview Tab -->
        <div id="previewTab" role="tabpanel">
          <div id="statBlockPreview" class="stat-block">
            <div class="empty-state">
              <div class="empty-state-icon" aria-hidden="true">âš”ï¸</div>
              <div>Paste a stat block and press <kbd>Ctrl</kbd>+<kbd>Enter</kbd></div>
              <div style="margin-top: 0.5rem; font-size: 0.85rem;">or click "Convert to Daggerheart"</div>
            </div>
          </div>
        </div>

        <!-- JSON Tab -->
        <div id="jsonTab" class="hidden" role="tabpanel">
          <div id="jsonOutput" class="json-output">// JSON output will appear here after conversion</div>
        </div>

        <!-- Markdown Tab -->
        <div id="markdownTab" class="hidden" role="tabpanel">
          <div id="markdownOutput" class="markdown-output">Markdown output will appear here after conversion</div>
        </div>

        <!-- Text Tab -->
        <div id="textTab" class="hidden" role="tabpanel">
          <div id="textOutput" class="text-output">Text output will appear here after conversion</div>
        </div>
      </div>
    </main>
    </div>
  </div>

  <!-- Community Library Page -->
  <div id="communityPage" class="page-view">
    <div class="community-page">
      <div class="community-header">
        <h1>Community Library</h1>
        <p>Browse and share Daggerheart conversions created by the community</p>
      </div>

      <div class="community-container">
        <div class="community-filters-row" id="communityFilterTabs">
          <button class="filter-btn active" onclick="setCommunityFilter('all')" data-filter="all">All Conversions</button>
          <button class="filter-btn" onclick="setCommunityFilter('mine')" data-filter="mine" id="mySubmissionsBtn" style="display: none;">My Submissions</button>
        </div>
        <div class="community-filters">
          <input type="text" class="search-input" id="communitySearch" placeholder="Search conversions..." oninput="debounceCommunitySearch()">
          <select id="communityTier" class="form-select" onchange="loadCommunityConversions()">
            <option value="">All Tiers</option>
            <option value="1">Tier 1</option>
            <option value="2">Tier 2</option>
            <option value="3">Tier 3</option>
            <option value="4">Tier 4</option>
          </select>
          <select id="communityType" class="form-select" onchange="loadCommunityConversions()">
            <option value="">All Types</option>
            <option value="Bruiser">Bruiser</option>
            <option value="Horde">Horde</option>
            <option value="Leader">Leader</option>
            <option value="Minion">Minion</option>
            <option value="Ranged">Ranged</option>
            <option value="Skulk">Skulk</option>
            <option value="Social">Social</option>
            <option value="Solo">Solo</option>
            <option value="Standard">Standard</option>
            <option value="Support">Support</option>
          </select>
          <select id="communitySort" class="form-select" onchange="loadCommunityConversions()">
            <option value="popular">Most Popular</option>
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>

        <div id="communityList" class="community-list">
          <div class="community-empty">
            <p>Click "Community Library" in the nav to browse shared conversions.</p>
          </div>
        </div>

        <div id="communityPagination" class="community-pagination hidden">
          <button class="btn btn-secondary btn-small" onclick="communityPrevPage()" id="communityPrevBtn" disabled>Previous</button>
          <span id="communityPageInfo">Page 1 of 1</span>
          <button class="btn btn-secondary btn-small" onclick="communityNextPage()" id="communityNextBtn" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Page -->
  <div id="adminPage" class="page-view admin-only">
    <div class="admin-page">
      <div class="admin-header">
        <h1>Admin Panel</h1>
        <p>Manage community conversions and users</p>
      </div>

      <!-- Stats Section -->
      <div class="admin-stats" id="adminStats">
        <div class="stat-card">
          <div class="stat-value" id="statUsers">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statConversions">-</div>
          <div class="stat-label">Conversions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statVotes">-</div>
          <div class="stat-label">Total Votes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statRecentConversions">-</div>
          <div class="stat-label">New (7 days)</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchAdminTab('conversions')">Conversions</button>
        <button class="admin-tab" onclick="switchAdminTab('users')">Users</button>
      </div>

      <!-- Conversions Tab -->
      <div id="adminConversionsTab" class="admin-tab-content">
        <div class="admin-toolbar">
          <input type="text" class="form-input admin-search" id="adminConversionSearch" placeholder="Search conversions or authors..." onkeyup="debounceAdminSearch('conversions')">
        </div>
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Author</th>
                <th>Tier</th>
                <th>Type</th>
                <th>Score</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adminConversionsBody">
              <tr><td colspan="8" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="admin-pagination" id="adminConversionsPagination"></div>
      </div>

      <!-- Users Tab -->
      <div id="adminUsersTab" class="admin-tab-content hidden">
        <div class="admin-toolbar">
          <input type="text" class="form-input admin-search" id="adminUserSearch" placeholder="Search users..." onkeyup="debounceAdminSearch('users')">
        </div>
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Provider</th>
                <th>Conversions</th>
                <th>Votes</th>
                <th>Status</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adminUsersBody">
              <tr><td colspan="7" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="admin-pagination" id="adminUsersPagination"></div>
      </div>
    </div>
  </div>

  <!-- My Library Page -->
  <div id="myLibraryPage" class="page-view">
    <div class="my-library-page">
      <div class="my-library-header">
        <h1>My Library</h1>
        <p>Drag and drop adversaries to organize them into groups</p>
      </div>

      <div class="my-library-container">
        <!-- Folders Sidebar -->
        <div class="folders-sidebar">
          <div class="folders-header">
            <span class="folders-title">Folders</span>
            <button class="folder-add-btn" onclick="createNewGroup()" title="New Folder">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
            </button>
          </div>

          <div class="folders-tree" id="foldersTree">
            <!-- All Adversaries (root) -->
            <div class="folder-item folder-root active" data-folder="all" onclick="selectFolder('all')"
                 ondragover="handleFolderDragOver(event)" ondragleave="handleFolderDragLeave(event)" ondrop="handleFolderDrop(event, 'all')">
              <span class="folder-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
                </svg>
              </span>
              <span class="folder-name">All Adversaries</span>
              <span class="folder-count" id="allCount">0</span>
            </div>

            <!-- User-created folders -->
            <div class="folders-list" id="foldersList">
              <!-- Folders populated by JavaScript -->
            </div>

            <!-- Ungrouped -->
            <div class="folder-item folder-ungrouped" data-folder="ungrouped" onclick="selectFolder('ungrouped')"
                 ondragover="handleFolderDragOver(event)" ondragleave="handleFolderDragLeave(event)" ondrop="handleFolderDrop(event, 'ungrouped')">
              <span class="folder-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <path d="M9 9h6M9 15h6"/>
                </svg>
              </span>
              <span class="folder-name">Ungrouped</span>
              <span class="folder-count" id="ungroupedCount">0</span>
            </div>
          </div>

          <div class="folders-help">
            <small>Drag adversaries to folders to organize</small>
          </div>
        </div>

        <!-- Content Area -->
        <div class="library-content">
          <div class="library-content-header">
            <div class="library-title-section">
              <h2 id="currentFolderName">All Adversaries</h2>
              <span class="library-item-count" id="folderItemCount">(0 items)</span>
            </div>
            <div class="library-actions" id="folderActions">
              <input type="text" class="library-search" id="librarySearch" placeholder="Search..." oninput="filterLibraryItems()">
              <div class="folder-edit-actions" id="folderEditActions" style="display: none;">
                <button class="icon-btn" onclick="startRenameFolder()" title="Rename folder">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button class="icon-btn icon-btn-danger" onclick="deleteCurrentGroup()" title="Delete folder">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="library-items-container" id="libraryItemsContainer"
               ondragover="handleContainerDragOver(event)" ondrop="handleContainerDrop(event)">
            <div class="library-items" id="libraryItems">
              <!-- Items populated by JavaScript -->
            </div>
            <div class="library-empty-state" id="libraryEmptyState">
              <div class="empty-icon-large">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.4">
                  <path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
                </svg>
              </div>
              <p class="empty-title">No adversaries yet</p>
              <p class="empty-hint">Convert stat blocks or add from the Community Library to get started</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add to Group Modal -->
  <div id="addToGroupModal" class="modal-overlay hidden" onclick="closeAddToGroupModal(event)">
    <div class="modal-content modal-small" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Add to Group</h2>
        <button class="modal-close" onclick="closeAddToGroupModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="add-to-group-name" id="addToGroupAdversaryName"></p>
        <div class="group-select-list" id="groupSelectList">
          <!-- Groups populated by JavaScript -->
        </div>
        <div class="create-new-group-inline">
          <input type="text" id="newGroupNameInline" placeholder="Or create new group..." class="form-input">
          <button class="btn btn-success btn-small" onclick="createGroupAndAdd()">Create & Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Adversary Detail Modal for My Library -->
  <div id="myLibraryModal" class="modal-overlay hidden" onclick="closeMyLibraryModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="myLibraryModalTitle">Adversary Details</h2>
        <button class="modal-close" onclick="closeMyLibraryModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="myLibraryModalStatBlock" class="stat-block"></div>
      </div>
      <div class="modal-footer">
        <div class="btn-group">
          <button class="btn btn-secondary btn-small" onclick="copyMyLibraryJSON()" title="Copy JSON">Copy JSON</button>
          <button class="btn btn-secondary btn-small" onclick="moveToGroup()" title="Move to different group">Move to Group</button>
          <button class="btn btn-danger btn-small" onclick="removeFromLibrary()" title="Remove from library">Remove</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Community Detail Modal -->
  <div id="communityModal" class="modal-overlay hidden" onclick="closeCommunityModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="modalTitle">Conversion Details</h2>
        <button class="modal-close" onclick="closeCommunityModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="modalStatBlock" class="stat-block"></div>
      </div>
      <div class="modal-footer">
        <div class="modal-vote-section" id="modalVoteSection">
          <button class="vote-btn upvote" id="modalUpvoteBtn" onclick="voteOnConversion(1)" title="Upvote">&#9650;</button>
          <span class="vote-score" id="modalVoteScore">0</span>
          <button class="vote-btn downvote" id="modalDownvoteBtn" onclick="voteOnConversion(-1)" title="Downvote">&#9660;</button>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary btn-small" onclick="copyShareLink()" title="Copy share link">Share Link</button>
          <button class="btn btn-secondary btn-small" onclick="copyModalJSON()" title="Copy JSON">Copy JSON</button>
          <button class="btn btn-success btn-small" onclick="addModalToLibrary()" title="Add to your library">Add to Library</button>
          <button class="btn btn-secondary btn-small" onclick="addModalToGroup()" title="Add to a group">Add to Group</button>
        </div>
      </div>
      <div class="modal-actions-secondary">
        <span class="modal-author" id="modalAuthor"></span>
        <button class="report-btn" onclick="reportConversion()" title="Report this conversion">Report</button>
      </div>
    </div>
  </div>

  <!-- Privacy Policy Modal -->
  <div id="privacyModal" class="privacy-modal" onclick="if(event.target === this) closePrivacyModal()">
    <div class="privacy-modal-content">
      <button class="close-btn" onclick="closePrivacyModal()" aria-label="Close">&times;</button>
      <h2>Privacy Policy</h2>

      <h3>What We Collect</h3>
      <p>When you sign in with Discord, we store only the following public profile information:</p>
      <ul>
        <li><strong>Discord Username</strong> - To show who created each submission</li>
        <li><strong>Discord Avatar URL</strong> - To display your profile picture</li>
        <li><strong>Discord User ID</strong> - To recognize you when you return</li>
      </ul>

      <h3>What We Don't Collect</h3>
      <p>We do not collect, store, or have access to:</p>
      <ul>
        <li>Your email address</li>
        <li>Your password</li>
        <li>Your Discord messages or servers</li>
        <li>Any private Discord information</li>
      </ul>

      <h3>How Your Data Is Used</h3>
      <p>Your information is used solely to:</p>
      <ul>
        <li>Attribute your community submissions to you</li>
        <li>Allow you to edit or delete your own submissions</li>
        <li>Track your votes (one vote per conversion)</li>
      </ul>

      <h3>Data Security</h3>
      <p>Your data is stored in a secure database hosted on Fly.io infrastructure. We use industry-standard JWT tokens for authentication, stored in secure HTTP-only cookies.</p>

      <h3>Data Deletion</h3>
      <p>You can delete your submissions at any time. If you wish to have your account completely removed, contact us and we will delete all your data.</p>

      <h3>Third Parties</h3>
      <p>We do not sell, share, or transfer your data to any third parties. Your information stays between you and this application.</p>

      <p style="margin-top: 2rem; font-size: 0.8rem; opacity: 0.7;">Last updated: January 2026</p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <p>This tool is not affiliated with, endorsed, or sponsored by Wizards of the Coast, Paizo Inc., or Darrington Press. All product names and trademarks are property of their respective owners.</p>
    <div class="footer-links">
      <a href="#" onclick="openPrivacyModal(); return false;">Privacy Policy</a>
      <span class="footer-divider">|</span>
      <a href="https://buymeacoffee.com/marcusu" target="_blank" rel="noopener" class="coffee-footer-link">
        Help keep the lights on
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
          <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
          <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
          <line x1="6" y1="2" x2="6" y2="4"/>
          <line x1="10" y1="2" x2="10" y2="4"/>
          <line x1="14" y1="2" x2="14" y2="4"/>
        </svg>
      </a>
    </div>
    <div class="zs-credits" itemscope="" itemtype="https://schema.org/Organization">
      <a href="https://zealoussites.com" target="_blank" rel="noopener noreferrer nofollow" title="Website by Marcus Zeal @ Zealous Sites" aria-label="Website by Zealous Sites" itemprop="url">
        <span itemprop="name">
          Website by
          <svg height="20" viewBox="0 0 210 124" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M46.072 100V86.08L83.512 42.496L86.296 50.368H47.032V32.8H106.264V46.72L68.824 90.304L66.04 82.432H107.8V100H46.072ZM139.434 101.536C133.802 101.536 128.362 100.896 123.114 99.616C117.866 98.336 113.546 96.672 110.154 94.624L117.45 78.112C120.65 79.968 124.202 81.472 128.106 82.624C132.074 83.712 135.914 84.256 139.626 84.256C141.802 84.256 143.498 84.128 144.714 83.872C145.994 83.552 146.922 83.136 147.498 82.624C148.074 82.048 148.362 81.376 148.362 80.608C148.362 79.392 147.69 78.432 146.346 77.728C145.002 77.024 143.21 76.448 140.97 76C138.794 75.488 136.394 74.976 133.77 74.464C131.146 73.888 128.49 73.152 125.802 72.256C123.178 71.36 120.746 70.176 118.506 68.704C116.33 67.232 114.57 65.312 113.226 62.944C111.882 60.512 111.21 57.504 111.21 53.92C111.21 49.76 112.362 45.984 114.666 42.592C117.034 39.136 120.522 36.384 125.13 34.336C129.802 32.288 135.594 31.264 142.506 31.264C147.05 31.264 151.53 31.744 155.946 32.704C160.362 33.664 164.33 35.136 167.85 37.12L161.034 53.536C157.706 51.872 154.474 50.624 151.338 49.792C148.266 48.96 145.258 48.544 142.314 48.544C140.138 48.544 138.41 48.736 137.13 49.12C135.85 49.504 134.922 50.016 134.346 50.656C133.834 51.296 133.578 52 133.578 52.768C133.578 53.92 134.25 54.848 135.594 55.552C136.938 56.192 138.698 56.736 140.874 57.184C143.114 57.632 145.546 58.112 148.17 58.624C150.858 59.136 153.514 59.84 156.138 60.736C158.762 61.632 161.162 62.816 163.338 64.288C165.578 65.76 167.37 67.68 168.714 70.048C170.058 72.416 170.73 75.36 170.73 78.88C170.73 82.976 169.546 86.752 167.178 90.208C164.874 93.6 161.418 96.352 156.81 98.464C152.202 100.512 146.41 101.536 139.434 101.536Z" fill="currentColor"></path>
            <path d="M30.528 111.624C24.576 111.624 20.064 110.12 16.992 107.112C13.92 104.168 12.384 99.944 12.384 94.44V77.064C12.384 75.528 12 74.408 11.232 73.704C10.464 72.936 9.44 72.552 8.16 72.552H4.992V60.84H8.16C9.44 60.84 10.464 60.456 11.232 59.688C12 58.92 12.384 57.8 12.384 56.328V38.952C12.384 33.384 13.92 29.128 16.992 26.184C20.064 23.24 24.576 21.768 30.528 21.768H36.096V33.48H34.368C32.064 33.48 30.304 34.088 29.088 35.304C27.936 36.52 27.36 38.28 27.36 40.584V55.944C27.36 58.76 26.976 60.968 26.208 62.568C25.44 64.168 24.224 65.32 22.56 66.024C20.96 66.728 18.88 67.24 16.32 67.56V65.832C18.88 66.088 20.96 66.6 22.56 67.368C24.224 68.072 25.44 69.224 26.208 70.824C26.976 72.424 27.36 74.632 27.36 77.448V92.808C27.36 95.112 27.936 96.872 29.088 98.088C30.304 99.304 32.064 99.912 34.368 99.912H36.096V111.624H30.528Z" fill="currentColor"></path>
            <path d="M179.008 111.624H173.44V99.912H175.168C177.472 99.912 179.2 99.304 180.352 98.088C181.568 96.872 182.176 95.112 182.176 92.808V77.448C182.176 74.632 182.56 72.424 183.328 70.824C184.16 69.224 185.376 68.072 186.976 67.368C188.576 66.6 190.656 66.088 193.216 65.832V67.56C190.656 67.24 188.576 66.728 186.976 66.024C185.376 65.32 184.16 64.168 183.328 62.568C182.56 60.968 182.176 58.76 182.176 55.944V40.584C182.176 38.28 181.568 36.52 180.352 35.304C179.2 34.088 177.472 33.48 175.168 33.48H173.44V21.768H179.008C185.024 21.768 189.536 23.24 192.544 26.184C195.616 29.128 197.152 33.384 197.152 38.952V56.328C197.152 57.8 197.536 58.92 198.304 59.688C199.072 60.456 200.096 60.84 201.376 60.84H204.544V72.552H201.376C200.096 72.552 199.072 72.936 198.304 73.704C197.536 74.408 197.152 75.528 197.152 77.064V94.44C197.152 99.944 195.616 104.168 192.544 107.112C189.536 110.12 185.024 111.624 179.008 111.624Z" fill="currentColor"></path>
          </svg>
        </span>
      </a>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast" role="alert" aria-live="assertive">
    <span class="toast-message" id="toastMessage"></span>
    <button class="toast-close" onclick="dismissToast()" aria-label="Dismiss notification">Ã—</button>
    <div class="toast-progress" id="toastProgress"></div>
  </div>

  <!-- Load the modules -->
  <script src="/parsers/parser-manager.js"></script>
  <script src="/parsers/dnd5e-parser.js"></script>
  <script src="/parsers/pf2e-parser.js"></script>
  <script src="/parsers/dnd35e-parser.js"></script>
  <script src="/parsers/osr-parser.js"></script>
  <script src="/dnd-parser.js"></script>
  <script src="/daggerheart-converter.js"></script>

  <script>
    // ==================== STATE ====================
    let currentParsed = null;
    let currentConverted = null;
    let parseDebounceTimer = null;
    let saveDebounceTimer = null;
    let currentMode = 'single';
    let currentSystem = 'auto';
    let detectedSystem = null;
    let batchResults = [];

    // Undo/Redo history
    let history = [];
    let historyIndex = -1;
    const MAX_HISTORY = 50;

    // Recent conversions
    const MAX_RECENT = 10;
    const STORAGE_KEYS = {
      recent: 'dnd-dh-recent',
      draft: 'dnd-dh-draft'
    };

    // ==================== SAMPLES BY SYSTEM ====================
    // These samples use SRD content (CC-BY-4.0 for 5e, OGL for 3.5e) or original creations
    const SAMPLES = {
      dnd5e: {
        // From 5e SRD (CC-BY-4.0)
        ogre: `Ogre
Large giant, chaotic evil
Armor Class 11 (hide armor)
Hit Points 59 (7d10 + 21)
Speed 40 ft.
STR 19 (+4) DEX 8 (-1) CON 16 (+3) INT 5 (-3) WIS 7 (-2) CHA 7 (-2)
Senses darkvision 60 ft., passive Perception 8
Languages Common, Giant
Challenge 2 (450 XP)

Actions
Greatclub. Melee Weapon Attack: +6 to hit, reach 5 ft., one target. Hit: 13 (2d8 + 4) bludgeoning damage.

Javelin. Melee or Ranged Weapon Attack: +6 to hit, reach 5 ft. or range 30/120 ft., one target. Hit: 11 (2d6 + 4) piercing damage.`,

        // From 5e SRD (CC-BY-4.0)
        wight: `Wight
Medium undead, neutral evil
Armor Class 14 (studded leather)
Hit Points 45 (6d8 + 18)
Speed 30 ft.
STR 15 (+2) DEX 14 (+2) CON 16 (+3) INT 10 (+0) WIS 13 (+1) CHA 15 (+2)
Skills Perception +3, Stealth +4
Damage Resistances necrotic; bludgeoning, piercing, and slashing from nonmagical attacks
Damage Immunities poison
Condition Immunities exhaustion, poisoned
Senses darkvision 60 ft., passive Perception 13
Languages the languages it knew in life
Challenge 3 (700 XP)

Sunlight Sensitivity. While in sunlight, the wight has disadvantage on attack rolls, as well as on Wisdom (Perception) checks that rely on sight.

Actions
Multiattack. The wight makes two longsword attacks or two longbow attacks. It can use its Life Drain in place of one longsword attack.

Life Drain. Melee Weapon Attack: +4 to hit, reach 5 ft., one creature. Hit: 5 (1d6 + 2) necrotic damage. The target must succeed on a DC 13 Constitution saving throw or its hit point maximum is reduced by an amount equal to the damage taken.

Longsword. Melee Weapon Attack: +4 to hit, reach 5 ft., one target. Hit: 6 (1d8 + 2) slashing damage.`
      },

      pf2e: {
        // Original creation in PF2e format
        ironscale: `Ironscale Warrior
Creature 3
[N] [Medium] [Humanoid] [Lizardfolk]
Perception +9; low-light vision
Languages Common, Draconic
Skills Athletics +10, Intimidation +7, Stealth +8, Survival +9
Str +4, Dex +2, Con +3, Int +0, Wis +2, Cha +1
Items hide armor, steel shield, trident
AC 19 (21 with shield raised); Fort +10, Ref +7, Will +7
HP 45
Shield Block [reaction]
Speed 25 feet, swim 20 feet

Melee [one-action] trident +11 (reach 10 feet), Damage 1d8+6 piercing
Melee [one-action] jaws +11, Damage 1d6+6 piercing
Melee [one-action] tail +11 (agile), Damage 1d4+6 bludgeoning
Ranged [one-action] trident +9 (thrown 20 feet), Damage 1d8+4 piercing

Deep Breath The ironscale warrior can hold their breath for 10 minutes.

Tail Sweep [two-actions] The warrior makes a tail Strike against each enemy within reach. Each attack counts toward their multiple attack penalty, but the penalty doesn't increase until after all attacks.`
      },

      dnd35e: {
        // From 3.5e SRD (OGL)
        ogre: `Ogre
CR 3
CE Large Giant
Init -1; Senses darkvision 60 ft., low-light vision; Listen +2, Spot +2

AC 16, touch 8, flat-footed 16 (-1 size, -1 Dex, +5 natural, +3 hide armor)
hp 29 (4d8+11)
Fort +6, Ref +0, Will +1

Speed 30 ft. (40 ft. base)
Melee greatclub +8 (2d8+7) or
Melee javelin +7 (1d8+5)
Ranged javelin +1 (1d8+5)
Space 10 ft.; Reach 10 ft.

Abilities Str 21, Dex 8, Con 15, Int 6, Wis 10, Cha 7
Base Atk +3; Grp +12
Feats Toughness, Weapon Focus (greatclub)
Skills Climb +5, Listen +2, Spot +2

Ogres are brutish creatures standing 9 to 10 feet tall and weighing 600 to 650 pounds. They favor overwhelming odds and ambush tactics.`
      },

      osr: {
        // Generic OSR stat block (common across many retroclones)
        skeleton: `Skeleton
AC: 7 [12]
HD: 1
Move: 60' (20')
Attacks: 1 (weapon)
Damage: 1d6 or by weapon
No. Appearing: 3d4 (3d10)
Save As: Fighter 1
Morale: 12
Treasure Type: None
Alignment: Chaotic

Animated bones of the dead, driven by dark magic. Immune to sleep, charm, and hold spells. Edged weapons deal half damage. Can be turned by clerics.`,

        // Generic OSR stat block
        goblin: `Goblin
AC: 6 [13]
HD: 1-1
Move: 60' (20')
Attacks: 1 (weapon)
Damage: 1d6 or by weapon
No. Appearing: 2d4 (6d10)
Save As: Normal Human
Morale: 7 (9 with leader)
Treasure Type: R (C)
Alignment: Chaotic

Small, cruel humanoids with sharp teeth and pointed ears. Fight with -1 penalty in bright sunlight. Often led by a chieftain (HD 2, 11 hp). Favor ambushes and overwhelming numbers.`
      }
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
      setupDragAndDrop();
      setupKeyboardShortcuts();
      loadDraft();
      renderRecentList();
      loadThemePreference();
      setupToastInteraction();
      checkAuthState();
      handleAuthRedirect();
      handleUrlRouting();
    });

    // ==================== THEME TOGGLE ====================
    function toggleTheme() {
      const isLight = document.documentElement.classList.toggle('light-mode');
      localStorage.setItem('dnd-dh-theme', isLight ? 'light' : 'dark');
      showToast(isLight ? 'Light mode enabled' : 'Dark mode enabled', 'info');
    }

    function loadThemePreference() {
      const savedTheme = localStorage.getItem('dnd-dh-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
        document.documentElement.classList.add('light-mode');
      }

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('dnd-dh-theme')) {
          document.documentElement.classList.toggle('light-mode', !e.matches);
        }
      });
    }

    // ==================== DRAG AND DROP ====================
    function setupDragAndDrop() {
      const dropZone = document.getElementById('dropZone');
      const textarea = document.getElementById('inputText');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
      });

      dropZone.addEventListener('drop', handleDrop);

      function handleDrop(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            const reader = new FileReader();
            reader.onload = (event) => {
              textarea.value = event.target.result;
              handleLiveParse();
              saveDraft();
              showToast('File loaded: ' + file.name, 'info');
            };
            reader.readAsText(file);
          } else {
            showToast('Please drop a .txt file', 'error');
          }
        }
      }
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ctrl+Enter: Convert
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          convert();
        }
        // Ctrl+Shift+C: Copy JSON
        if (e.ctrlKey && e.shiftKey && e.key === 'C') {
          e.preventDefault();
          copyJSON();
        }
        // Ctrl+Z: Undo
        if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
          if (document.activeElement.tagName !== 'TEXTAREA' &&
              document.activeElement.tagName !== 'INPUT') {
            e.preventDefault();
            undo();
          }
        }
        // Ctrl+Y or Ctrl+Shift+Z: Redo
        if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
          e.preventDefault();
          redo();
        }
        // Escape: Clear
        if (e.key === 'Escape') {
          e.preventDefault();
          clearAll();
        }
      });
    }

    // ==================== MODE TOGGLE ====================
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
        btn.setAttribute('aria-selected', btn.dataset.mode === mode);
      });
    }

    // ==================== DRAFT AUTO-SAVE ====================
    function saveDraft() {
      clearTimeout(saveDebounceTimer);
      saveDebounceTimer = setTimeout(() => {
        const input = document.getElementById('inputText').value;
        if (input.trim()) {
          localStorage.setItem(STORAGE_KEYS.draft, JSON.stringify({
            input: input,
            timestamp: Date.now()
          }));
          document.getElementById('draftIndicator').classList.remove('hidden');
          setTimeout(() => {
            document.getElementById('draftIndicator').classList.add('hidden');
          }, 2000);
        }
      }, 1000);
    }

    function loadDraft() {
      try {
        const draft = JSON.parse(localStorage.getItem(STORAGE_KEYS.draft));
        if (draft && draft.input) {
          const age = Date.now() - draft.timestamp;
          // Only load drafts less than 24 hours old
          if (age < 24 * 60 * 60 * 1000) {
            document.getElementById('inputText').value = draft.input;
            handleLiveParse();
            showToast('Draft restored', 'info');
          }
        }
      } catch (e) {
        // Ignore errors
      }
    }

    function clearDraft() {
      localStorage.removeItem(STORAGE_KEYS.draft);
    }

    // ==================== RECENT CONVERSIONS ====================
    function getRecent() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEYS.recent)) || [];
      } catch (e) {
        return [];
      }
    }

    function saveToRecent(converted) {
      const recent = getRecent();
      // Remove duplicates
      const filtered = recent.filter(r => r.id !== converted.id);
      // Add to front
      filtered.unshift({
        id: converted.id,
        name: converted.name,
        tier: converted.tier,
        advType: converted.advType,
        data: converted,
        timestamp: Date.now()
      });
      // Limit size
      const limited = filtered.slice(0, MAX_RECENT);
      localStorage.setItem(STORAGE_KEYS.recent, JSON.stringify(limited));
      renderRecentList();
    }

    function renderRecentList() {
      const recent = getRecent();
      const list = document.getElementById('recentList');

      if (recent.length === 0) {
        list.innerHTML = '<div class="recent-item" style="color: var(--text-secondary);">No recent conversions</div>';
        return;
      }

      list.innerHTML = recent.map((r, i) => `
        <div class="recent-item" role="menuitem" onclick="loadRecent(${i})">
          <div>
            <span class="recent-item-name">${escapeHtml(r.name)}</span>
            <span class="recent-item-tier">T${r.tier} ${r.advType}</span>
          </div>
          <span class="recent-item-delete" onclick="event.stopPropagation(); deleteRecent(${i})"
                title="Remove" aria-label="Remove from recent">Ã—</span>
        </div>
      `).join('');
    }

    function loadRecent(index) {
      const recent = getRecent();
      if (recent[index]) {
        currentConverted = recent[index].data;
        currentParsed = null; // We don't have the parsed data
        pushHistory();
        renderPreview();
        renderJSON();
        renderMarkdown();
        renderText();
        enableButtons();
        toggleRecentMenu();
        showToast('Loaded: ' + recent[index].name, 'info');
      }
    }

    function deleteRecent(index) {
      const recent = getRecent();
      recent.splice(index, 1);
      localStorage.setItem(STORAGE_KEYS.recent, JSON.stringify(recent));
      renderRecentList();
    }

    function toggleRecentMenu() {
      const menu = document.getElementById('recentMenu');
      const btn = document.getElementById('recentBtn');
      const isOpen = menu.classList.toggle('show');
      btn.setAttribute('aria-expanded', isOpen);
    }

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.recent-dropdown')) {
        document.getElementById('recentMenu').classList.remove('show');
        document.getElementById('recentBtn').setAttribute('aria-expanded', 'false');
      }
    });

    // ==================== UNDO/REDO ====================
    function pushHistory() {
      if (!currentConverted) return;

      // Remove any redo history
      history = history.slice(0, historyIndex + 1);

      // Add current state
      history.push(JSON.stringify(currentConverted));

      // Limit history size
      if (history.length > MAX_HISTORY) {
        history.shift();
      }

      historyIndex = history.length - 1;
      updateUndoRedoButtons();
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        currentConverted = JSON.parse(history[historyIndex]);
        renderAll();
        updateUndoRedoButtons();
        showToast('Undo', 'info');
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        currentConverted = JSON.parse(history[historyIndex]);
        renderAll();
        updateUndoRedoButtons();
        showToast('Redo', 'info');
      }
    }

    function updateUndoRedoButtons() {
      document.getElementById('undoBtn').disabled = historyIndex <= 0;
      document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
    }

    // ==================== LIVE PARSING ====================
    function handleLiveParse() {
      saveDraft();

      clearTimeout(parseDebounceTimer);
      parseDebounceTimer = setTimeout(() => {
        const input = document.getElementById('inputText').value.trim();

        if (input.length < 20) {
          document.getElementById('liveParsePreview').classList.add('hidden');
          updateDetectedSystemDisplay(null);
          return;
        }

        try {
          // For batch mode, only parse the first block for preview
          const firstBlock = currentMode === 'batch'
            ? input.split(/\n-{3,}\n/)[0]
            : input;

          // Detect system if in auto mode
          if (typeof ParserManager !== 'undefined' && currentSystem === 'auto') {
            const detected = ParserManager.detectSystem(firstBlock);
            detectedSystem = detected.system;
            updateDetectedSystemDisplay(detected);
          }

          // Parse using appropriate parser
          let parsed;
          if (typeof ParserManager !== 'undefined') {
            parsed = ParserManager.parse(firstBlock, { system: currentSystem });
          } else {
            parsed = DnDParser.parse(firstBlock);
          }

          renderLivePreview(parsed);
          document.getElementById('liveParsePreview').classList.remove('hidden');
        } catch (e) {
          console.error('Parse error:', e);
          document.getElementById('liveParsePreview').classList.add('hidden');
        }
      }, 300);
    }

    function renderLivePreview(parsed) {
      // Add system info if available
      const systemInfo = parsed._meta?.systemInfo;
      const systemLabel = systemInfo ? systemInfo.shortName : 'Unknown';

      const fields = [
        { label: 'System', value: systemLabel, confidence: parsed._meta?.detected?.confidence > 0.5 ? 'high' : 'medium' },
        { label: 'Name', value: parsed.name, confidence: parsed.name !== 'Unknown Creature' ? 'high' : 'low' },
        { label: 'CR/Lvl', value: parsed.level ? `Lvl ${parsed.level}` : parsed.cr.string, confidence: parsed.cr.numeric > 0 || parsed.level ? 'high' : 'medium' },
        { label: 'HP', value: parsed.hp.value, confidence: parsed.hp.value > 0 ? 'high' : 'low' },
        { label: 'AC', value: parsed.ac.value, confidence: parsed.ac.value > 0 ? 'high' : 'low' },
        { label: 'Type', value: parsed.typeInfo.type, confidence: parsed.typeInfo.type !== 'creature' ? 'high' : 'medium' },
        { label: 'Size', value: parsed.typeInfo.size, confidence: 'high' },
        { label: 'Actions', value: parsed.actions.length, confidence: parsed.actions.length > 0 ? 'high' : 'low' },
      ];

      document.getElementById('liveParseGrid').innerHTML = fields.map(f => `
        <div class="parse-field">
          <span class="confidence-badge confidence-${f.confidence}" aria-label="${f.confidence} confidence"></span>
          <span class="parse-field-label">${f.label}:</span>
          <span class="parse-field-value">${f.value}</span>
        </div>
      `).join('');
    }

    // ==================== SYSTEM HANDLING ====================
    function handleSystemChange() {
      currentSystem = document.getElementById('systemSelect').value;
      handleLiveParse();
    }

    function getActiveParser() {
      const system = currentSystem === 'auto' ? (detectedSystem || 'dnd5e') : currentSystem;

      // Use ParserManager if available, otherwise fall back to DnDParser
      if (typeof ParserManager !== 'undefined') {
        return { parser: ParserManager, system: system };
      }
      return { parser: DnDParser, system: 'dnd5e' };
    }

    function updateDetectedSystemDisplay(detected) {
      const display = document.getElementById('detectedSystem');
      if (detected && currentSystem === 'auto') {
        const confidence = Math.round(detected.confidence * 100);
        const name = detected.info?.shortName || detected.system;
        display.textContent = `Detected: ${name} (${confidence}%)`;
        display.style.color = confidence > 60 ? 'var(--success)' : 'var(--warning)';
      } else {
        display.textContent = '';
      }
    }

    // ==================== LOAD SAMPLE ====================
    function loadSample(system, name) {
      if (SAMPLES[system] && SAMPLES[system][name]) {
        document.getElementById('inputText').value = SAMPLES[system][name];
        // Set the system selector to match the sample
        document.getElementById('systemSelect').value = system;
        currentSystem = system;
        handleLiveParse();
        convert();
      } else {
        showToast('Sample not found', 'error');
      }
    }

    // ==================== CONVERT ====================
    function convert() {
      const input = document.getElementById('inputText').value.trim();
      if (!input) {
        showToast('Please paste a stat block to convert', 'error');
        return;
      }

      try {
        if (currentMode === 'batch') {
          convertBatch(input);
        } else {
          convertSingle(input);
        }

        clearDraft();
        showToast('Converted successfully!', 'success');
      } catch (e) {
        console.error(e);
        showToast('Error parsing stat block: ' + e.message, 'error');
      }
    }

    function convertSingle(input) {
      // Use ParserManager if available, otherwise fall back to DnDParser
      if (typeof ParserManager !== 'undefined') {
        currentParsed = ParserManager.parse(input, { system: currentSystem });
        // Update detected system display
        if (currentParsed._meta && currentParsed._meta.detected) {
          updateDetectedSystemDisplay(currentParsed._meta.detected);
        }
      } else {
        currentParsed = DnDParser.parse(input);
      }
      document.getElementById('adjustments').classList.remove('hidden');
      reconvert();
    }

    function convertBatch(input) {
      const blocks = input.split(/\n-{3,}\n/).filter(b => b.trim());
      batchResults = [];

      const overrideTier = document.getElementById('overrideTier').value;
      const overrideType = document.getElementById('overrideType').value;
      const options = {};
      if (overrideTier) options.tier = parseInt(overrideTier);
      if (overrideType) options.type = overrideType;

      for (const block of blocks) {
        try {
          // Use ParserManager if available
          let parsed;
          if (typeof ParserManager !== 'undefined') {
            parsed = ParserManager.parse(block.trim(), { system: currentSystem });
          } else {
            parsed = DnDParser.parse(block.trim());
          }
          const converted = DaggerheartConverter.convert(parsed, options);
          batchResults.push({ success: true, data: converted });
          saveToRecent(converted);
        } catch (e) {
          batchResults.push({ success: false, error: e.message, input: block.substring(0, 50) });
        }
      }

      renderBatchResults();
      enableButtons();
    }

    function renderBatchResults() {
      const container = document.getElementById('statBlockPreview');

      const html = batchResults.map((result, i) => {
        if (result.success) {
          return `
            <div class="batch-item" data-index="${i}">
              <div class="batch-item-header" onclick="toggleBatchItem(${i})">
                <span><strong>${escapeHtml(result.data.name)}</strong> - Tier ${result.data.tier} ${result.data.advType}</span>
                <span class="collapsible-icon">â–¼</span>
              </div>
              <div class="batch-item-content">
                ${renderStatBlockHTML(result.data)}
              </div>
            </div>
          `;
        } else {
          return `
            <div class="batch-item" style="border-color: var(--error);">
              <div class="batch-item-header">
                <span style="color: var(--error);">Failed: ${escapeHtml(result.input)}...</span>
              </div>
              <div class="batch-item-content">
                <p style="color: var(--error);">${escapeHtml(result.error)}</p>
              </div>
            </div>
          `;
        }
      }).join('');

      container.innerHTML = `<div class="batch-results">${html}</div>`;

      // Set first successful result as current
      const firstSuccess = batchResults.find(r => r.success);
      if (firstSuccess) {
        currentConverted = firstSuccess.data;
        pushHistory();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    function toggleBatchItem(index) {
      const item = document.querySelector(`.batch-item[data-index="${index}"]`);
      item.classList.toggle('collapsed');
    }

    function reconvert() {
      if (!currentParsed) return;

      const overrideTier = document.getElementById('overrideTier').value;
      const overrideType = document.getElementById('overrideType').value;

      const options = {};
      if (overrideTier) options.tier = parseInt(overrideTier);
      if (overrideType) options.type = overrideType;

      currentConverted = DaggerheartConverter.convert(currentParsed, options);

      pushHistory();
      saveToRecent(currentConverted);
      renderAll();
      enableButtons();
    }

    function renderAll() {
      renderPreview();
      renderJSON();
      renderMarkdown();
      renderText();
    }

    function enableButtons() {
      document.getElementById('copyBtn').disabled = false;
      document.getElementById('copyMdBtn').disabled = false;
      document.getElementById('copyTextBtn').disabled = false;
      document.getElementById('downloadBtn').disabled = false;
      document.getElementById('libraryBtn').disabled = false;
      document.getElementById('groupBtn').disabled = false;
      document.getElementById('shareBtn').disabled = false;
      document.getElementById('printBtn').disabled = false;
    }

    // ==================== RENDER PREVIEW ====================
    function renderPreview() {
      if (!currentConverted) return;
      document.getElementById('statBlockPreview').innerHTML = renderStatBlockHTML(currentConverted);
      // Auto-resize all textareas
      document.querySelectorAll('.feature-desc-input').forEach(autoResizeTextarea);
    }

    function renderStatBlockHTML(c) {
      const featuresHTML = c.features.map((f, i) => `
        <div class="feature" data-index="${i}">
          <div class="feature-header">
            <input type="text" class="feature-name-input" value="${escapeHtml(f.name)}"
                   onchange="updateFeature(${i}, 'name', this.value)"
                   aria-label="Feature name">
            <button class="feature-type feature-type-${f.type.toLowerCase()}"
                  onclick="cycleFeatureType(${i})" title="Click to change type"
                  aria-label="Feature type: ${f.type}. Click to cycle.">${f.type}</button>
            <span class="feature-actions">
              <button class="feature-btn" onclick="removeFeature(${i})" title="Remove feature"
                      aria-label="Remove feature">âœ•</button>
            </span>
          </div>
          <textarea class="feature-desc-input"
                    onchange="updateFeature(${i}, 'desc', this.value)"
                    oninput="autoResizeTextarea(this)"
                    aria-label="Feature description">${escapeHtml(f.desc)}</textarea>
        </div>
      `).join('');

      const tagsHTML = c.tags.map((t, i) => `
        <span class="tag" onclick="removeTag(${i})">
          ${escapeHtml(t)}<span class="tag-remove" aria-label="Remove tag">Ã—</span>
        </span>
      `).join('');

      const imageHTML = c.imageUrl
        ? `<img src="${escapeHtml(c.imageUrl)}" alt="${escapeHtml(c.name)}"
               class="stat-block-image-preview" onclick="document.getElementById('imageUrlInput').focus()"
               onerror="this.style.display='none'; document.querySelector('.image-placeholder').style.display='flex';">`
        : `<div class="image-placeholder" onclick="document.getElementById('imageUrlInput').focus()">
             Click to add image URL
           </div>`;

      return `
        <div class="stat-block-header">
          <div class="stat-block-name">${escapeHtml(c.name)}</div>
          <div class="stat-block-type">Tier ${c.tier} ${c.advType}</div>
        </div>

        <div class="stat-block-image-section">
          ${imageHTML}
          <input type="url" id="imageUrlInput" class="image-url-input"
                 placeholder="Paste image URL here (optional)"
                 value="${c.imageUrl ? escapeHtml(c.imageUrl) : ''}"
                 onchange="updateImageUrl(this.value)"
                 aria-label="Image URL">
        </div>

        <div class="stat-block-desc">${escapeHtml(c.description)}</div>

        <div class="stat-line">
          <span class="stat-label">Motives:</span>
          <input type="text" class="stat-value-editable" value="${escapeHtml(c.motives)}"
                 onchange="updateStat('motives', this.value)" aria-label="Motives">
        </div>
        <div class="stat-line">
          <span class="stat-label">Tactics:</span>
          <input type="text" class="stat-value-editable" value="${escapeHtml(c.tactics)}"
                 onchange="updateStat('tactics', this.value)" aria-label="Tactics">
        </div>

        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-item-label">Difficulty</div>
            <input type="number" class="stat-item-input" value="${c.difficulty}"
                   onchange="updateStat('difficulty', parseInt(this.value))" aria-label="Difficulty">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Major</div>
            <input type="number" class="stat-item-input" value="${c.majorThresh}"
                   onchange="updateStat('majorThresh', parseInt(this.value))" aria-label="Major threshold">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Severe</div>
            <input type="number" class="stat-item-input" value="${c.severeThresh}"
                   onchange="updateStat('severeThresh', parseInt(this.value))" aria-label="Severe threshold">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">HP</div>
            <input type="number" class="stat-item-input" value="${c.hp}"
                   onchange="updateStat('hp', parseInt(this.value))" aria-label="Hit points">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Stress</div>
            <input type="number" class="stat-item-input" value="${c.stress}"
                   onchange="updateStat('stress', parseInt(this.value))" aria-label="Stress">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Attack</div>
            <input type="text" class="stat-item-input" value="${c.atkMod}"
                   onchange="updateStat('atkMod', this.value)" aria-label="Attack modifier">
          </div>
        </div>

        <div class="stat-line">
          <span class="stat-label">Weapon:</span>
          <input type="text" class="stat-value-editable" value="${escapeHtml(c.weapon)}"
                 onchange="updateStat('weapon', this.value)" style="width: 120px;" aria-label="Weapon">
          <span>(</span>
          <input type="text" class="stat-value-editable" value="${c.range}"
                 onchange="updateStat('range', this.value)" style="width: 80px;" aria-label="Range">
          <span>)</span>
        </div>
        <div class="stat-line">
          <span class="stat-label">Damage:</span>
          <input type="text" class="stat-value-editable" value="${c.damage}"
                 onchange="updateStat('damage', this.value)" style="width: 80px;" aria-label="Damage dice">
          <input type="text" class="stat-value-editable" value="${c.dmgType}"
                 onchange="updateStat('dmgType', this.value)" style="width: 40px;" aria-label="Damage type">
        </div>
        <div class="stat-line">
          <span class="stat-label">Experience:</span>
          <input type="text" class="stat-value-editable" value="${escapeHtml(c.experience)}"
                 onchange="updateStat('experience', this.value)" aria-label="Experience">
        </div>

        <!-- Features Section -->
        <div class="collapsible" id="featuresCollapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('featuresCollapsible')"
               role="button" aria-expanded="true" tabindex="0"
               onkeypress="if(event.key==='Enter')toggleCollapsible('featuresCollapsible')">
            <span class="collapsible-title">
              Features (${c.features.length})
              <span style="font-weight: normal; font-size: 0.75rem; color: var(--text-secondary);">click to edit</span>
            </span>
            <span class="collapsible-icon" aria-hidden="true">â–¼</span>
          </div>
          <div class="collapsible-content features-section">
            ${featuresHTML}
            <button class="add-feature-btn" onclick="addFeature()" aria-label="Add new feature">
              + Add Feature
            </button>
          </div>
        </div>

        <!-- Tags Section -->
        <div class="collapsible" id="tagsCollapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('tagsCollapsible')"
               role="button" aria-expanded="true" tabindex="0"
               onkeypress="if(event.key==='Enter')toggleCollapsible('tagsCollapsible')">
            <span class="collapsible-title">Tags (${c.tags.length})</span>
            <span class="collapsible-icon" aria-hidden="true">â–¼</span>
          </div>
          <div class="collapsible-content tags-section">
            <div class="tags">
              ${tagsHTML}
              <input type="text" class="add-tag-input" placeholder="+ tag"
                     onkeypress="if(event.key==='Enter'){addTag(this.value);this.value='';}"
                     aria-label="Add new tag">
            </div>
          </div>
        </div>
      `;
    }

    function toggleCollapsible(id) {
      const el = document.getElementById(id);
      el.classList.toggle('collapsed');
      const header = el.querySelector('.collapsible-header');
      header.setAttribute('aria-expanded', !el.classList.contains('collapsed'));
    }

    // Read-only version for community viewing
    function renderStatBlockReadOnly(c) {
      if (!c) return '<p>No data available</p>';

      const featuresHTML = (c.features || []).map(f => `
        <div class="feature-readonly">
          <div class="feature-header-readonly">
            <span class="feature-name-readonly">${escapeHtml(f.name)}</span>
            <span class="feature-type feature-type-${(f.type || 'passive').toLowerCase()}">${f.type || 'Passive'}</span>
          </div>
          <div class="feature-desc-readonly">${escapeHtml(f.desc || '')}</div>
        </div>
      `).join('');

      const tagsHTML = (c.tags || []).map(t => `
        <span class="tag-readonly">${escapeHtml(t)}</span>
      `).join('');

      const imageHTML = c.imageUrl
        ? `<img src="${escapeHtml(c.imageUrl)}" alt="${escapeHtml(c.name)}" class="stat-block-image-readonly">`
        : '';

      return `
        <div class="stat-block-header">
          <div class="stat-block-name">${escapeHtml(c.name || 'Unknown')}</div>
          <div class="stat-block-type">Tier ${c.tier || '?'} ${c.advType || 'Standard'}</div>
        </div>

        ${imageHTML ? `<div class="stat-block-image-section-readonly">${imageHTML}</div>` : ''}

        ${c.description ? `<div class="stat-block-desc">${escapeHtml(c.description)}</div>` : ''}

        ${c.motives ? `
          <div class="stat-line-readonly">
            <span class="stat-label">Motives:</span>
            <span class="stat-value">${escapeHtml(c.motives)}</span>
          </div>
        ` : ''}

        ${c.tactics ? `
          <div class="stat-line-readonly">
            <span class="stat-label">Tactics:</span>
            <span class="stat-value">${escapeHtml(c.tactics)}</span>
          </div>
        ` : ''}

        <div class="stat-grid-readonly">
          <div class="stat-item-readonly">
            <div class="stat-item-label">Difficulty</div>
            <div class="stat-item-value">${c.difficulty || '?'}</div>
          </div>
          <div class="stat-item-readonly">
            <div class="stat-item-label">Major</div>
            <div class="stat-item-value">${c.majorThresh || '?'}</div>
          </div>
          <div class="stat-item-readonly">
            <div class="stat-item-label">Severe</div>
            <div class="stat-item-value">${c.severeThresh || '?'}</div>
          </div>
          <div class="stat-item-readonly">
            <div class="stat-item-label">HP</div>
            <div class="stat-item-value">${c.hp || '?'}</div>
          </div>
          <div class="stat-item-readonly">
            <div class="stat-item-label">Stress</div>
            <div class="stat-item-value">${c.stress || '?'}</div>
          </div>
          <div class="stat-item-readonly">
            <div class="stat-item-label">Attack</div>
            <div class="stat-item-value">${c.atkMod || '?'}</div>
          </div>
        </div>

        <div class="stat-line-readonly">
          <span class="stat-label">Weapon:</span>
          <span class="stat-value">${escapeHtml(c.weapon || 'None')} (${c.range || 'Melee'})</span>
        </div>
        <div class="stat-line-readonly">
          <span class="stat-label">Damage:</span>
          <span class="stat-value">${c.damage || '?'} ${c.dmgType || 'phy'}</span>
        </div>
        ${c.experience ? `
          <div class="stat-line-readonly">
            <span class="stat-label">Experience:</span>
            <span class="stat-value">${escapeHtml(c.experience)}</span>
          </div>
        ` : ''}

        ${(c.features && c.features.length > 0) ? `
          <div class="features-section-readonly">
            <h4 class="section-title">Features</h4>
            ${featuresHTML}
          </div>
        ` : ''}

        ${(c.tags && c.tags.length > 0) ? `
          <div class="tags-section-readonly">
            <h4 class="section-title">Tags</h4>
            <div class="tags-readonly">${tagsHTML}</div>
          </div>
        ` : ''}
      `;
    }

    // ==================== EDITING FUNCTIONS ====================
    function updateStat(key, value) {
      if (currentConverted) {
        currentConverted[key] = value;
        pushHistory();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    function updateImageUrl(url) {
      if (currentConverted) {
        currentConverted.imageUrl = url.trim();
        pushHistory();
        renderPreview();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    function updateFeature(index, field, value) {
      if (currentConverted && currentConverted.features[index]) {
        currentConverted.features[index][field] = value;
        pushHistory();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    function cycleFeatureType(index) {
      if (!currentConverted || !currentConverted.features[index]) return;
      const types = ['Passive', 'Action', 'Reaction'];
      const current = currentConverted.features[index].type;
      const nextIndex = (types.indexOf(current) + 1) % types.length;
      currentConverted.features[index].type = types[nextIndex];
      pushHistory();
      renderPreview();
      renderJSON();
      renderMarkdown();
      renderText();
    }

    function removeFeature(index) {
      if (currentConverted && currentConverted.features[index]) {
        currentConverted.features.splice(index, 1);
        pushHistory();
        renderPreview();
        renderJSON();
        renderMarkdown();
        renderText();
        showToast('Feature removed', 'info');
      }
    }

    function addFeature() {
      if (!currentConverted) return;
      currentConverted.features.push({
        name: 'New Feature',
        type: 'Passive',
        desc: 'Description here...'
      });
      pushHistory();
      renderPreview();
      renderJSON();
      renderMarkdown();
      renderText();
      // Focus the new feature name input
      setTimeout(() => {
        const inputs = document.querySelectorAll('.feature-name-input');
        if (inputs.length > 0) {
          inputs[inputs.length - 1].focus();
          inputs[inputs.length - 1].select();
        }
      }, 50);
    }

    function addTag(tag) {
      if (!currentConverted || !tag.trim()) return;
      currentConverted.tags.push(tag.trim().toLowerCase());
      pushHistory();
      renderPreview();
      renderJSON();
    }

    function removeTag(index) {
      if (currentConverted && currentConverted.tags[index] !== undefined) {
        currentConverted.tags.splice(index, 1);
        pushHistory();
        renderPreview();
        renderJSON();
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    // ==================== RENDER JSON ====================
    function renderJSON() {
      if (!currentConverted) return;
      const exportObj = getExportObject();
      document.getElementById('jsonOutput').textContent = JSON.stringify(exportObj, null, 2);
    }

    // ==================== RENDER MARKDOWN ====================
    function renderMarkdown() {
      if (!currentConverted) return;
      const c = currentConverted;

      const featuresText = c.features.map(f =>
        `**${f.name}** *(${f.type})*: ${f.desc}`
      ).join('\n\n');

      const imageSection = c.imageUrl ? `![${c.name}](${c.imageUrl})\n\n` : '';

      const md = `# ${c.name}
*Tier ${c.tier} ${c.advType}*

${imageSection}${c.description}

**Motives:** ${c.motives}
**Tactics:** ${c.tactics}

| Stat | Value |
|------|-------|
| Difficulty | ${c.difficulty} |
| Thresholds | ${c.majorThresh}/${c.severeThresh} |
| HP | ${c.hp} |
| Stress | ${c.stress} |
| Attack | ${c.atkMod} |
| Damage | ${c.damage} ${c.dmgType} |

**Weapon:** ${c.weapon} (${c.range})
**Experience:** ${c.experience}

## Features

${featuresText}

---
*Tags: ${c.tags.join(', ')}*`;

      document.getElementById('markdownOutput').textContent = md;
    }

    // ==================== RENDER TEXT ====================
    function renderText() {
      if (!currentConverted) return;
      const c = currentConverted;

      const featuresText = c.features.map(f =>
        `${f.name} - ${f.type}: ${f.desc}`
      ).join('\n');

      const imageSection = c.imageUrl ? `Image: ${c.imageUrl}\n\n` : '';

      const text = `${c.name.toUpperCase()}
Tier ${c.tier} ${c.advType}

${imageSection}${c.description}
Motives & Tactics: ${c.motives}
Difficulty: ${c.difficulty} | Thresholds: ${c.majorThresh}/${c.severeThresh} | HP: ${c.hp} | Stress: ${c.stress}
ATK: ${c.atkMod} | ${c.weapon}: ${c.range} | ${c.damage} ${c.dmgType}
Experience: ${c.experience}

FEATURES
${featuresText}

Tags: ${c.tags.join(', ')}`;

      document.getElementById('textOutput').textContent = text;
    }

    // ==================== TABS ====================
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => {
        const isActive = t.dataset.tab === tab;
        t.classList.toggle('active', isActive);
        t.setAttribute('aria-selected', isActive);
      });

      ['preview', 'json', 'markdown', 'text'].forEach(t => {
        document.getElementById(t + 'Tab').classList.toggle('hidden', t !== tab);
      });
    }

    // ==================== EXPORT FUNCTIONS ====================
    function getExportObject() {
      const exportObj = { ...currentConverted };
      delete exportObj._converted;
      delete exportObj._sourceCR;
      delete exportObj._sourceHP;
      return exportObj;
    }

    function copyJSON() {
      if (!currentConverted) {
        showToast('Nothing to copy. Convert a stat block first.', 'error');
        return;
      }
      const exportObj = getExportObject();
      navigator.clipboard.writeText(JSON.stringify(exportObj, null, 2))
        .then(() => showToast('JSON copied!', 'success'))
        .catch(() => showToast('Failed to copy', 'error'));
    }

    function copyMarkdown() {
      if (!currentConverted) {
        showToast('Nothing to copy. Convert a stat block first.', 'error');
        return;
      }
      navigator.clipboard.writeText(document.getElementById('markdownOutput').textContent)
        .then(() => showToast('Markdown copied!', 'success'))
        .catch(() => showToast('Failed to copy', 'error'));
    }

    function copyText() {
      if (!currentConverted) {
        showToast('Nothing to copy. Convert a stat block first.', 'error');
        return;
      }
      navigator.clipboard.writeText(document.getElementById('textOutput').textContent)
        .then(() => showToast('Text copied!', 'success'))
        .catch(() => showToast('Failed to copy', 'error'));
    }

    function downloadJSON() {
      if (!currentConverted) {
        showToast('Nothing to download. Convert a stat block first.', 'error');
        return;
      }
      const exportObj = getExportObject();
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentConverted.id}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Downloaded: ' + currentConverted.id + '.json', 'success');
    }

    function addToLibrary() {
      if (!currentConverted) {
        showToast('Nothing to add. Convert a stat block first.', 'error');
        return;
      }

      // Try to add to the main app's library if available
      try {
        // Check if we're in an iframe or have access to parent
        if (window.opener && window.opener.addToLibraryFromConverter) {
          window.opener.addToLibraryFromConverter(getExportObject());
          showToast('Added to library!', 'success');
          return;
        }

        // Check localStorage for the main app's library
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const exportObj = getExportObject();
        exportObj._userCreated = true;

        // Check for duplicates
        const exists = existingLibrary.some(item => item.id === exportObj.id);
        if (exists) {
          // Update existing
          const index = existingLibrary.findIndex(item => item.id === exportObj.id);
          existingLibrary[index] = exportObj;
          showToast('Updated in library!', 'success');
        } else {
          existingLibrary.push(exportObj);
          showToast('Added to library!', 'success');
        }

        localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
      } catch (e) {
        console.error(e);
        showToast('Could not add to library: ' + e.message, 'error');
      }
    }

    function addConvertedToGroup() {
      if (!currentConverted) {
        showToast('Nothing to add. Convert a stat block first.', 'error');
        return;
      }

      // First add to library if not already there
      try {
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const exportObj = getExportObject();
        exportObj._userCreated = true;

        const existing = existingLibrary.findIndex(item => item.id === exportObj.id);
        if (existing < 0) {
          existingLibrary.push(exportObj);
          localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
        }

        // Then open group selection modal
        addAdversaryToGroup(exportObj);
      } catch (e) {
        console.error(e);
        showToast('Could not add to group: ' + e.message, 'error');
      }
    }

    // ==================== CLEAR ====================
    function clearAll() {
      document.getElementById('inputText').value = '';
      document.getElementById('liveParsePreview').classList.add('hidden');
      document.getElementById('adjustments').classList.add('hidden');
      document.getElementById('overrideTier').value = '';
      document.getElementById('overrideType').value = '';

      ['copyBtn', 'copyMdBtn', 'copyTextBtn', 'downloadBtn', 'libraryBtn', 'groupBtn', 'shareBtn', 'printBtn'].forEach(id => {
        document.getElementById(id).disabled = true;
      });

      document.getElementById('statBlockPreview').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon" aria-hidden="true">âš”ï¸</div>
          <div>Paste a stat block and press <kbd>Ctrl</kbd>+<kbd>Enter</kbd></div>
          <div style="margin-top: 0.5rem; font-size: 0.85rem;">or click "Convert to Daggerheart"</div>
        </div>
      `;
      document.getElementById('jsonOutput').textContent = '// JSON output will appear here';
      document.getElementById('markdownOutput').textContent = 'Markdown output will appear here';
      document.getElementById('textOutput').textContent = 'Text output will appear here';

      currentParsed = null;
      currentConverted = null;
      batchResults = [];
      history = [];
      historyIndex = -1;
      updateUndoRedoButtons();

      clearDraft();
      showToast('Cleared', 'info');
    }

    // ==================== TOAST ====================
    let toastTimeout = null;
    let toastStartTime = null;
    let toastDuration = 3000;
    let toastRemainingTime = 0;
    let toastProgressInterval = null;

    function setupToastInteraction() {
      const toast = document.getElementById('toast');

      toast.addEventListener('mouseenter', () => {
        pauseToast();
      });

      toast.addEventListener('mouseleave', () => {
        resumeToast();
      });

      // Also pause on focus (for keyboard users)
      toast.addEventListener('focusin', () => {
        pauseToast();
      });

      toast.addEventListener('focusout', (e) => {
        // Only resume if focus left the toast entirely
        if (!toast.contains(e.relatedTarget)) {
          resumeToast();
        }
      });
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastProgress = document.getElementById('toastProgress');

      // Clear any existing timeout
      if (toastTimeout) {
        clearTimeout(toastTimeout);
      }
      if (toastProgressInterval) {
        clearInterval(toastProgressInterval);
      }

      toastMessage.textContent = message;
      toast.className = `toast toast-${type} show`;
      toastProgress.style.width = '100%';

      toastDuration = 3000;
      toastStartTime = Date.now();
      toastRemainingTime = toastDuration;

      // Animate progress bar
      toastProgressInterval = setInterval(() => {
        const elapsed = Date.now() - toastStartTime;
        const remaining = Math.max(0, toastDuration - elapsed);
        const percent = (remaining / toastDuration) * 100;
        toastProgress.style.width = percent + '%';
      }, 50);

      // Auto-dismiss after duration
      toastTimeout = setTimeout(() => {
        dismissToast();
      }, toastDuration);
    }

    function pauseToast() {
      const toast = document.getElementById('toast');
      if (!toast.classList.contains('show')) return;

      toast.classList.add('paused');
      toastRemainingTime = Math.max(0, toastDuration - (Date.now() - toastStartTime));

      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
      if (toastProgressInterval) {
        clearInterval(toastProgressInterval);
        toastProgressInterval = null;
      }
    }

    function resumeToast() {
      const toast = document.getElementById('toast');
      const toastProgress = document.getElementById('toastProgress');
      if (!toast.classList.contains('show')) return;

      toast.classList.remove('paused');
      toastStartTime = Date.now();
      toastDuration = toastRemainingTime;

      // Resume progress bar animation
      toastProgressInterval = setInterval(() => {
        const elapsed = Date.now() - toastStartTime;
        const remaining = Math.max(0, toastDuration - elapsed);
        const percent = (remaining / toastDuration) * 100;
        toastProgress.style.width = percent + '%';
      }, 50);

      // Resume auto-dismiss
      toastTimeout = setTimeout(() => {
        dismissToast();
      }, toastRemainingTime);
    }

    function dismissToast() {
      const toast = document.getElementById('toast');
      const toastProgress = document.getElementById('toastProgress');

      toast.classList.remove('show', 'paused');

      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
      if (toastProgressInterval) {
        clearInterval(toastProgressInterval);
        toastProgressInterval = null;
      }

      toastProgress.style.width = '0%';
    }

    // ==================== AUTH STATE ====================
    let currentUser = null;

    async function checkAuthState() {
      try {
        const response = await fetch('/api/auth/me');
        const data = await response.json();
        currentUser = data.user;
        renderAuthUI();
      } catch (err) {
        console.log('Auth check failed (server may not be running):', err.message);
        currentUser = null;
        renderAuthUI();
      }
    }

    function handleAuthRedirect() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('login') === 'success') {
        showToast('Logged in successfully!', 'success');
        window.history.replaceState({}, '', window.location.pathname);
      } else if (params.get('error') === 'auth_failed') {
        showToast('Login failed. Please try again.', 'error');
        window.history.replaceState({}, '', window.location.pathname);
      }
    }

    function renderAuthUI() {
      const authSection = document.getElementById('authSection');
      if (!authSection) return;

      // Show/hide My Submissions filter button
      const mySubmissionsBtn = document.getElementById('mySubmissionsBtn');
      if (mySubmissionsBtn) {
        mySubmissionsBtn.style.display = currentUser ? '' : 'none';
      }

      // Show/hide share button
      const shareBtn = document.getElementById('shareBtn');
      if (shareBtn) {
        shareBtn.disabled = !currentUser;
        shareBtn.title = currentUser ? 'Share to Community' : 'Sign in to share';
      }

      // Show/hide admin elements
      const adminNavLink = document.getElementById('adminNavLink');
      if (adminNavLink) {
        adminNavLink.classList.toggle('hidden', !currentUser?.is_admin);
      }

      if (currentUser) {
        const initial = currentUser.username.charAt(0).toUpperCase();
        authSection.innerHTML = `
          <div class="user-menu">
            <button class="user-menu-toggle" onclick="toggleUserMenu()" aria-haspopup="true" aria-expanded="false">
              <div class="user-avatar">
                ${currentUser.avatar_url
                  ? `<img src="${currentUser.avatar_url}" alt="${currentUser.username}">`
                  : initial}
              </div>
              <span>${currentUser.username}</span>
            </button>
            <div class="user-dropdown" id="userDropdown">
              <button class="user-dropdown-item" onclick="navigateTo('community'); setCommunityFilter('mine'); toggleUserMenu();">My Submissions</button>
              <button class="user-dropdown-item danger" onclick="logout()">Logout</button>
            </div>
          </div>
        `;
      } else {
        authSection.innerHTML = `
          <button class="btn-login" onclick="openLoginModal()">
            Sign In
          </button>
        `;
      }
    }

    // ==================== PAGE NAVIGATION ====================
    let currentPage = 'converter';

    function navigateTo(page) {
      currentPage = page;

      // Update nav links
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.toggle('active', link.dataset.page === page);
      });

      // Update page views
      document.querySelectorAll('.page-view').forEach(view => {
        view.classList.toggle('active', view.id === page + 'Page');
      });

      // Load community when navigating to it
      if (page === 'community' && !communityLoaded) {
        loadCommunityConversions();
      }

      // Load My Library when navigating to it
      if (page === 'myLibrary') {
        loadMyLibrary();
      }

      // Load admin data when navigating to it
      if (page === 'admin' && currentUser?.is_admin) {
        loadAdminData();
      }
    }

    // ==================== ADMIN PANEL ====================
    let adminConversionsPage = 1;
    let adminUsersPage = 1;
    let adminSearchTimeout = null;

    async function loadAdminData() {
      loadAdminStats();
      loadAdminConversions();
    }

    async function loadAdminStats() {
      try {
        const response = await fetch('/api/admin/stats');
        if (!response.ok) throw new Error('Failed to load stats');
        const stats = await response.json();

        document.getElementById('statUsers').textContent = stats.totalUsers;
        document.getElementById('statConversions').textContent = stats.totalConversions;
        document.getElementById('statVotes').textContent = stats.totalVotes;
        document.getElementById('statRecentConversions').textContent = stats.recentConversions;
      } catch (err) {
        console.error('Failed to load admin stats:', err);
      }
    }

    async function loadAdminConversions(page = 1) {
      adminConversionsPage = page;
      const search = document.getElementById('adminConversionSearch')?.value || '';
      const tbody = document.getElementById('adminConversionsBody');
      tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`/api/admin/conversions?page=${page}&search=${encodeURIComponent(search)}`);
        if (!response.ok) throw new Error('Failed to load conversions');
        const data = await response.json();

        if (data.conversions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="loading">No conversions found</td></tr>';
          renderAdminPagination('adminConversionsPagination', data.pagination, loadAdminConversions);
          return;
        }

        tbody.innerHTML = data.conversions.map(c => `
          <tr>
            <td>${escapeHtml(c.name)}</td>
            <td>
              <div class="admin-author">
                ${c.author.avatarUrl ? `<img src="${c.author.avatarUrl}" alt="">` : ''}
                <span>${escapeHtml(c.author.username || 'Unknown')}${c.author.isBanned ? ' <span class="admin-badge banned">Banned</span>' : ''}</span>
              </div>
            </td>
            <td>T${c.tier}</td>
            <td>${c.advType}</td>
            <td>${c.score}</td>
            <td><span class="admin-badge ${c.isPublished ? 'published' : 'unpublished'}">${c.isPublished ? 'Published' : 'Hidden'}</span></td>
            <td>${new Date(c.createdAt).toLocaleDateString()}</td>
            <td>
              <div class="admin-actions">
                <button class="admin-btn" onclick="adminTogglePublish('${c.id}', ${!c.isPublished})">${c.isPublished ? 'Hide' : 'Show'}</button>
                <button class="admin-btn danger" onclick="adminDeleteConversion('${c.id}', '${escapeHtml(c.name)}')">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');

        renderAdminPagination('adminConversionsPagination', data.pagination, loadAdminConversions);
      } catch (err) {
        console.error('Failed to load admin conversions:', err);
        tbody.innerHTML = '<tr><td colspan="8" class="loading">Failed to load conversions</td></tr>';
      }
    }

    async function loadAdminUsers(page = 1) {
      adminUsersPage = page;
      const search = document.getElementById('adminUserSearch')?.value || '';
      const tbody = document.getElementById('adminUsersBody');
      tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`/api/admin/users?page=${page}&search=${encodeURIComponent(search)}`);
        if (!response.ok) throw new Error('Failed to load users');
        const data = await response.json();

        if (data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="loading">No users found</td></tr>';
          renderAdminPagination('adminUsersPagination', data.pagination, loadAdminUsers);
          return;
        }

        tbody.innerHTML = data.users.map(u => `
          <tr>
            <td>
              <div class="admin-author">
                ${u.avatarUrl ? `<img src="${u.avatarUrl}" alt="">` : ''}
                <span>${escapeHtml(u.username)}</span>
              </div>
            </td>
            <td>${u.provider}</td>
            <td>${u.conversionCount}</td>
            <td>${u.voteCount}</td>
            <td>
              ${u.isAdmin ? '<span class="admin-badge admin">Admin</span>' : ''}
              ${u.isBanned ? '<span class="admin-badge banned">Banned</span>' : '<span class="admin-badge active">Active</span>'}
            </td>
            <td>${new Date(u.createdAt).toLocaleDateString()}</td>
            <td>
              <div class="admin-actions">
                ${!u.isAdmin ? `<button class="admin-btn ${u.isBanned ? '' : 'danger'}" onclick="adminToggleBan('${u.id}', ${!u.isBanned}, '${escapeHtml(u.username)}')">${u.isBanned ? 'Unban' : 'Ban'}</button>` : ''}
              </div>
            </td>
          </tr>
        `).join('');

        renderAdminPagination('adminUsersPagination', data.pagination, loadAdminUsers);
      } catch (err) {
        console.error('Failed to load admin users:', err);
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Failed to load users</td></tr>';
      }
    }

    function renderAdminPagination(containerId, pagination, loadFn) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = `
        <button class="btn btn-secondary btn-small" onclick="${loadFn.name}(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>Prev</button>
        <span>Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} total)</span>
        <button class="btn btn-secondary btn-small" onclick="${loadFn.name}(${pagination.page + 1})" ${pagination.page >= pagination.totalPages ? 'disabled' : ''}>Next</button>
      `;
    }

    function switchAdminTab(tab) {
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));

      document.querySelector(`.admin-tab[onclick*="${tab}"]`)?.classList.add('active');
      document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`)?.classList.remove('hidden');

      if (tab === 'users') {
        loadAdminUsers();
      } else {
        loadAdminConversions();
      }
    }

    function debounceAdminSearch(type) {
      clearTimeout(adminSearchTimeout);
      adminSearchTimeout = setTimeout(() => {
        if (type === 'conversions') {
          loadAdminConversions(1);
        } else {
          loadAdminUsers(1);
        }
      }, 300);
    }

    async function adminTogglePublish(id, publish) {
      try {
        const response = await fetch(`/api/admin/conversions/${id}/publish`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isPublished: publish })
        });
        if (!response.ok) throw new Error('Failed to update');
        showToast(publish ? 'Conversion published' : 'Conversion hidden', 'success');
        loadAdminConversions(adminConversionsPage);
      } catch (err) {
        showToast('Failed to update conversion', 'error');
      }
    }

    async function adminDeleteConversion(id, name) {
      if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/admin/conversions/${id}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete');
        showToast('Conversion deleted', 'success');
        loadAdminConversions(adminConversionsPage);
        loadAdminStats();
      } catch (err) {
        showToast('Failed to delete conversion', 'error');
      }
    }

    async function adminToggleBan(id, ban, username) {
      if (ban && !confirm(`Ban user "${username}"? They will no longer be able to log in.`)) return;

      try {
        const response = await fetch(`/api/admin/users/${id}/ban`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isBanned: ban })
        });
        if (!response.ok) throw new Error('Failed to update');
        showToast(ban ? 'User banned' : 'User unbanned', 'success');
        loadAdminUsers(adminUsersPage);
        loadAdminStats();
      } catch (err) {
        showToast('Failed to update user', 'error');
      }
    }

    // ==================== MY LIBRARY (Drag & Drop Folder System) ====================
    let myLibraryGroups = [];
    let selectedFolderId = 'all';
    let selectedMyLibraryAdversary = null;
    let adversaryToAdd = null;
    let draggedAdversary = null;
    let librarySearchFilter = '';

    function loadMyLibrary() {
      loadGroupsFromStorage();
      renderFoldersList();
      updateFolderCounts();
      selectFolder(selectedFolderId || 'all');
    }

    function loadGroupsFromStorage() {
      try {
        const stored = localStorage.getItem('dh-groups');
        myLibraryGroups = stored ? JSON.parse(stored) : [];
      } catch (e) {
        console.error('Failed to load groups:', e);
        myLibraryGroups = [];
      }
    }

    function saveGroupsToStorage() {
      try {
        localStorage.setItem('dh-groups', JSON.stringify(myLibraryGroups));
      } catch (e) {
        console.error('Failed to save groups:', e);
        showToast('Failed to save', 'error');
      }
    }

    function getAllLibraryAdversaries() {
      try {
        return JSON.parse(localStorage.getItem('dh-user-library') || '[]');
      } catch (e) {
        return [];
      }
    }

    function getUngroupedAdversaries() {
      const library = getAllLibraryAdversaries();
      const groupedIds = new Set();
      myLibraryGroups.forEach(g => {
        (g.adversaries || []).forEach(a => groupedIds.add(a.id));
      });
      return library.filter(a => !groupedIds.has(a.id));
    }

    function renderFoldersList() {
      const container = document.getElementById('foldersList');
      if (!container) return;

      if (myLibraryGroups.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = myLibraryGroups.map(folder => `
        <div class="folder-item ${selectedFolderId === folder.id ? 'active' : ''}"
             data-folder="${folder.id}"
             onclick="selectFolder('${folder.id}')"
             ondragover="handleFolderDragOver(event)"
             ondragleave="handleFolderDragLeave(event)"
             ondrop="handleFolderDrop(event, '${folder.id}')">
          <span class="folder-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
            </svg>
          </span>
          <span class="folder-name">${escapeHtml(folder.name)}</span>
          <span class="folder-count">${(folder.adversaries || []).length}</span>
        </div>
      `).join('');
    }

    function updateFolderCounts() {
      const allCount = document.getElementById('allCount');
      const ungroupedCount = document.getElementById('ungroupedCount');
      if (allCount) allCount.textContent = getAllLibraryAdversaries().length;
      if (ungroupedCount) ungroupedCount.textContent = getUngroupedAdversaries().length;
    }

    function selectFolder(folderId) {
      selectedFolderId = folderId;

      // Update folder selection in sidebar
      document.querySelectorAll('.folder-item').forEach(el => {
        el.classList.toggle('active', el.dataset.folder === folderId);
      });

      // Update content header
      const nameEl = document.getElementById('currentFolderName');
      const countEl = document.getElementById('folderItemCount');
      const editActionsEl = document.getElementById('folderEditActions');

      let adversaries = [];
      let folderName = 'All Adversaries';

      if (folderId === 'all') {
        adversaries = getAllLibraryAdversaries();
        folderName = 'All Adversaries';
        if (editActionsEl) editActionsEl.style.display = 'none';
      } else if (folderId === 'ungrouped') {
        adversaries = getUngroupedAdversaries();
        folderName = 'Ungrouped';
        if (editActionsEl) editActionsEl.style.display = 'none';
      } else {
        const folder = myLibraryGroups.find(g => g.id === folderId);
        if (folder) {
          adversaries = folder.adversaries || [];
          folderName = folder.name;
          if (editActionsEl) editActionsEl.style.display = 'flex';
        }
      }

      if (nameEl) nameEl.textContent = folderName;
      if (countEl) countEl.textContent = `(${adversaries.length} items)`;

      renderLibraryItems(adversaries);
    }

    function renderLibraryItems(adversaries) {
      const container = document.getElementById('libraryItems');
      const emptyState = document.getElementById('libraryEmptyState');
      if (!container) return;

      // Apply search filter
      let filtered = adversaries;
      if (librarySearchFilter) {
        const search = librarySearchFilter.toLowerCase();
        filtered = adversaries.filter(a =>
          (a.name || '').toLowerCase().includes(search) ||
          (a.advType || '').toLowerCase().includes(search)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '';
        if (emptyState) emptyState.classList.remove('hidden');
        return;
      }

      if (emptyState) emptyState.classList.add('hidden');

      container.innerHTML = filtered.map(adv => `
        <div class="adversary-card"
             draggable="true"
             data-adversary-id="${adv.id}"
             ondragstart="handleAdversaryDragStart(event, '${adv.id}')"
             ondragend="handleAdversaryDragEnd(event)"
             onclick="openMyLibraryAdversary('${adv.id}')">
          <div class="adversary-card-header">
            <span class="adversary-card-name">${escapeHtml(adv.name || 'Unknown')}</span>
            <span class="adversary-card-tier">T${adv.tier || '?'}</span>
          </div>
          <div class="adversary-card-type">${adv.advType || 'Standard'}</div>
          <div class="adversary-card-stats">
            <span>HP ${adv.hp || '?'}</span>
            <span>Diff ${adv.difficulty || '?'}</span>
          </div>
          <div class="adversary-card-drag-hint">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="9" cy="5" r="2"/><circle cx="15" cy="5" r="2"/>
              <circle cx="9" cy="12" r="2"/><circle cx="15" cy="12" r="2"/>
              <circle cx="9" cy="19" r="2"/><circle cx="15" cy="19" r="2"/>
            </svg>
          </div>
        </div>
      `).join('');
    }

    function filterLibraryItems() {
      const input = document.getElementById('librarySearch');
      librarySearchFilter = input ? input.value : '';
      selectFolder(selectedFolderId);
    }

    // ==================== DRAG & DROP HANDLERS ====================
    function handleAdversaryDragStart(event, adversaryId) {
      // Find the adversary data
      let adv = getAllLibraryAdversaries().find(a => a.id === adversaryId);
      if (!adv) return;

      draggedAdversary = adv;
      event.target.classList.add('dragging');

      // Set drag data
      event.dataTransfer.setData('text/plain', adversaryId);
      event.dataTransfer.effectAllowed = 'move';
    }

    function handleAdversaryDragEnd(event) {
      event.target.classList.remove('dragging');
      draggedAdversary = null;

      // Remove drag-over from all folders
      document.querySelectorAll('.folder-item').forEach(el => {
        el.classList.remove('drag-over');
      });
    }

    function handleFolderDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
      event.currentTarget.classList.add('drag-over');
    }

    function handleFolderDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleFolderDrop(event, targetFolderId) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (!draggedAdversary) return;

      const advId = draggedAdversary.id;

      // Special handling for 'all' folder - do nothing (can't move to "all")
      if (targetFolderId === 'all') {
        showToast('Items are always visible in All Adversaries', 'info');
        return;
      }

      // Remove from all groups first
      myLibraryGroups.forEach(g => {
        g.adversaries = (g.adversaries || []).filter(a => a.id !== advId);
      });

      // If target is a specific folder (not ungrouped), add to it
      if (targetFolderId !== 'ungrouped') {
        const targetFolder = myLibraryGroups.find(g => g.id === targetFolderId);
        if (targetFolder) {
          if (!targetFolder.adversaries) targetFolder.adversaries = [];
          targetFolder.adversaries.push(draggedAdversary);
          showToast(`Moved to "${targetFolder.name}"`, 'success');
        }
      } else {
        showToast('Moved to Ungrouped', 'success');
      }

      saveGroupsToStorage();
      renderFoldersList();
      updateFolderCounts();
      selectFolder(selectedFolderId);
    }

    function handleContainerDragOver(event) {
      event.preventDefault();
    }

    function handleContainerDrop(event) {
      event.preventDefault();
      // Container drops do nothing extra - folder drops handle everything
    }

    // ==================== FOLDER MANAGEMENT ====================
    function createNewGroup() {
      const name = prompt('Enter folder name:');
      if (!name || !name.trim()) return;

      const newFolder = {
        id: 'folder-' + Date.now(),
        name: name.trim(),
        adversaries: [],
        createdAt: new Date().toISOString()
      };

      myLibraryGroups.push(newFolder);
      saveGroupsToStorage();
      renderFoldersList();
      updateFolderCounts();
      selectFolder(newFolder.id);
      showToast(`Folder "${name}" created`, 'success');
    }

    function startRenameFolder() {
      if (!selectedFolderId || selectedFolderId === 'all' || selectedFolderId === 'ungrouped') return;

      const folder = myLibraryGroups.find(g => g.id === selectedFolderId);
      if (!folder) return;

      const newName = prompt('Enter new name:', folder.name);
      if (!newName || !newName.trim()) return;

      folder.name = newName.trim();
      saveGroupsToStorage();
      renderFoldersList();
      document.getElementById('currentFolderName').textContent = folder.name;
      showToast('Folder renamed', 'success');
    }

    function deleteCurrentGroup() {
      if (!selectedFolderId || selectedFolderId === 'all' || selectedFolderId === 'ungrouped') return;

      const folder = myLibraryGroups.find(g => g.id === selectedFolderId);
      if (!folder) return;

      if (!confirm(`Delete folder "${folder.name}"? Adversaries will be moved to Ungrouped.`)) {
        return;
      }

      myLibraryGroups = myLibraryGroups.filter(g => g.id !== selectedFolderId);
      saveGroupsToStorage();
      selectedFolderId = 'all';
      renderFoldersList();
      updateFolderCounts();
      selectFolder('all');
      showToast(`Folder deleted`, 'info');
    }

    // ==================== ADVERSARY DETAIL MODAL ====================
    function openMyLibraryAdversary(adversaryId) {
      const adversary = getAllLibraryAdversaries().find(a => a.id === adversaryId);
      if (!adversary) {
        showToast('Adversary not found', 'error');
        return;
      }

      selectedMyLibraryAdversary = adversary;
      document.getElementById('myLibraryModalTitle').textContent = adversary.name || 'Adversary Details';
      document.getElementById('myLibraryModalStatBlock').innerHTML = renderStatBlockReadOnly(adversary);
      document.getElementById('myLibraryModal').classList.remove('hidden');
    }

    function closeMyLibraryModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('myLibraryModal').classList.add('hidden');
      selectedMyLibraryAdversary = null;
    }

    function copyMyLibraryJSON() {
      if (!selectedMyLibraryAdversary) return;
      navigator.clipboard.writeText(JSON.stringify(selectedMyLibraryAdversary, null, 2));
      showToast('JSON copied', 'success');
    }

    function moveToGroup() {
      if (!selectedMyLibraryAdversary) return;
      adversaryToAdd = selectedMyLibraryAdversary;
      openAddToGroupModal(selectedMyLibraryAdversary.name, true);
    }

    function removeFromLibrary() {
      if (!selectedMyLibraryAdversary) return;
      if (!confirm(`Remove "${selectedMyLibraryAdversary.name}" from your library?`)) return;

      const advId = selectedMyLibraryAdversary.id;

      // Remove from groups
      myLibraryGroups.forEach(g => {
        g.adversaries = (g.adversaries || []).filter(a => a.id !== advId);
      });
      saveGroupsToStorage();

      // Remove from main library
      try {
        let library = getAllLibraryAdversaries().filter(a => a.id !== advId);
        localStorage.setItem('dh-user-library', JSON.stringify(library));
      } catch (e) {
        console.error('Failed to remove:', e);
      }

      closeMyLibraryModal();
      loadMyLibrary();
      showToast('Removed from library', 'info');
    }

    // ==================== ADD TO GROUP MODAL ====================
    function openAddToGroupModal(adversaryName, isMove = false) {
      document.getElementById('addToGroupAdversaryName').textContent =
        isMove ? `Move "${adversaryName}" to:` : `Add "${adversaryName}" to:`;

      const listEl = document.getElementById('groupSelectList');

      if (myLibraryGroups.length === 0) {
        listEl.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">No folders yet. Create one below.</p>`;
      } else {
        listEl.innerHTML = myLibraryGroups.map(folder => `
          <div class="group-select-item" onclick="addToGroup('${folder.id}')">
            <span class="folder-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></span>
            <span class="folder-name">${escapeHtml(folder.name)}</span>
            <span class="folder-count">${(folder.adversaries || []).length}</span>
          </div>
        `).join('');
      }

      document.getElementById('newGroupNameInline').value = '';
      document.getElementById('addToGroupModal').classList.remove('hidden');
    }

    function closeAddToGroupModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('addToGroupModal').classList.add('hidden');
      adversaryToAdd = null;
    }

    function addToGroup(folderId) {
      if (!adversaryToAdd) return;

      const folder = myLibraryGroups.find(g => g.id === folderId);
      if (!folder) {
        showToast('Folder not found', 'error');
        return;
      }

      // Remove from other groups
      myLibraryGroups.forEach(g => {
        g.adversaries = (g.adversaries || []).filter(a => a.id !== adversaryToAdd.id);
      });

      // Add to target folder
      if (!folder.adversaries) folder.adversaries = [];
      folder.adversaries.push(adversaryToAdd);

      saveGroupsToStorage();
      closeAddToGroupModal();
      closeMyLibraryModal();

      if (currentPage === 'myLibrary') {
        loadMyLibrary();
        selectFolder(folderId);
      }

      showToast(`Added to "${folder.name}"`, 'success');
    }

    function createGroupAndAdd() {
      const nameInput = document.getElementById('newGroupNameInline');
      const name = nameInput.value.trim();
      if (!name) {
        showToast('Enter a folder name', 'error');
        return;
      }

      const newFolder = {
        id: 'folder-' + Date.now(),
        name: name,
        adversaries: adversaryToAdd ? [adversaryToAdd] : [],
        createdAt: new Date().toISOString()
      };

      // Remove from other groups if adding
      if (adversaryToAdd) {
        myLibraryGroups.forEach(g => {
          g.adversaries = (g.adversaries || []).filter(a => a.id !== adversaryToAdd.id);
        });
      }

      myLibraryGroups.push(newFolder);
      saveGroupsToStorage();

      closeAddToGroupModal();
      closeMyLibraryModal();

      if (currentPage === 'myLibrary') {
        loadMyLibrary();
        selectFolder(newFolder.id);
      }

      showToast(`Folder "${name}" created`, 'success');
    }

    function addAdversaryToGroup(adversary) {
      adversaryToAdd = adversary;
      loadGroupsFromStorage();
      openAddToGroupModal(adversary.name);
    }

    // Backward compatibility aliases
    function selectGroup(id) { selectFolder(id); }
    function renderGroupsList() { renderFoldersList(); }
    function renderUngroupedCount() { updateFolderCounts(); }

    // ==================== LOGIN MODAL ====================
    function openLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
    }

    function closeLoginModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('loginModal').classList.add('hidden');
    }

    // ==================== PRIVACY MODAL ====================
    function openPrivacyModal() {
      document.getElementById('privacyModal').classList.add('active');
    }

    function closePrivacyModal() {
      document.getElementById('privacyModal').classList.remove('active');
    }

    function toggleUserMenu() {
      const dropdown = document.getElementById('userDropdown');
      if (dropdown) {
        dropdown.classList.toggle('show');
      }
    }

    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        currentUser = null;
        renderAuthUI();
        showToast('Logged out successfully', 'info');
      } catch (err) {
        showToast('Logout failed', 'error');
      }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-menu')) {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown) dropdown.classList.remove('show');
      }
    });

    // ==================== COMMUNITY LIBRARY ====================
    let communityLoaded = false;
    let communityConversions = [];
    let communityPage = 1;
    let communityTotalPages = 1;
    let communitySearchDebounce = null;
    let selectedConversion = null;

    async function loadCommunityConversions() {
      const listEl = document.getElementById('communityList');
      listEl.innerHTML = `
        <div class="community-loading">
          <div class="loading-spinner"></div>
          <span>Loading community conversions...</span>
        </div>
      `;

      try {
        const search = document.getElementById('communitySearch').value;
        const tier = document.getElementById('communityTier').value;
        const type = document.getElementById('communityType').value;
        const sort = document.getElementById('communitySort').value;

        const params = new URLSearchParams({
          page: communityPage,
          limit: 20,
          search,
          tier,
          type,
          sort
        });

        const response = await fetch(`/api/community/conversions?${params}`);
        const data = await response.json();

        communityConversions = data.conversions || [];
        communityTotalPages = data.pagination?.totalPages || 1;
        communityLoaded = true;

        renderCommunityList();
        updateCommunityPagination();

      } catch (err) {
        console.error('Failed to load community conversions:', err);
        listEl.innerHTML = `
          <div class="community-empty">
            <p>Could not load community conversions.</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Make sure the server is running.</p>
          </div>
        `;
      }
    }

    function renderCommunityList() {
      const listEl = document.getElementById('communityList');

      if (communityConversions.length === 0) {
        listEl.innerHTML = `
          <div class="community-empty">
            <p>No conversions found.</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Be the first to share your creation!</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = communityConversions.map(conv => {
        const data = conv.data || {};
        const hp = data.hp || '?';
        const difficulty = data.difficulty || '?';
        const sourceSystem = conv.sourceSystem || data.sourceSystem;
        const authorAvatar = conv.author?.avatarUrl
          ? `<img src="${conv.author.avatarUrl}" alt="">`
          : '';

        return `
          <div class="community-item" onclick="openCommunityModal('${conv.id}')">
            <div class="community-item-main">
              <div class="community-item-header">
                <div class="community-item-name">${escapeHtml(conv.name)}</div>
                ${sourceSystem ? `<span class="community-item-source">${escapeHtml(sourceSystem)}</span>` : ''}
                <button class="share-link-btn" onclick="event.stopPropagation(); copyShareLinkFor('${conv.id}')" title="Copy share link">&#128279;</button>
              </div>
              <div class="community-item-stats">
                <span class="community-item-stat"><strong>Diff:</strong> ${difficulty}</span>
                <span class="community-item-stat"><strong>HP:</strong> ${hp}</span>
              </div>
              <div class="community-item-meta">
                <span class="community-item-tag tier">T${conv.tier}</span>
                <span class="community-item-tag">${conv.advType}</span>
                <span class="community-item-author">${authorAvatar}@${escapeHtml(conv.author?.username || 'Unknown')}</span>
              </div>
            </div>
            <div class="community-item-actions">
              <div class="community-item-votes">
                <button class="vote-btn upvote ${conv.userVote === 1 ? 'active' : ''}"
                        onclick="event.stopPropagation(); quickVote('${conv.id}', 1)">&#9650;</button>
                <span class="vote-score ${conv.score > 0 ? 'positive' : conv.score < 0 ? 'negative' : ''}">${conv.score}</span>
                <button class="vote-btn downvote ${conv.userVote === -1 ? 'active' : ''}"
                        onclick="event.stopPropagation(); quickVote('${conv.id}', -1)">&#9660;</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateCommunityPagination() {
      const paginationEl = document.getElementById('communityPagination');
      const pageInfo = document.getElementById('communityPageInfo');
      const prevBtn = document.getElementById('communityPrevBtn');
      const nextBtn = document.getElementById('communityNextBtn');

      if (communityTotalPages <= 1) {
        paginationEl.classList.add('hidden');
        return;
      }

      paginationEl.classList.remove('hidden');
      pageInfo.textContent = `Page ${communityPage} of ${communityTotalPages}`;
      prevBtn.disabled = communityPage <= 1;
      nextBtn.disabled = communityPage >= communityTotalPages;
    }

    function communityPrevPage() {
      if (communityPage > 1) {
        communityPage--;
        loadCommunityConversions();
      }
    }

    function communityNextPage() {
      if (communityPage < communityTotalPages) {
        communityPage++;
        loadCommunityConversions();
      }
    }

    function debounceCommunitySearch() {
      clearTimeout(communitySearchDebounce);
      communitySearchDebounce = setTimeout(() => {
        communityPage = 1;
        loadCommunityConversions();
      }, 300);
    }

    async function quickVote(conversionId, vote) {
      if (!currentUser) {
        showToast('Please log in to vote', 'info');
        return;
      }

      const conv = communityConversions.find(c => c.id === conversionId);
      if (!conv) return;

      // Toggle vote if clicking the same button
      const newVote = conv.userVote === vote ? 0 : vote;

      try {
        const response = await fetch(`/api/community/conversions/${conversionId}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vote: newVote })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Vote failed');
        }

        const data = await response.json();

        // Update local state
        conv.userVote = data.userVote;
        conv.upvotes = data.upvotes;
        conv.downvotes = data.downvotes;
        conv.score = data.score;

        renderCommunityList();

      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // ==================== COMMUNITY MODAL ====================
    async function openCommunityModal(conversionId) {
      const modal = document.getElementById('communityModal');
      const titleEl = document.getElementById('modalTitle');
      const statBlockEl = document.getElementById('modalStatBlock');

      // Find in local cache first
      selectedConversion = communityConversions.find(c => c.id === conversionId);

      if (!selectedConversion) {
        // Fetch from server
        try {
          const response = await fetch(`/api/community/conversions/${conversionId}`);
          selectedConversion = await response.json();
        } catch (err) {
          showToast('Failed to load conversion', 'error');
          return;
        }
      }

      titleEl.textContent = selectedConversion.name;
      statBlockEl.innerHTML = renderStatBlockReadOnly(selectedConversion.data);
      updateModalVotes();
      updateModalAuthor();

      // Update URL for direct linking (only if not already on this URL)
      if (window.location.pathname !== `/community/${conversionId}`) {
        window.history.pushState({ conversionId }, '', `/community/${conversionId}`);
      }

      modal.classList.remove('hidden');
    }

    function closeCommunityModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('communityModal').classList.add('hidden');
      selectedConversion = null;
      // Reset URL if we're on a community detail page
      if (window.location.pathname.startsWith('/community/')) {
        window.history.pushState({}, '', '/');
      }
    }

    function updateModalAuthor() {
      const authorEl = document.getElementById('modalAuthor');
      if (!selectedConversion || !authorEl) return;

      const author = selectedConversion.author;
      if (author) {
        const avatarHtml = author.avatarUrl
          ? `<img src="${author.avatarUrl}" alt="">`
          : '';
        const date = selectedConversion.createdAt
          ? new Date(selectedConversion.createdAt).toLocaleDateString()
          : '';
        authorEl.innerHTML = `${avatarHtml}Shared by @${escapeHtml(author.username)}${date ? ` on ${date}` : ''}`;
      } else {
        authorEl.innerHTML = '';
      }
    }

    function updateModalVotes() {
      if (!selectedConversion) return;

      const scoreEl = document.getElementById('modalVoteScore');
      const upBtn = document.getElementById('modalUpvoteBtn');
      const downBtn = document.getElementById('modalDownvoteBtn');

      scoreEl.textContent = selectedConversion.score;
      scoreEl.className = 'vote-score';
      if (selectedConversion.score > 0) scoreEl.classList.add('positive');
      if (selectedConversion.score < 0) scoreEl.classList.add('negative');

      upBtn.classList.toggle('active', selectedConversion.userVote === 1);
      downBtn.classList.toggle('active', selectedConversion.userVote === -1);
    }

    async function voteOnConversion(vote) {
      if (!currentUser) {
        showToast('Please log in to vote', 'info');
        return;
      }

      if (!selectedConversion) return;

      const newVote = selectedConversion.userVote === vote ? 0 : vote;

      try {
        const response = await fetch(`/api/community/conversions/${selectedConversion.id}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vote: newVote })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Vote failed');
        }

        const data = await response.json();

        selectedConversion.userVote = data.userVote;
        selectedConversion.score = data.score;

        // Update in list if exists
        const listConv = communityConversions.find(c => c.id === selectedConversion.id);
        if (listConv) {
          listConv.userVote = data.userVote;
          listConv.score = data.score;
          listConv.upvotes = data.upvotes;
          listConv.downvotes = data.downvotes;
        }

        updateModalVotes();
        renderCommunityList();

      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function copyModalJSON() {
      if (!selectedConversion) return;
      navigator.clipboard.writeText(JSON.stringify(selectedConversion.data, null, 2))
        .then(() => showToast('JSON copied to clipboard!', 'success'))
        .catch(() => showToast('Failed to copy', 'error'));
    }

    function addModalToLibrary() {
      if (!selectedConversion) return;

      try {
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const data = { ...selectedConversion.data, _userCreated: true };

        const existing = existingLibrary.findIndex(item => item.id === data.id);
        if (existing >= 0) {
          existingLibrary[existing] = data;
          showToast('Updated in library!', 'success');
        } else {
          existingLibrary.push(data);
          showToast('Added to library!', 'success');
        }

        localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
      } catch (err) {
        showToast('Could not add to library: ' + err.message, 'error');
      }
    }

    function addModalToGroup() {
      if (!selectedConversion) return;

      // First add to library if not already there
      try {
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const data = { ...selectedConversion.data, _userCreated: true };

        const existing = existingLibrary.findIndex(item => item.id === data.id);
        if (existing < 0) {
          existingLibrary.push(data);
          localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
        }
      } catch (err) {
        console.error('Failed to add to library:', err);
      }

      // Then open group selection modal
      addAdversaryToGroup(selectedConversion.data);
    }

    function copyShareLink() {
      if (!selectedConversion) return;
      const url = `${window.location.origin}/community/${selectedConversion.id}`;
      navigator.clipboard.writeText(url)
        .then(() => showToast('Share link copied!', 'success'))
        .catch(() => showToast('Failed to copy link', 'error'));
    }

    function copyShareLinkFor(conversionId) {
      const url = `${window.location.origin}/community/${conversionId}`;
      navigator.clipboard.writeText(url)
        .then(() => showToast('Share link copied!', 'success'))
        .catch(() => showToast('Failed to copy link', 'error'));
    }

    function reportConversion() {
      if (!selectedConversion) return;
      if (!currentUser) {
        showToast('Please log in to report content', 'info');
        return;
      }
      // For now, just show a message. In a full implementation, this would send to an API
      showToast('Report submitted. Thank you for helping keep the community safe.', 'success');
    }

    // ==================== COMMUNITY FILTERS ====================
    let communityFilterMode = 'all';

    function setCommunityFilter(mode) {
      communityFilterMode = mode;
      communityPage = 1;

      // Update active state
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === mode);
      });

      if (mode === 'mine') {
        loadMySubmissions();
      } else {
        loadCommunityConversions();
      }
    }

    async function loadMySubmissions() {
      const listEl = document.getElementById('communityList');
      listEl.innerHTML = `
        <div class="community-loading">
          <div class="loading-spinner"></div>
          <span>Loading your submissions...</span>
        </div>
      `;

      try {
        const response = await fetch('/api/community/my-submissions');
        if (!response.ok) throw new Error('Failed to load');

        const data = await response.json();
        communityConversions = data.conversions || [];
        communityTotalPages = 1;

        if (communityConversions.length === 0) {
          listEl.innerHTML = `
            <div class="community-empty">
              <h3>No submissions yet</h3>
              <p>Convert a stat block and click "Share to Community" to get started!</p>
            </div>
          `;
        } else {
          renderCommunityList();
        }

        document.getElementById('communityPagination').classList.add('hidden');

      } catch (err) {
        listEl.innerHTML = `
          <div class="community-empty">
            <p>Could not load your submissions.</p>
          </div>
        `;
      }
    }

    // ==================== URL ROUTING ====================
    function handleUrlRouting() {
      const path = window.location.pathname;

      // Handle /community/:id routes
      const communityMatch = path.match(/^\/community\/(.+)$/);
      if (communityMatch) {
        const conversionId = communityMatch[1];
        navigateTo('community');
        // Wait for community page to load, then open modal
        setTimeout(() => openCommunityModal(conversionId), 100);
        return;
      }
    }

    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      if (e.state?.conversionId) {
        openCommunityModal(e.state.conversionId);
      } else {
        closeCommunityModal();
      }
    });

    // ==================== SHARE TO COMMUNITY ====================
    async function shareToCommunity() {
      if (!currentUser) {
        showToast('Please log in to share conversions', 'info');
        return;
      }

      if (!currentConverted) {
        showToast('Nothing to share. Convert a stat block first.', 'error');
        return;
      }

      try {
        const response = await fetch('/api/community/conversions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: currentConverted.name,
            tier: currentConverted.tier,
            advType: currentConverted.advType,
            sourceSystem: detectedSystem,
            data: getExportObject()
          })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to share');
        }

        showToast('Shared to community library!', 'success');

        // Reload if on community tab
        if (communityLoaded) {
          communityPage = 1;
          loadCommunityConversions();
        }

      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // Close modals on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const communityModal = document.getElementById('communityModal');
        const loginModal = document.getElementById('loginModal');

        if (communityModal && !communityModal.classList.contains('hidden')) {
          closeCommunityModal();
        }
        if (loginModal && !loginModal.classList.contains('hidden')) {
          closeLoginModal();
        }
      }
    });
  </script>
</body>
</html>
