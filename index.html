<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daggerheart Adversary Converter</title>
  <!-- Google Fonts - Daggerheart-inspired typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto+Slab:wght@400;500;700&family=Source+Sans+3:ital,wght@0,400;0,600;0,700;0,900;1,400&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      /* Colors */
      --bg-dark: #1a1a2e;
      --bg-card: #16213e;
      --bg-input: #0f0f23;
      --text-primary: #e4e4e7;
      --text-secondary: #c4c4cc;
      --accent: #c9a227;
      --accent-rgb: 201, 162, 39;
      --accent-hover: #e4b82e;
      --accent-secondary: #6366f1;
      --accent-secondary-hover: #818cf8;
      --border: #333355;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --focus-ring: 0 0 0 2px var(--bg-dark), 0 0 0 4px var(--accent);

      /* Typography - Daggerheart-inspired fonts */
      --font-display: 'Bebas Neue', 'Impact', sans-serif;
      --font-body: 'Source Sans 3', 'Segoe UI', system-ui, sans-serif;
      --font-slab: 'Roboto Slab', Georgia, serif;
    }

    /* Light mode - Daggerheart Rulebook Style */
    :root.light-mode {
      --bg-dark: #f6f6ef;
      --bg-card: #fafaf6;
      --bg-input: #e8e5df;
      --text-primary: #221f1f;
      --text-secondary: #444444;
      --accent: #ad2423;
      --accent-rgb: 173, 36, 35;
      --accent-hover: #c62828;
      --accent-secondary: #e1b74a;
      --accent-secondary-hover: #d4a93d;
      --border: #d4cfc3;
      --focus-ring: 0 0 0 2px var(--bg-card), 0 0 0 4px var(--accent);
      --card-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
    }

    /* Typography - Daggerheart Rulebook Style (both modes) */
    /* Display font for major headers */
    h1, h2, h3,
    .page-header h1,
    .community-header h1,
    .my-library-header h1,
    .admin-header h1 {
      font-family: var(--font-display);
      text-transform: uppercase;
      font-weight: 400; /* Bebas Neue only has one weight */
    }

    /* H1 specific styling */
    h1 {
      font-size: 2.5rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
      letter-spacing: 0.04em;
    }

    /* H2 styling */
    h2 {
      font-size: 1.75rem;
      letter-spacing: 0.03em;
    }

    /* H3 styling */
    h3 {
      font-size: 1.35rem;
      letter-spacing: 0.02em;
    }

    /* Slab font for H4-H6 (subheadings/labels) */
    h4, h5, h6 {
      font-family: var(--font-slab);
      text-transform: none;
      font-weight: 500;
    }

    :root.light-mode .json-output {
      color: #1e40af;
    }

    :root.light-mode .panel {
      background: var(--bg-card);
      box-shadow: var(--card-shadow);
      border-color: var(--border);
    }

    :root.light-mode .community-item {
      box-shadow: var(--card-shadow);
    }

    :root.light-mode .stat-card {
      background: var(--bg-card);
      box-shadow: var(--card-shadow);
      border-color: var(--border);
    }

    :root.light-mode .dropdown-menu {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      background: var(--bg-card);
    }

    :root.light-mode .navbar {
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
    }

    /* Vignette effect on page edges */
    :root.light-mode body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 9998;
      box-shadow: inset 0 0 150px rgba(34, 31, 31, 0.08);
    }

    :root.light-mode .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
    }

    :root.light-mode .btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    :root.light-mode .nav-link.active {
      color: var(--accent);
      border-color: var(--accent);
    }

    :root.light-mode .mode-btn.active {
      background: var(--accent);
    }

    :root.light-mode .filter-btn.active {
      background: var(--accent);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    body {
      font-family: var(--font-body);
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      position: relative;
    }

    #converterPage.active::after {
      content: '';
      position: fixed;
      bottom: 0;
      left: 0;
      width: 90vw;
      height: 90vw;
      background-image: url('assets/monster-faceoff.webp');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: bottom left;
      opacity: 0.04;
      pointer-events: none;
      z-index: 0;
    }

    :root.light-mode #converterPage.active::after {
      opacity: 0.10;
    }

    /* Navigation Bar */
    .navbar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 60px;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--accent);
      font-family: var(--font-display);
      font-weight: 400;
      font-size: 1.5rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .navbar-brand-icon {
      font-size: 1.5rem;
    }

    .navbar-nav {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.95rem;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .nav-link:hover {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    .nav-link.active {
      color: var(--accent);
      background: var(--bg-input);
      border-color: var(--accent);
    }

    .nav-link svg {
      width: 18px;
      height: 18px;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .coffee-link {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      opacity: 0.7;
      transition: all 0.2s;
    }

    .coffee-link:hover {
      color: #ffdd00;
      opacity: 1;
    }

    .faq-link {
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: var(--text-secondary);
      opacity: 0.7;
      transition: all 0.2s;
      cursor: pointer;
      padding: 0.25rem;
    }

    .faq-link:hover {
      color: var(--accent);
      opacity: 1;
    }

    .btn-login {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1.25rem;
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-login:hover {
      background: var(--accent-hover);
    }

    /* Login Modal */
    .login-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .login-modal.hidden {
      display: none;
    }

    .login-modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      overflow: hidden;
    }

    .login-modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .login-modal-header h2 {
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .login-modal-header p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .login-modal-body {
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .login-modal-footer {
      padding: 1rem 1.5rem;
      background: var(--bg-input);
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Keyboard Shortcuts Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .keyboard-modal {
      background: var(--bg-card);
      border-radius: 12px;
      width: 100%;
      max-width: 450px;
      max-height: 90vh;
      overflow: auto;
    }

    .keyboard-modal .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .keyboard-modal .modal-header h2 {
      font-size: 1.25rem;
      margin: 0;
    }

    .keyboard-modal .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .keyboard-modal .modal-close:hover {
      color: var(--text-primary);
    }

    .keyboard-modal .modal-body {
      padding: 1.5rem;
    }

    .shortcut-section {
      margin-bottom: 1.5rem;
    }

    .shortcut-section:last-child {
      margin-bottom: 0;
    }

    .shortcut-section h3 {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
    }

    .shortcut-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
    }

    .shortcut-row kbd {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.2rem 0.5rem;
      font-family: inherit;
      font-size: 0.85rem;
      margin-right: 0.25rem;
    }

    .shortcut-row span {
      color: var(--text-secondary);
    }

    .btn-sso {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.875rem 1.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-sso:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .btn-sso svg {
      width: 24px;
      height: 24px;
    }

    .btn-sso.discord {
      border-color: #5865F2;
    }

    .btn-sso.discord:hover {
      background: rgba(88, 101, 242, 0.1);
    }

    /* Page Views */
    .page-view {
      display: none;
    }

    .page-view.active {
      display: block;
    }

    /* Community Library Page */
    .community-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    #communityPage.active::after {
      content: '';
      position: fixed;
      bottom: 0;
      left: 0;
      width: 90vw;
      height: 90vw;
      background-image: url('assets/friends.webp');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: bottom left;
      opacity: 0.04;
      pointer-events: none;
      z-index: 0;
    }

    :root.light-mode #communityPage.active::after {
      opacity: 0.10;
    }

    .community-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .community-header h1 {
      color: var(--accent);
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .community-header p {
      color: var(--text-secondary);
    }

    /* Admin Page Styles */
    .admin-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .admin-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .admin-header h1 {
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .admin-header p {
      color: var(--text-secondary);
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      text-align: center;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-family: var(--font-slab);
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      font-weight: 500;
    }

    .admin-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }

    .admin-tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px 6px 0 0;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .admin-tab:hover {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    .admin-tab.active {
      color: var(--accent);
      background: var(--bg-card);
      border-color: var(--border);
      border-bottom-color: var(--bg-card);
      margin-bottom: -1px;
    }

    .admin-tab-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 0 8px 8px 8px;
      padding: 1rem;
    }

    .admin-toolbar {
      margin-bottom: 1rem;
    }

    .admin-search {
      max-width: 400px;
    }

    /* Analytics Section */
    .admin-analytics {
      margin-bottom: 1.5rem;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 900px) {
      .analytics-grid {
        grid-template-columns: 1fr;
      }
    }

    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }

    .chart-card h3 {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .chart-container {
      height: 150px;
      position: relative;
    }

    .chart-canvas {
      width: 100%;
      height: 100%;
    }

    .chart-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .suspicious-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
    }

    .suspicious-section h3 {
      font-size: 0.9rem;
      color: var(--error);
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .suspicious-section h3::before {
      content: '⚠';
    }

    .suspicious-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    @media (max-width: 900px) {
      .suspicious-grid {
        grid-template-columns: 1fr;
      }
    }

    .suspicious-card {
      background: var(--bg-input);
      border-radius: 6px;
      padding: 0.75rem;
    }

    .suspicious-card h4 {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .suspicious-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .suspicious-card li {
      font-size: 0.85rem;
      padding: 0.25rem 0;
      color: var(--text-primary);
    }

    .suspicious-card .empty {
      font-size: 0.8rem;
      color: var(--success);
      font-style: italic;
    }

    .analytics-toggle {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 0.5rem;
    }

    .analytics-toggle button {
      background: var(--bg-input);
      border: 1px solid var(--border);
      padding: 0.4rem 0.75rem;
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .analytics-toggle button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .admin-table-container {
      overflow-x: auto;
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .admin-table th,
    .admin-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .admin-table th {
      background: var(--bg-input);
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .admin-table td {
      color: var(--text-primary);
    }

    .admin-table tr:hover td {
      background: var(--bg-input);
    }

    .admin-table .loading {
      text-align: center;
      color: var(--text-secondary);
      padding: 2rem;
    }

    .admin-author {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .admin-author img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }

    .admin-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .admin-badge.published {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .admin-badge.unpublished {
      background: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }

    .admin-badge.banned {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .admin-badge.admin {
      background: rgba(201, 162, 39, 0.2);
      color: var(--accent);
    }

    .admin-badge.active {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .admin-badge-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      font-size: 0.7rem;
      font-weight: 600;
      background: var(--error);
      color: white;
      border-radius: 9px;
      margin-left: 0.4rem;
    }

    .admin-badge-count:empty {
      display: none;
    }

    .admin-report-reason {
      max-width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .admin-actions {
      display: flex;
      gap: 0.5rem;
    }

    .admin-btn {
      padding: 0.35rem 0.6rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg-input);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .admin-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .admin-btn.danger {
      color: #f44336;
    }

    .admin-btn.danger:hover {
      background: rgba(244, 67, 54, 0.1);
      border-color: #f44336;
    }

    .admin-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .admin-pagination span {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    /* My Library Page Styles - Folder-based Drag & Drop */
    .my-library-page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      position: relative;
    }

    #myLibraryPage.active .my-library-page::after {
      content: '';
      position: fixed;
      bottom: 0;
      right: 0;
      width: 90vw;
      height: 90vw;
      background-image: url('assets/goblin-wizard-studying-up.webp');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: bottom right;
      opacity: 0.04;
      pointer-events: none;
      z-index: 0;
    }

    :root.light-mode #myLibraryPage.active .my-library-page::after {
      opacity: 0.10;
    }

    .my-library-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .my-library-header h1 {
      color: var(--accent);
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .my-library-header p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .my-library-container {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 1rem;
      min-height: 550px;
    }

    /* Folders Sidebar */
    .folders-sidebar {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .folders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
    }

    .folders-title {
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .folder-add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .folder-add-btn:hover {
      background: var(--accent-hover);
      transform: scale(1.05);
    }

    .folders-tree {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .folders-list {
      padding-left: 0.5rem;
      margin: 0.25rem 0;
    }

    .folder-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text-primary);
      border: 2px solid transparent;
      margin-bottom: 2px;
    }

    .folder-item:hover {
      background: var(--bg-input);
    }

    .folder-item.active {
      background: var(--bg-input);
      border-color: var(--accent);
    }

    .folder-item.drag-over {
      background: rgba(201, 162, 39, 0.15);
      border-color: var(--accent);
      border-style: dashed;
    }

    .folder-icon {
      display: flex;
      align-items: center;
      color: var(--accent);
      flex-shrink: 0;
    }

    .folder-name {
      flex: 1;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .folder-name-input {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--accent);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      color: var(--text-primary);
      font-size: 0.9rem;
      outline: none;
    }

    .folder-count {
      font-size: 0.75rem;
      color: var(--text-secondary);
      background: var(--bg-dark);
      padding: 0.15rem 0.5rem;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    .folder-root {
      font-weight: 500;
    }

    .folder-ungrouped {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }

    .folders-help {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--border);
      background: var(--bg-input);
    }

    .folders-help small {
      color: var(--text-secondary);
      font-size: 0.75rem;
    }

    /* Library Content Area */
    .library-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .library-content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
      gap: 1rem;
      flex-wrap: wrap;
    }

    .library-title-section {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }

    .library-title-section h2 {
      color: var(--accent);
      font-size: 1.1rem;
      margin: 0;
      font-weight: 900;
    }

    .library-item-count {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .library-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .library-search {
      padding: 0.4rem 0.75rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.85rem;
      width: 180px;
    }

    .library-search:focus {
      outline: none;
      border-color: var(--accent);
    }

    .folder-edit-actions {
      display: flex;
      gap: 0.25rem;
    }

    .icon-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: var(--bg-dark);
      color: var(--text-primary);
      border-color: var(--text-secondary);
    }

    .icon-btn-danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      border-color: var(--error);
    }

    .library-items-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      position: relative;
    }

    .library-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 0.75rem;
    }

    .library-empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      text-align: center;
      padding: 2rem;
    }

    .library-empty-state.hidden {
      display: none;
    }

    .empty-icon-large {
      margin-bottom: 1rem;
      color: var(--text-secondary);
    }

    .empty-title {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .empty-hint {
      font-size: 0.85rem;
      opacity: 0.7;
      max-width: 300px;
    }

    /* Draggable Adversary Cards */
    .adversary-card {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.875rem;
      cursor: grab;
      transition: all 0.15s;
      position: relative;
    }

    .adversary-card:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .adversary-card:active {
      cursor: grabbing;
    }

    .adversary-card.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }

    .adversary-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.4rem;
    }

    .adversary-card-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
      line-height: 1.3;
      flex: 1;
      margin-right: 0.5rem;
    }

    .adversary-card-tier {
      background: var(--accent);
      color: var(--bg-dark);
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .adversary-card-type {
      color: var(--text-secondary);
      font-size: 0.8rem;
      margin-bottom: 0.4rem;
    }

    .adversary-card-stats {
      display: flex;
      gap: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .adversary-card-drag-hint {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      color: var(--text-secondary);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .adversary-card:hover .adversary-card-drag-hint {
      opacity: 0.5;
    }

    /* Drag Ghost Styling */
    .drag-ghost {
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Add to Group Modal */
    .modal-small {
      max-width: 400px;
    }

    .add-to-group-name {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .group-select-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 250px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }

    .group-select-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .group-select-item:hover {
      border-color: var(--accent);
      background: var(--bg-dark);
    }

    .create-new-group-inline {
      display: flex;
      gap: 0.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .create-new-group-inline input {
      flex: 1;
    }

    @media (max-width: 900px) {
      .my-library-container {
        grid-template-columns: 200px 1fr;
      }
    }

    @media (max-width: 768px) {
      .my-library-container {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .folders-sidebar {
        max-height: 200px;
      }

      .library-search {
        width: 140px;
      }
    }

    @media (max-width: 768px) {
      .navbar-inner {
        flex-wrap: wrap;
        height: auto;
        padding: 0.75rem 0;
        gap: 0.75rem;
      }

      .navbar-brand {
        font-size: 1.1rem;
      }

      .navbar-nav {
        order: 3;
        width: 100%;
        justify-content: center;
      }

      .nav-link {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
      }

      .nav-link span {
        display: none;
      }

      .navbar-right {
        gap: 0.5rem;
      }

      .community-page {
        padding: 1rem;
      }

      .my-library-page {
        padding: 1rem;
      }

      .my-library-container {
        grid-template-columns: 1fr;
      }

      .groups-sidebar {
        order: 1;
      }

      .groups-list {
        max-height: 200px;
      }

      .group-content {
        order: 2;
      }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--accent);
    }

    .header-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      position: relative;
    }

    h1 {
      font-size: 2rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    /* Theme Toggle */
    .theme-toggle {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .theme-toggle:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .theme-icon-light {
      display: none;
    }

    :root.light-mode .theme-icon-dark {
      display: none;
    }

    :root.light-mode .theme-icon-light {
      display: inline;
    }

    @media (max-width: 768px) {
      .header-row {
        flex-direction: column;
      }

      .theme-toggle {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .keyboard-hints {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }

    .keyboard-hint {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    kbd {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.15rem 0.4rem;
      font-family: monospace;
      font-size: 0.75rem;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Tablet breakpoint */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      .keyboard-hints {
        display: none;
      }

      .panel {
        padding: 1rem;
      }

      .btn {
        min-height: 44px;
        padding: 0.75rem 1rem;
      }

      .btn-small {
        min-height: 44px;
        padding: 0.5rem 0.75rem;
      }

      .btn-icon {
        min-width: 44px;
        min-height: 44px;
        padding: 0.5rem;
      }

      .tab {
        min-height: 44px;
        padding: 0.75rem 1rem;
      }

      .mode-btn {
        min-height: 44px;
        padding: 0.75rem;
      }

      .sample-buttons {
        display: none;
      }

      .stat-grid {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 0.75rem;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .recent-menu {
        max-width: calc(100vw - 2rem);
        right: auto;
        left: 0;
      }

      .panel-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .panel-header .btn-group {
        width: 100%;
        flex-wrap: wrap;
      }

      .undo-toolbar {
        margin-left: 0;
      }
    }

    /* Small phone breakpoint */
    @media (max-width: 480px) {
      .container {
        padding: 0.75rem;
      }

      h1 {
        font-size: 1.25rem;
      }

      .subtitle {
        font-size: 0.85rem;
      }

      .panel {
        padding: 0.75rem;
        border-radius: 8px;
      }

      .stat-block {
        padding: 1rem;
      }

      .stat-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .tabs {
        gap: 0.25rem;
      }

      .tab {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        flex: 1;
        text-align: center;
      }

      .btn-group {
        width: 100%;
      }

      .btn-group .btn {
        flex: 1;
        justify-content: center;
      }

      .feature-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .feature-actions {
        opacity: 1;
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
      }

      .feature {
        position: relative;
      }

      textarea {
        min-height: 200px;
        font-size: 0.85rem;
      }

      .live-parse-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .confidence-legend {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
    }

    .panel {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid var(--border);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .panel-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Focus indicators for accessibility */
    *:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    button:focus-visible, a:focus-visible, input:focus-visible,
    select:focus-visible, textarea:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    /* Ensure all interactive elements have visible focus */
    .feature-type:focus-visible,
    .tag:focus-visible,
    .collapsible-header:focus-visible,
    .batch-item-header:focus-visible,
    .image-placeholder:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    /* Drop zone */
    .drop-zone {
      position: relative;
      width: 100%;
    }

    .drop-zone.drag-over textarea {
      border-color: var(--accent);
      background: rgba(201, 162, 39, 0.1);
    }

    .drop-zone.drag-over::after {
      content: 'Drop file here';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(201, 162, 39, 0.2);
      border: 2px dashed var(--accent);
      border-radius: 8px;
      font-size: 1.2rem;
      color: var(--accent);
      pointer-events: none;
    }

    textarea {
      width: 100%;
      min-height: 250px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      color: var(--text-primary);
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9rem;
      resize: vertical;
      transition: border-color 0.2s, background 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    textarea::placeholder {
      color: var(--text-secondary);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-dark);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text-primary);
    }

    .btn-secondary:hover:not(:disabled) {
      background: #444466;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #16a34a;
    }

    .btn.copied {
      background: var(--success) !important;
      color: white !important;
      transform: scale(1.05);
      transition: all 0.2s ease;
    }

    .btn-small {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
    }

    .btn-icon {
      padding: 0.4rem;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-icon:hover:not(:disabled) {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Action Dropdowns */
    .output-actions {
      align-items: center;
    }

    .action-dropdown {
      position: relative;
      display: flex;
    }

    .action-dropdown .btn:first-child {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .action-dropdown .dropdown-toggle {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      padding: 0.4rem 0.5rem;
      margin-left: -1px;
      min-width: unset;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 100;
      min-width: 140px;
      display: none;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-menu-right {
      left: auto;
      right: 0;
    }

    .dropdown-menu button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.6rem 1rem;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      text-align: left;
      transition: background 0.15s;
    }

    .dropdown-menu button:hover {
      background: var(--bg-input);
    }

    .dropdown-menu button:first-child {
      border-radius: 6px 6px 0 0;
    }

    .dropdown-menu button:last-child {
      border-radius: 0 0 6px 6px;
    }

    .dropdown-menu button span {
      font-size: 1rem;
    }

    .btn-icon-inline {
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.4rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .form-input, .form-select {
      width: 100%;
      padding: 0.6rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Mode toggle */
    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .mode-btn {
      flex: 1;
      padding: 0.5rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .mode-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }

    .mode-btn:hover:not(.active) {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Recent conversions dropdown */
    .recent-dropdown {
      position: relative;
      display: inline-block;
    }

    .recent-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      min-width: 200px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-top: 0.25rem;
      z-index: 100;
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }

    .recent-menu.show {
      display: block;
    }

    .recent-item {
      padding: 0.6rem 0.8rem;
      cursor: pointer;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recent-item:last-child {
      border-bottom: none;
    }

    .recent-item:hover {
      background: var(--bg-input);
    }

    .recent-item-name {
      font-weight: 500;
    }

    .recent-item-tier {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .recent-item-delete {
      color: var(--text-secondary);
      padding: 0.2rem;
      cursor: pointer;
    }

    .recent-item-delete:hover {
      color: var(--error);
    }

    /* Live Parse Preview */
    .live-parse {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-input);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .live-parse-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .live-parse-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .parse-field {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.6rem;
      background: var(--bg-card);
      border-radius: 4px;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .parse-field-label {
      color: var(--text-secondary);
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .parse-field-value {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }

    /* Confidence Badges - now with shape and text for accessibility */
    .confidence-badge {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      color: white;
    }

    .confidence-high {
      background: var(--success);
      border-radius: 50%; /* Circle = good */
    }
    .confidence-high::after {
      content: '✓';
      font-size: 10px;
    }

    .confidence-medium {
      background: var(--warning);
      border-radius: 2px; /* Square = uncertain */
    }
    .confidence-medium::after {
      content: '~';
      font-size: 12px;
    }

    .confidence-low {
      background: var(--error);
      border-radius: 0;
      clip-path: polygon(50% 0%, 100% 100%, 0% 100%); /* Triangle = warning */
      width: 14px;
      height: 12px;
    }
    .confidence-low::after {
      content: '!';
      font-size: 8px;
      margin-top: 2px;
    }

    .confidence-legend {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.75rem;
    }

    .confidence-legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    /* Adjustments */
    .adjustments-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .adjustments-title {
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
      color: var(--accent);
    }

    /* Undo/Redo toolbar */
    .undo-toolbar {
      display: flex;
      gap: 0.25rem;
      margin-left: auto;
    }

    .parser-error {
      background: var(--bg-input);
      border: 2px solid var(--error);
      border-radius: 8px;
      padding: 1.5rem;
    }

    .parser-error h3 {
      color: var(--error);
      margin-bottom: 1rem;
    }

    .parser-error h4 {
      color: var(--text-primary);
      margin: 1rem 0 0.5rem;
      font-size: 0.95rem;
    }

    .parser-error p {
      margin-bottom: 0.5rem;
    }

    .parser-error ul {
      margin-left: 1.5rem;
      color: var(--text-secondary);
    }

    .parser-error li {
      margin-bottom: 0.25rem;
    }

    /* Daggerheart Rulebook-Style Stat Block (Modal) */
    .dh-stat-block {
      background: #f5f0e6;
      border: 2px solid #2d2d2d;
      border-radius: 4px;
      font-family: 'Segoe UI', system-ui, sans-serif;
      color: #2d2d2d;
      overflow: hidden;
    }

    .dh-stat-block-header {
      background: #2d2d2d;
      background: linear-gradient(135deg, #2d2d2d 0%, var(--type-color, #2d2d2d) 100%);
      color: #fff;
      padding: 1rem 1.25rem;
      position: sticky;
      top: 0;
      z-index: 5;
      border-bottom: 3px solid #e1b74a;
      transition: box-shadow 0.15s ease-out;
      /* Fixed height to prevent layout shift on compact */
      min-height: 72px;
      box-sizing: border-box;
    }

    .dh-stat-block-header.compact {
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .dh-stat-block-header.compact .dh-stat-block-name {
      font-size: 1.1rem;
    }

    .dh-stat-block-header.compact .dh-stat-block-tier {
      font-size: 0.75rem;
    }

    .dh-stat-block-header.compact .dh-header-main {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }

    /* Compact stats bar in header on scroll */
    .dh-compact-stats {
      display: none;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      flex-shrink: 0;
      color: rgba(255,255,255,0.9);
    }

    .dh-stat-block-header.compact .dh-compact-stats {
      display: flex;
    }

    .dh-compact-stat {
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .dh-compact-stat strong {
      color: #fff;
      font-weight: 600;
    }

    .dh-compact-stat i {
      color: #fff;
      font-size: 0.8em;
      opacity: 0.9;
    }

    .dh-compact-divider {
      color: rgba(255,255,255,0.4);
    }

    .dh-header-main {
      flex: 1;
      min-width: 0;
    }

    .dh-stat-block-name {
      font-size: 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0;
    }

    .dh-stat-block-tier {
      font-size: 0.9rem;
      color: #ccc;
      font-style: italic;
      font-family: 'Roboto Slab', var(--font-slab);
      letter-spacing: 0.03em;
      font-weight: 400;
    }

    /* Adversary type colors */
    .dh-stat-block-header[data-type="bruiser"] { --type-color: #8B2635; }
    .dh-stat-block-header[data-type="horde"] { --type-color: #B5651D; }
    .dh-stat-block-header[data-type="leader"] { --type-color: #6B3FA0; }
    .dh-stat-block-header[data-type="minion"] { --type-color: #4a4a4a; }
    .dh-stat-block-header[data-type="ranged"] { --type-color: #2E5984; }
    .dh-stat-block-header[data-type="skulk"] { --type-color: #2D5A3D; }
    .dh-stat-block-header[data-type="social"] { --type-color: #1D6B6B; }
    .dh-stat-block-header[data-type="solo"] { --type-color: #8B7500; }
    .dh-stat-block-header[data-type="standard"] { --type-color: #3d3d3d; }
    .dh-stat-block-header[data-type="support"] { --type-color: #7B3F7B; }

    .dh-stat-block-body {
      padding: 1rem 1.25rem;
    }

    .dh-stat-block-desc {
      font-style: italic;
      color: #444;
      margin-bottom: 0.75rem;
      line-height: 1.5;
    }

    .dh-stat-block-motives {
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }

    .dh-stat-block-motives strong {
      font-weight: 600;
    }

    .dh-stat-block-stats-line {
      font-family: var(--font-body);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      line-height: 1.5;
      padding: 0.4rem 0.6rem;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 4px;
      border-left: 3px solid var(--accent);
    }

    .dh-stat-block-stats-line .label {
      font-family: var(--font-slab);
      font-weight: 600;
      color: #1a1a1a;
    }

    .dh-stat-block-stats-line .separator {
      color: var(--accent);
      margin: 0 0.5rem;
      font-weight: 300;
    }

    .dh-stat-block-stats-line .stat-item {
      display: inline-block;
      white-space: nowrap;
    }

    /* Damage Tracker - Daggerheart Character Sheet Style */
    .damage-tracker-container {
      container-type: inline-size;
      container-name: damage-tracker;
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 1rem 0 2.5rem 0;
    }

    .damage-scale-wrapper {
      display: flex;
      justify-content: center;
    }

    /* Container query responsive scaling */
    @container damage-tracker (max-width: 700px) { .damage-scale-wrapper { zoom: 0.85; } }
    @container damage-tracker (max-width: 600px) { .damage-scale-wrapper { zoom: 0.75; } }
    @container damage-tracker (max-width: 500px) { .damage-scale-wrapper { zoom: 0.65; } }
    @container damage-tracker (max-width: 400px) { .damage-scale-wrapper { zoom: 0.55; } }
    @container damage-tracker (max-width: 300px) { .damage-scale-wrapper { zoom: 0.45; } }

    .damage-cards-row {
      display: flex;
      align-items: center;
      position: relative;
      flex-shrink: 0;
    }

    .damage-card-wrapper {
      position: relative;
      z-index: 2;
    }

    .damage-card-container {
      position: relative;
      width: 180px;
      height: 86px;
    }

    .damage-card-body {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .damage-card-body svg {
      width: 100%;
      height: 100%;
    }

    .damage-card-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      font-family: var(--font-display);
      font-size: 24px;
      font-weight: 400;
      line-height: 1.2;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .damage-card-footer {
      position: absolute;
      bottom: -26px;
      left: 18px;
      right: 18px;
      text-align: center;
    }

    .damage-card-footer-text {
      color: var(--text-secondary);
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 500;
      margin: 0;
    }

    /* Connector rectangles between cards */
    .damage-connector {
      width: 100px;
      height: 50px;
      background: unset;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 -29px;
      z-index: 1;
      position: relative;
      border: 3px solid #5f6975;
    }

    .damage-connector-number {
      color: #5F6975;
      font-family: var(--font-display);
      font-size: 36px;
      font-weight: 400;
    }

    :root.light-mode .damage-card-footer-text {
      color: #4a4a4a;
    }

    /* HP and Stress boxes */
    .dh-vitals-row {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin: 0.75rem 0;
    }

    .dh-vital-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem 1rem;
      background: rgba(0,0,0,0.03);
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.08);
      min-width: 70px;
    }

    .dh-vital-value {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--accent);
      line-height: 1;
    }

    .dh-vital-label {
      font-family: var(--font-slab);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .dh-vital-box.hp .dh-vital-value {
      color: #dc2626;
    }

    .dh-vital-box.stress .dh-vital-value {
      color: #7c3aed;
    }

    .dh-vital-box.difficulty .dh-vital-value {
      color: var(--accent);
    }

    /* Light mode adjustments */
    :root.light-mode .dh-threshold-track,
    :root.light-mode .dh-vital-box {
      background: rgba(139, 115, 85, 0.08);
      border-color: rgba(139, 115, 85, 0.15);
    }

    :root.light-mode .dh-threshold-value {
      background: var(--accent);
    }

    /* Dark mode adjustments */
    :root:not(.light-mode) .dh-threshold-track,
    :root:not(.light-mode) .dh-vital-box {
      background: rgba(201, 162, 39, 0.08);
      border-color: rgba(201, 162, 39, 0.2);
    }

    :root:not(.light-mode) .dh-threshold-label,
    :root:not(.light-mode) .dh-vital-label {
      color: var(--text-secondary);
    }

    /* Responsive adjustments for vitals */
    @media (max-width: 480px) {
      .dh-vitals-row {
        gap: 0.75rem;
      }

      .dh-vital-box {
        padding: 0.4rem 0.75rem;
        min-width: 60px;
      }

      .dh-vital-value {
        font-size: 1.25rem;
      }
    }

    .dh-stat-block-experience {
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
      padding: 0.3rem 0;
      font-style: italic;
    }

    .dh-stat-block-experience strong {
      font-family: var(--font-slab);
      font-weight: 600;
      font-style: normal;
    }

    .dh-stat-block-features {
      border-top: 2px solid #2d2d2d;
      margin-top: 1rem;
      padding-top: 1rem;
      position: relative;
    }

    /* Decorative corner on features section */
    .dh-stat-block-features::before {
      content: "◆";
      position: absolute;
      top: -0.5rem;
      left: 50%;
      transform: translateX(-50%);
      background: #f5f0e6;
      padding: 0 0.5rem;
      color: #2d2d2d;
      font-size: 0.6rem;
    }

    .dh-stat-block-features-title {
      font-family: 'Source Sans 3', var(--font-body);
      font-size: 1.2rem;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      color: #2d2d2d;
    }

    .dh-stat-block-feature {
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .dh-stat-block-feature:last-child {
      margin-bottom: 0;
    }

    .dh-stat-block-feature-name {
      font-family: var(--font-slab);
      font-weight: 700;
    }

    .dh-stat-block-feature-type {
      font-family: var(--font-slab);
      font-size: 0.7rem;
      font-weight: 500;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-left: 0.25rem;
      letter-spacing: 0.02em;
    }

    .dh-stat-block-feature-type::before {
      font-size: 0.8em;
    }

    .dh-stat-block-feature-type.action {
      background: linear-gradient(135deg, #dc2626, #991b1b);
      color: #fef2f2;
    }
    .dh-stat-block-feature-type.action::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      content: "\f0e7"; /* fa-bolt */
    }

    .dh-stat-block-feature-type.reaction {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #eff6ff;
    }
    .dh-stat-block-feature-type.reaction::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      content: "\f2ea"; /* fa-rotate-left */
    }

    .dh-stat-block-feature-type.passive {
      background: linear-gradient(135deg, #475569, #334155);
      color: #e2e8f0;
    }
    .dh-stat-block-feature-type.passive::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 400;
      content: "\f111"; /* fa-circle (regular/outline) */
    }

    .dh-stat-block-feature-type.fear {
      background: linear-gradient(135deg, #7c3aed, #5b21b6);
      color: #f5f3ff;
    }
    .dh-stat-block-feature-type.fear::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      content: "\f54c"; /* fa-skull */
    }

    .dh-stat-block-image {
      max-width: 180px;
      float: right;
      margin: 0 0 1rem 1rem;
      border-radius: 4px;
      border: 1px solid #d4cfc3;
    }

    .dh-stat-block-tags {
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid #d4cfc3;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .dh-stat-block-tag {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      background: rgba(0,0,0,0.08);
      border-radius: 3px;
      color: #555;
    }

    /* Card-style Modal (Community & Library) */
    .dh-modal-card {
      position: relative;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      border-radius: 6px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      scrollbar-width: thin;
      scrollbar-color: #e1b74a transparent;
    }

    /* Custom scrollbar for Webkit browsers */
    .dh-modal-card::-webkit-scrollbar {
      width: 8px;
    }

    .dh-modal-card::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
    }

    .dh-modal-card::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #e1b74a 0%, #c9a227 100%);
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    .dh-modal-card::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #f0c65a 0%, #d4b030 100%);
      background-clip: padding-box;
    }

    .dh-modal-card .dh-stat-block {
      border-radius: 6px 6px 0 0;
      overflow: visible; /* Override to allow sticky header */
    }

    .dh-modal-card .dh-stat-block-header {
      border-radius: 0;
    }

    /* When scrolled, remove border-radius and add solid color corners */
    .dh-modal-card .dh-stat-block-header.compact {
      border-radius: 0;
    }

    /* Ensure modal card has matching dark background at top to prevent white flash */
    .dh-modal-card {
      background: linear-gradient(to bottom, #2d2d2d 0, #2d2d2d 80px, #f5f0e6 80px);
    }

    /* Modal wrapper for positioning close button outside */
    .dh-modal-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 600px;
      width: 100%;
    }

    .dh-modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      z-index: 10;
      background: var(--accent);
      border: 2px solid rgba(255,255,255,0.3);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5rem;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .dh-modal-close:hover {
      background: #d4a84b;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .dh-modal-footer {
      background: #f5f0e6;
      border-top: 2px solid #2d2d2d;
      padding: 1rem 1.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
      border-radius: 0 0 6px 6px;
    }

    .dh-modal-votes {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .dh-modal-votes .vote-btn {
      background: #2d2d2d;
      color: #fff;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .dh-modal-votes .vote-btn:hover {
      background: #444;
    }

    .dh-modal-votes .vote-btn.active.upvote {
      background: #22c55e;
    }

    .dh-modal-votes .vote-btn.active.downvote {
      background: #ef4444;
    }

    .dh-modal-votes .vote-score {
      font-weight: 700;
      font-size: 1rem;
      min-width: 2rem;
      text-align: center;
      color: #2d2d2d;
    }

    .dh-modal-votes .vote-score.positive {
      color: #22c55e;
    }

    .dh-modal-votes .vote-score.negative {
      color: #ef4444;
    }

    .dh-modal-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .dh-modal-actions .btn {
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
      background: #2d2d2d;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dh-modal-actions .btn:hover {
      background: #444;
    }

    .dh-modal-actions .btn-save {
      background: #22c55e;
    }

    .dh-modal-actions .btn-save:hover {
      background: #16a34a;
    }

    .dh-modal-secondary {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 0.5rem;
      margin-top: 0.5rem;
      border-top: 1px solid #d4cfc3;
      font-size: 0.8rem;
      color: #666;
    }

    .dh-modal-author img {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 0.3rem;
    }

    .dh-modal-report {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      transition: all 0.2s;
    }

    .dh-modal-report:hover {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .dh-modal-secondary-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .dh-modal-delete {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 3px;
      transition: all 0.2s;
    }

    .dh-modal-delete:hover {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    @media (max-width: 500px) {
      .dh-modal-footer {
        flex-direction: column;
        align-items: stretch;
      }

      .dh-modal-votes {
        justify-content: center;
      }

      .dh-modal-actions {
        justify-content: center;
      }
    }

    /* Daggerheart Stat Block - Rulebook Style */
    .stat-block {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-input) 100%);
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 1.5rem;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Parchment style for light mode */
    :root.light-mode .stat-block {
      background: linear-gradient(135deg, #faf8f3 0%, #f5f0e6 50%, #ebe5d8 100%);
      border-color: #8b7355;
      box-shadow:
        0 4px 12px rgba(0,0,0,0.15),
        inset 0 0 60px rgba(139, 115, 85, 0.05);
    }

    /* Corner decorations for light mode */
    :root.light-mode .stat-block::before,
    :root.light-mode .stat-block::after {
      content: "◆";
      position: absolute;
      color: var(--accent);
      font-size: 0.75rem;
      opacity: 0.6;
    }
    :root.light-mode .stat-block::before {
      top: 0.5rem;
      left: 0.5rem;
    }
    :root.light-mode .stat-block::after {
      bottom: 0.5rem;
      right: 0.5rem;
    }

    .stat-block-header {
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.75rem;
      margin-bottom: 1rem;
      position: relative;
    }

    /* Decorative header underline */
    .stat-block-header::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--accent) 0%, transparent 100%);
    }

    .stat-block-name {
      font-family: var(--font-display);
      font-size: 1.8rem;
      font-weight: 400;
      color: var(--accent);
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .stat-block-name-input {
      font-family: var(--font-display);
      font-size: 1.8rem;
      font-weight: 400;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.02em;
      background: transparent;
      border: none;
      border-bottom: 1px dashed transparent;
      width: 100%;
      padding: 0;
      margin-bottom: 0.25rem;
      font-family: inherit;
    }

    .stat-block-name-input:hover,
    .stat-block-name-input:focus {
      border-bottom-color: var(--accent);
      outline: none;
    }

    .stat-block-type {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .stat-block-desc {
      font-style: italic;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    /* Image Section */
    .stat-block-image-section {
      margin-bottom: 1rem;
    }

    .stat-block-image-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: 6px;
      border: 2px solid var(--border);
      object-fit: cover;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .stat-block-image-preview:hover {
      border-color: var(--accent);
    }

    .image-url-input {
      width: 100%;
      padding: 0.4rem 0.6rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.85rem;
    }

    .image-url-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .image-url-input::placeholder {
      color: var(--text-secondary);
    }

    .image-placeholder {
      width: 200px;
      height: 120px;
      border: 2px dashed var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .image-placeholder:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .image-input-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .image-input-row .image-url-input {
      flex: 1;
      margin-bottom: 0;
    }

    .image-upload-btn {
      padding: 0.4rem 0.75rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .image-upload-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .image-upload-input {
      display: none;
    }

    .image-hint {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .image-hint-icon {
      position: relative;
      cursor: help;
      width: 14px;
      height: 14px;
      border: 1px solid var(--text-secondary);
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: bold;
    }

    .image-hint-icon:hover .image-tooltip {
      opacity: 1;
      visibility: visible;
    }

    .image-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      font-weight: normal;
      color: var(--text-primary);
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 100;
    }

    .image-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--border);
    }

    .image-tooltip a {
      color: var(--accent);
      text-decoration: underline;
    }

    .image-processing {
      font-size: 0.8rem;
      color: var(--accent);
      margin-top: 0.25rem;
    }

    /* Collapsible sections */
    .collapsible {
      border-top: 2px solid var(--accent);
      margin-top: 1.25rem;
      position: relative;
    }

    /* Decorative divider diamond */
    .collapsible::before {
      content: "◆";
      position: absolute;
      top: -0.5rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      padding: 0 0.5rem;
      color: var(--accent);
      font-size: 0.6rem;
    }

    :root.light-mode .collapsible::before {
      background: linear-gradient(135deg, #faf8f3, #f5f0e6);
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      cursor: pointer;
      user-select: none;
    }

    .collapsible-header:hover {
      color: var(--accent);
    }

    .collapsible-title {
      font-family: var(--font-display);
      font-weight: 400;
      color: var(--accent);
      text-transform: uppercase;
      font-size: 1.1rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .collapsible-icon {
      transition: transform 0.2s;
      font-size: 0.75rem;
    }

    .collapsible.collapsed .collapsible-icon {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      padding-bottom: 0.5rem;
    }

    .collapsible.collapsed .collapsible-content {
      display: none;
    }

    /* Editable stat line */
    .stat-line {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }

    .stat-label {
      font-family: var(--font-slab);
      color: var(--accent);
      font-weight: 600;
      flex-shrink: 0;
    }

    .stat-value-editable {
      background: transparent;
      border: none;
      border-bottom: 1px dashed transparent;
      color: var(--text-primary);
      font-size: inherit;
      font-family: inherit;
      padding: 0.1rem 0.3rem;
      flex: 1;
      min-width: 0;
    }

    .stat-value-editable:hover {
      border-bottom-color: var(--border);
    }

    .stat-value-editable:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    /* Editable stat grid */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.5rem;
      margin: 1rem 0;
      padding: 0.75rem;
      background: rgba(201, 162, 39, 0.1);
      border-radius: 6px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-item-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
    }

    .stat-item-value {
      font-size: 1rem;
      font-weight: bold;
    }

    .stat-item-input {
      font-size: 1rem;
      font-weight: bold;
      background: transparent;
      border: none;
      border-bottom: 1px dashed transparent;
      color: var(--text-primary);
      text-align: center;
      width: 100%;
      padding: 0.1rem;
    }

    .stat-item-input:hover {
      border-bottom-color: var(--border);
    }

    .stat-item-input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    /* Features Section */
    .features-section {
      padding-top: 1rem;
      margin-top: 0.5rem;
    }

    .feature {
      margin-bottom: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      transition: background 0.2s;
      border-left: 3px solid transparent;
    }

    .feature:hover {
      background: rgba(201, 162, 39, 0.05);
      border-left-color: var(--accent);
    }

    .feature:last-child {
      margin-bottom: 0;
    }

    .feature-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.35rem;
    }

    .feature-name-input {
      font-family: var(--font-slab);
      font-weight: 600;
      color: var(--text-primary);
      background: transparent;
      border: none;
      border-bottom: 1px dashed var(--border);
      padding: 0.1rem 0.3rem;
      font-size: inherit;
      min-width: 100px;
      flex: 1;
    }

    .feature-name-input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    .feature-type {
      font-family: var(--font-slab);
      font-size: 0.7rem;
      font-weight: 500;
      padding: 0.2rem 0.5rem;
      border-radius: 3px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      letter-spacing: 0.02em;
    }

    .feature-type::before {
      font-size: 0.85em;
    }

    .feature-type:hover {
      opacity: 0.85;
      transform: translateY(-1px);
    }

    /* Feature type colors with Font Awesome icons */
    .feature-type-passive {
      background: linear-gradient(135deg, #475569, #334155);
      color: #e2e8f0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .feature-type-passive::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 400;
      content: "\f111"; /* fa-circle (regular/outline) */
    }

    .feature-type-action {
      background: linear-gradient(135deg, #b91c1c, #7c2d12);
      color: #fef2f2;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .feature-type-action::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      content: "\f0e7"; /* fa-bolt */
    }

    .feature-type-reaction {
      background: linear-gradient(135deg, #2563eb, #1e3a5f);
      color: #eff6ff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .feature-type-reaction::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      content: "\f2ea"; /* fa-rotate-left */
    }

    /* Fear feature type */
    .feature-type-fear {
      background: linear-gradient(135deg, #7c3aed, #4c1d95);
      color: #f5f3ff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .feature-type-fear::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      content: "\f54c"; /* fa-skull */
    }

    .feature-desc-input {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 0.25rem;
      background: transparent;
      border: none;
      border-bottom: 1px dashed transparent;
      padding: 0.1rem 0;
      font-family: inherit;
      width: 100%;
      resize: none;
      overflow: hidden;
    }

    .feature-desc-input:hover {
      border-bottom-color: var(--border);
    }

    .feature-desc-input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }

    .feature-actions {
      margin-left: auto;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .feature:hover .feature-actions {
      opacity: 1;
    }

    .feature-btn {
      background: none;
      border: 1px solid transparent;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.5rem;
      font-size: 1rem;
      min-width: 44px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .feature-btn:hover {
      color: var(--error);
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--error);
    }

    .add-feature-btn {
      width: 100%;
      padding: 0.5rem;
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      margin-top: 0.5rem;
    }

    .add-feature-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Tags */
    .tags-section {
      padding-top: 0.5rem;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .tag {
      font-size: 0.8rem;
      padding: 0.4rem 0.75rem;
      background: rgba(201, 162, 39, 0.2);
      color: var(--accent);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      min-height: 32px;
      border: 1px solid transparent;
    }

    .tag:hover {
      background: rgba(201, 162, 39, 0.4);
      border-color: var(--accent);
    }

    .tag-remove {
      margin-left: 0.25rem;
      opacity: 0.7;
      font-size: 1rem;
      padding: 0.25rem;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      min-height: 20px;
    }

    .tag-remove:hover {
      opacity: 1;
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .add-tag-input {
      background: transparent;
      border: 1px dashed var(--border);
      color: var(--text-primary);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      width: 80px;
    }

    .add-tag-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Read-only stat block styles for community viewing */
    .stat-block-image-section-readonly {
      text-align: center;
      margin: 1rem 0;
    }

    .stat-block-image-readonly {
      max-width: 100%;
      max-height: 250px;
      border-radius: 8px;
      border: 2px solid var(--border);
    }

    .stat-line-readonly {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .stat-line-readonly .stat-value {
      color: var(--text-primary);
    }

    .stat-grid-readonly {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 0.5rem;
      margin: 1rem 0;
      padding: 0.75rem;
      background: var(--bg-dark);
      border-radius: 6px;
    }

    .stat-item-readonly {
      text-align: center;
      padding: 0.5rem;
    }

    .stat-item-readonly .stat-item-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .stat-item-readonly .stat-item-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
    }

    .features-section-readonly {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .features-section-readonly .section-title,
    .tags-section-readonly .section-title {
      font-size: 0.9rem;
      color: var(--accent);
      margin-bottom: 0.75rem;
      font-weight: 600;
    }

    .feature-readonly {
      background: var(--bg-dark);
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .feature-header-readonly {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
    }

    .feature-name-readonly {
      font-family: var(--font-slab);
      font-weight: 600;
      color: var(--text-primary);
    }

    .feature-desc-readonly {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Dice roll highlighting */
    .dice-roll {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(201, 162, 39, 0.15);
      color: var(--accent);
      padding: 0.1rem 0.35rem;
      border-radius: 3px;
      font-family: var(--font-slab);
      font-weight: 500;
      font-size: 0.95em;
      cursor: help;
      position: relative;
      border-bottom: 1px dotted var(--accent);
      transition: all 0.2s;
    }

    .dice-roll::before {
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      content: "\f6cf"; /* fa-dice-d20 */
      font-size: 0.8em;
      opacity: 0.7;
    }

    .dice-roll:hover {
      background: rgba(201, 162, 39, 0.25);
      transform: translateY(-1px);
    }

    /* Dice tooltip - fixed positioning to escape modal overflow */
    #dice-tooltip {
      position: fixed;
      background: var(--bg-dark);
      color: var(--text-primary);
      padding: 0.35rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-family: var(--font-body);
      font-weight: 400;
      white-space: nowrap;
      z-index: 10000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 1px solid var(--accent);
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s, visibility 0.15s;
    }

    #dice-tooltip.visible {
      opacity: 1;
      visibility: visible;
    }

    :root.light-mode #dice-tooltip {
      background: #2d2d2d;
      color: #f5f0e6;
    }

    :root.light-mode .dice-roll {
      background: rgba(173, 36, 35, 0.1);
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    :root.light-mode .dice-roll:hover {
      background: rgba(173, 36, 35, 0.2);
    }

    :root.light-mode .dice-roll[data-range]::after {
      background: #2d2d2d;
      color: #f5f0e6;
    }

    .tags-section-readonly {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .tags-readonly {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag-readonly {
      background: var(--bg-dark);
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .tab.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }

    .tab:hover:not(.active) {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* JSON Output */
    .json-output {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 500px;
      overflow-y: auto;
      color: #93c5fd;
    }

    /* Markdown Output */
    .markdown-output {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Text Output */
    .text-output {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Segoe UI', sans-serif;
      font-size: 0.9rem;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      max-width: calc(100vw - 2rem);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.paused {
      /* Keeps toast visible when hovered */
    }

    .toast-success { background: var(--success); }
    .toast-error { background: var(--error); }
    .toast-info { background: var(--info); }

    .toast-message {
      flex: 1;
    }

    .toast-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .toast-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 0 0 0 8px;
      transition: width 0.1s linear;
    }

    @media (max-width: 480px) {
      .toast {
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
      }
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

    .sample-btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
    }

    .empty-state {
      text-align: center;
      color: var(--text-secondary);
      padding: 3rem 2rem;
      background: linear-gradient(135deg, rgba(201, 162, 39, 0.03) 0%, transparent 50%);
      border-radius: 8px;
      border: 1px dashed var(--border);
    }

    .empty-state-icon {
      font-size: 3.5rem;
      margin-bottom: 1rem;
      opacity: 0.6;
      display: inline-block;
    }

    .empty-state p, .empty-state div {
      line-height: 1.6;
    }

    .empty-state kbd {
      background: var(--bg-card);
      padding: 0.2rem 0.5rem;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-input) 25%, var(--bg-card) 50%, var(--bg-input) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-card {
      padding: 1.25rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .skeleton-title {
      height: 1.1rem;
      width: 60%;
      margin-bottom: 0.75rem;
    }

    .skeleton-text {
      height: 0.85rem;
      width: 80%;
      margin-bottom: 0.5rem;
    }

    .skeleton-text-short {
      height: 0.85rem;
      width: 40%;
    }

    .skeleton-tags {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }

    .skeleton-tag {
      height: 1.5rem;
      width: 3rem;
      border-radius: 4px;
    }

    .draft-indicator {
      font-size: 0.75rem;
      color: var(--warning);
      margin-left: 0.5rem;
    }

    .batch-separator {
      text-align: center;
      padding: 1rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .batch-results {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .batch-item {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .batch-item-header {
      background: var(--bg-input);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .batch-item-header:hover {
      background: rgba(201, 162, 39, 0.1);
    }

    .batch-item-content {
      padding: 1rem;
    }

    .batch-item.collapsed .batch-item-content {
      display: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-input);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* Print styles */
    @media print {
      body {
        background: white;
        color: black;
      }

      .container {
        max-width: 100%;
        padding: 0;
      }

      header, .keyboard-hints, .panel:first-child,
      .tabs, .btn-group, .adjustments-section,
      .live-parse, .toast, .mode-toggle {
        display: none !important;
      }

      .main-grid {
        display: block;
      }

      .panel {
        border: none;
        padding: 0;
        background: white;
      }

      .stat-block {
        border: 2px solid #c9a227;
        padding: 1.5rem;
        background: white;
        page-break-inside: avoid;
      }

      .stat-block-name {
        color: #c9a227;
      }

      .stat-label {
        color: #c9a227;
      }

      .collapsible-header {
        display: none;
      }

      .stat-block-image-section {
        text-align: center;
        margin-bottom: 1rem;
      }

      .stat-block-image-preview {
        max-width: 150px;
        max-height: 150px;
        border: 1px solid #c9a227;
      }

      .image-url-input,
      .image-placeholder {
        display: none !important;
      }

      .collapsible-content {
        display: block !important;
      }

      .feature-actions, .tag-remove, .add-feature-btn,
      .add-tag-input, .collapsible-icon {
        display: none !important;
      }

      .stat-value-editable, .stat-item-input,
      .feature-name-input, .feature-desc-input {
        border: none !important;
      }
    }

    /* Screen reader only - becomes visible on focus for skip link */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .sr-only:focus {
      position: fixed;
      top: 0;
      left: 0;
      width: auto;
      height: auto;
      padding: 1rem 1.5rem;
      margin: 0;
      overflow: visible;
      clip: auto;
      white-space: normal;
      background: var(--accent);
      color: var(--bg-dark);
      font-weight: 600;
      z-index: 9999;
      text-decoration: none;
      border-radius: 0 0 8px 0;
    }

    /* Auth UI */
    .auth-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .auth-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-oauth {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-oauth:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    .btn-oauth svg {
      width: 18px;
      height: 18px;
    }

    .user-menu {
      position: relative;
    }

    .user-menu-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .user-menu-toggle:hover {
      border-color: var(--accent);
      background: var(--bg-input);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      color: var(--bg-dark);
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 180px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-top: 0.25rem;
      z-index: 200;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    :root.light-mode .user-dropdown {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .user-dropdown.show {
      display: block;
    }

    .user-dropdown-item {
      padding: 0.6rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      display: block;
      width: 100%;
      text-align: left;
      background: var(--bg-card);
      border: none;
      border-bottom: 1px solid var(--border);
      color: var(--text-primary);
      transition: background 0.15s;
    }

    .user-dropdown-item:last-child {
      border-bottom: none;
    }

    .user-dropdown-item:hover {
      background: var(--bg-input);
    }

    .user-dropdown-item.danger {
      color: var(--error);
    }

    .user-dropdown-item.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Community Tab Styles */
    .community-container {
      min-height: 400px;
    }

    .community-filters {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .community-filters .search-input {
      flex: 1;
      min-width: 200px;
      padding: 0.6rem 1rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .community-filters .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .community-filters select {
      padding: 0.6rem;
      min-width: 120px;
      width: auto;
    }

    .community-filters .form-input,
    .community-filters .form-select {
      width: auto;
    }

    .community-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    /* Daggerheart Rulebook-Style Cards */
    .community-item {
      display: flex;
      flex-direction: column;
      background: #f5f0e6;
      border: 2px solid #2d2d2d;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .community-item:hover {
      border-color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transform: translateY(-2px);
    }

    /* Dark header section */
    .dh-card-header {
      background: #2d2d2d;
      background: linear-gradient(135deg, #2d2d2d 0%, var(--type-color, #2d2d2d) 100%);
      color: #fff;
      padding: 0.75rem 1rem;
      padding-right: 3.5rem;
      border-bottom: 2px solid #e1b74a;
    }

    /* Adversary type colors for cards */
    .dh-card-header[data-type="bruiser"] { --type-color: #8B2635; }
    .dh-card-header[data-type="horde"] { --type-color: #B5651D; }
    .dh-card-header[data-type="leader"] { --type-color: #6B3FA0; }
    .dh-card-header[data-type="minion"] { --type-color: #4a4a4a; }
    .dh-card-header[data-type="ranged"] { --type-color: #2E5984; }
    .dh-card-header[data-type="skulk"] { --type-color: #2D5A3D; }
    .dh-card-header[data-type="social"] { --type-color: #1D6B6B; }
    .dh-card-header[data-type="solo"] { --type-color: #8B7500; }
    .dh-card-header[data-type="standard"] { --type-color: #3d3d3d; }
    .dh-card-header[data-type="support"] { --type-color: #7B3F7B; }

    .dh-card-name {
      font-family: var(--font-display);
      font-weight: 400;
      font-size: 1.35rem;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      margin-bottom: 0.15rem;
    }

    .dh-card-tier-type {
      font-size: 0.8rem;
      color: #ccc;
      font-weight: 500;
    }

    /* Card body - stats section */
    .dh-card-body {
      padding: 0.75rem 1rem;
      color: #2d2d2d;
      font-size: 0.85rem;
      line-height: 1.4;
      border-bottom: 1px solid #d4cfc3;
      flex: 1;
    }

    .dh-card-description {
      font-style: italic;
      color: #444;
      margin-bottom: 0.5rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .dh-card-motives {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 0.5rem;
    }

    .dh-card-motives strong {
      color: #2d2d2d;
    }

    .dh-card-stats {
      font-size: 0.8rem;
      color: #2d2d2d;
    }

    .dh-card-stats-row {
      margin-bottom: 0.25rem;
    }

    .dh-card-stats-row:last-child {
      margin-bottom: 0;
    }

    .dh-stat-label {
      font-weight: 600;
    }

    .dh-stat-separator {
      color: #888;
      margin: 0 0.35rem;
    }

    .dh-stat-item {
      display: inline-block;
      white-space: nowrap;
    }

    /* Mini Stats for Community Cards */
    .mini-stats-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }

    .mini-vitals-row {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }

    .mini-vital-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.25rem 0.5rem;
      background: rgba(0,0,0,0.04);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 4px;
      min-width: 45px;
    }

    .mini-vital-value {
      font-size: 1rem;
      font-weight: 700;
      line-height: 1;
    }

    .mini-vital-label {
      font-size: 0.55rem;
      text-transform: uppercase;
      color: #666;
      margin-top: 2px;
      letter-spacing: 0.3px;
    }

    .mini-vital-box.difficulty .mini-vital-value { color: #b8860b; }
    .mini-vital-box.hp .mini-vital-value { color: #dc2626; }
    .mini-vital-box.stress .mini-vital-value { color: #7c3aed; }

    /* Mini Damage Tracker for Cards */
    .mini-damage-tracker {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
    }

    .mini-damage-card {
      position: relative;
      width: 44px;
      height: 22px;
      flex-shrink: 0;
    }

    .mini-damage-card svg {
      width: 100%;
      height: 100%;
    }

    .mini-damage-card .mini-card-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 6px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .mini-connector {
      width: 28px;
      height: 16px;
      background: #fff;
      border: 2px solid #5f6975;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 -5px;
      z-index: 1;
      position: relative;
    }

    .mini-connector-number {
      color: #5f6975;
      font-size: 10px;
      font-weight: 800;
    }

    /* Library draggable cards */
    .community-item.library-draggable {
      cursor: grab;
    }

    .community-item.library-draggable:active {
      cursor: grabbing;
    }

    .community-item.library-draggable.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }

    .library-drag-hint {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      color: #999;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 5;
    }

    .community-item.library-draggable:hover .library-drag-hint {
      opacity: 0.5;
    }

    /* Card footer - author info */
    .dh-card-footer {
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #ebe6da;
      font-size: 0.75rem;
      color: #666;
    }

    .dh-card-author {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .dh-card-author img {
      width: 18px;
      height: 18px;
      border-radius: 50%;
    }

    .dh-card-source {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      background: rgba(0,0,0,0.08);
      color: #555;
    }

    .dh-card-footer-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .dh-card-footer .share-link-btn {
      position: static;
      padding: 0.2rem 0.4rem;
      font-size: 0.8rem;
      opacity: 0.6;
    }

    .dh-card-footer .share-link-btn:hover {
      opacity: 1;
    }

    /* Voting buttons - compact horizontal layout */
    .community-item-votes {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.25rem;
      background: rgba(255,255,255,0.95);
      border-radius: 4px;
      padding: 0.25rem 0.4rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    .community-item-votes .vote-btn {
      padding: 0.15rem 0.25rem;
      font-size: 0.65rem;
    }

    .community-item-votes .vote-score {
      font-size: 0.75rem;
      min-width: 1.25rem;
      text-align: center;
    }

    .quick-save-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.1rem 0.2rem;
      color: #888;
      transition: all 0.2s;
      line-height: 1;
      margin-left: 0.15rem;
      border-left: 1px solid #ddd;
      padding-left: 0.35rem;
    }

    .quick-save-btn:hover {
      color: #e1b74a;
      transform: scale(1.1);
    }

    .quick-save-btn.saved {
      color: #e1b74a;
    }

    .share-link-btn {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #888;
      padding: 0.2rem 0.35rem;
      font-size: 0.75rem;
      opacity: 0.6;
      transition: all 0.2s;
    }

    .share-link-btn:hover {
      color: var(--accent);
      opacity: 1;
    }

    .community-filters-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }

    .filter-btn {
      padding: 0.4rem 0.8rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: var(--accent);
    }

    .filter-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }

    /* Filter Select Buttons (replaces dropdowns) */
    .filter-select-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--text-primary);
      transition: all 0.2s;
      min-width: 120px;
    }

    .filter-select-btn:hover {
      border-color: var(--accent);
    }

    .filter-select-btn.has-selection {
      border-color: var(--accent);
      background: rgba(var(--accent-rgb), 0.1);
    }

    .filter-arrow {
      margin-left: auto;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    /* Filter Modal Styles */
    .filter-modal {
      max-width: 320px;
      width: 90%;
    }

    .filter-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    @media (max-width: 700px) {
      .filter-options {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-option:hover {
      border-color: var(--accent);
    }

    .filter-option.selected {
      border-color: var(--accent);
      background: rgba(var(--accent-rgb), 0.1);
    }

    .filter-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .filter-option label {
      flex: 1;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .filter-modal-footer {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .vote-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.2rem;
      color: #888;
      transition: color 0.2s;
      font-size: 0.9rem;
      line-height: 1;
    }

    .vote-btn:hover {
      color: #c9a227;
    }

    .vote-btn.active.upvote {
      color: #22c55e;
    }

    .vote-btn.active.downvote {
      color: #ef4444;
    }

    .vote-score {
      font-weight: 600;
      font-size: 0.85rem;
      color: #333;
      line-height: 1;
    }

    .vote-score.positive {
      color: #22c55e;
    }

    .vote-score.negative {
      color: #ef4444;
    }

    .community-empty {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .community-pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .community-pagination button {
      padding: 0.5rem 1rem;
    }

    /* Community Detail Modal */
    .modal-content {
      background: var(--bg-card);
      border-radius: 12px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      margin: 0;
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--accent);
      font-weight: 400;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.25rem;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .modal-vote-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .modal-actions-secondary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.5rem;
      background: var(--bg-input);
      border-top: 1px solid var(--border);
      font-size: 0.85rem;
    }

    .modal-author {
      color: var(--text-secondary);
    }

    .modal-author img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 0.35rem;
    }

    .report-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
    }

    .report-btn:hover {
      color: var(--error);
      opacity: 1;
    }

    /* Report Modal */
    .report-modal {
      max-width: 450px;
    }

    .report-conversion-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: var(--bg-input);
      border-radius: 4px;
    }

    .report-hint {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.75rem;
    }

    /* FAQ Modal */
    .faq-modal {
      max-width: 700px;
    }

    .faq-body {
      max-height: 70vh;
      overflow-y: auto;
    }

    .faq-section {
      margin-bottom: 1.75rem;
    }

    .faq-section:last-child {
      margin-bottom: 0;
    }

    .faq-section h3 {
      font-family: var(--font-display);
      color: var(--accent);
      font-size: 1.3rem;
      font-weight: 400;
      margin-bottom: 0.75rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
      letter-spacing: 0.02em;
    }

    .faq-section p {
      color: var(--text-primary);
      line-height: 1.6;
      margin-bottom: 0.75rem;
    }

    .faq-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.75rem 0;
      font-size: 0.9rem;
    }

    .faq-table th,
    .faq-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border: 1px solid var(--border);
    }

    .faq-table th {
      background: var(--bg-input);
      color: var(--accent);
      font-weight: 600;
    }

    .faq-table td {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .faq-table tr:hover td {
      background: var(--bg-input);
    }

    .faq-list {
      list-style: none;
      padding: 0;
      margin: 0.75rem 0;
    }

    .faq-list li {
      padding: 0.5rem 0;
      padding-left: 1.25rem;
      position: relative;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .faq-list li::before {
      content: "•";
      position: absolute;
      left: 0;
      color: var(--accent);
      font-weight: bold;
    }

    .faq-list li strong {
      color: var(--accent);
    }

    /* Share button */
    .btn-share {
      background: var(--accent-secondary);
      color: white;
    }

    .btn-share:hover {
      background: var(--accent-secondary-hover);
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .community-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem;
      gap: 1rem;
    }

    /* My Submissions section */
    .my-submissions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
      .auth-section {
        order: -1;
        width: 100%;
        justify-content: center;
      }

      .community-filters {
        flex-direction: column;
      }

      .community-filters .search-input,
      .community-filters select {
        width: 100%;
      }

      .community-item {
        flex-direction: column;
        align-items: stretch;
      }

      .community-item-votes {
        position: static;
        justify-content: center;
        border-top: 1px solid var(--border);
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        background: transparent;
        box-shadow: none;
      }

      .modal-footer {
        flex-direction: column;
      }

      .modal-footer .btn-group {
        width: 100%;
      }
    }

    /* Footer */
    .site-footer {
      text-align: center;
      padding: 1.5rem 1rem;
      margin-top: 2rem;
      border-top: 1px solid var(--border);
    }

    .site-footer p {
      font-size: 0.7rem;
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.4;
      opacity: 0.7;
    }

    .footer-links {
      margin-top: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .footer-links a {
      font-size: 0.65rem;
      color: var(--text-secondary);
      opacity: 0.6;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .footer-links a:hover {
      opacity: 1;
      text-decoration: underline;
    }

    .footer-divider {
      color: var(--text-secondary);
      opacity: 0.4;
    }

    .coffee-footer-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .coffee-footer-link:hover svg {
      color: #ffdd00;
    }

    /* Privacy Modal */
    .privacy-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .privacy-modal.active {
      display: flex;
    }

    .privacy-modal-content {
      background: var(--bg-dark);
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
    }

    .privacy-modal-content h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--text);
    }

    .privacy-modal-content h3 {
      color: var(--accent);
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .privacy-modal-content p,
    .privacy-modal-content li {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .privacy-modal-content ul {
      padding-left: 1.5rem;
      margin: 0.5rem 0;
    }

    .privacy-modal-content .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      padding: 0.25rem 0.5rem;
    }

    .privacy-modal-content .close-btn:hover {
      color: var(--text);
    }

    .zs-credits {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }

    .zs-credits a {
      color: var(--text-secondary);
      text-decoration: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .zs-credits a:hover {
      opacity: 1;
      color: var(--accent);
    }

    .zs-credits span {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
    }

    @media print {
      .site-footer {
        display: none;
      }
    }

    /* Encounter Builder */
    .encounter-builder-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .encounter-header {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
    }

    .encounter-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--accent);
    }

    .encounter-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .party-size-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .party-size-control label {
      font-weight: 500;
    }

    .party-btn {
      width: 36px;
      height: 36px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .party-btn:hover {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    #party-size-value {
      font-size: 1.5rem;
      font-weight: 700;
      min-width: 2rem;
      text-align: center;
      color: var(--accent);
    }

    .budget-display {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .budget-separator {
      color: var(--text-secondary);
    }

    .budget-bar {
      width: 150px;
      height: 10px;
      background: var(--bg-input);
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .budget-bar-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s ease, background-color 0.3s ease;
    }

    .budget-bar-fill.warning { background: var(--warning); }
    .budget-bar-fill.danger { background: var(--error); }

    .encounter-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .encounter-library-panel,
    .encounter-roster-panel {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 400px;
    }

    .encounter-library-panel h3,
    .encounter-roster-panel h3 {
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      color: var(--accent);
    }

    #encounter-library-search,
    #encounter-name {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      background: var(--bg-input);
      color: var(--text-primary);
    }

    #encounter-library-search:focus,
    #encounter-name:focus {
      outline: none;
      border-color: var(--accent);
    }

    .encounter-list {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg-input);
    }

    .encounter-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .encounter-item:last-child { border-bottom: none; }
    .encounter-item:hover { background: rgba(201, 162, 39, 0.1); }

    .encounter-item-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .encounter-item-name {
      font-weight: 600;
    }

    .encounter-item-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .encounter-bp-badge {
      background: var(--accent);
      color: var(--bg-dark);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .encounter-item-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .encounter-count {
      font-weight: 600;
      min-width: 1.5rem;
      text-align: center;
    }

    .encounter-total {
      padding: 1rem;
      text-align: right;
      font-size: 1.1rem;
      border-top: 1px solid var(--border);
      margin-top: auto;
    }

    .encounter-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      padding-top: 1rem;
    }

    .saved-encounters-section {
      margin-top: 2rem;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .saved-encounters-section h3 {
      margin: 0 0 1rem 0;
      color: var(--accent);
    }

    .saved-encounter-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .saved-encounter-item:last-child {
      border-bottom: none;
    }

    .saved-encounter-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .saved-encounter-info strong {
      color: var(--text-primary);
    }

    .encounter-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: var(--text-secondary);
      text-align: center;
      height: 100%;
    }

    @media (max-width: 768px) {
      .encounter-columns {
        grid-template-columns: 1fr;
      }
      .encounter-controls {
        flex-direction: column;
        align-items: flex-start;
      }
      .budget-display {
        width: 100%;
      }
      .budget-bar {
        flex: 1;
        min-width: 100px;
      }
      .encounter-builder-container {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="sr-only">Skip to main content</a>

  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-inner">
      <a href="#" class="navbar-brand" onclick="navigateTo('converter'); return false;">
        <span class="navbar-brand-icon">⚔️</span>
        <span>Daggerheart Tools</span>
      </a>

      <div class="navbar-nav">
        <a href="#" class="nav-link active" data-page="converter" onclick="navigateTo('converter'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
          </svg>
          <span>Converter</span>
        </a>
        <a href="#" class="nav-link" data-page="myLibrary" onclick="navigateTo('myLibrary'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            <line x1="12" y1="6" x2="12" y2="12"/>
            <line x1="9" y1="9" x2="15" y2="9"/>
          </svg>
          <span>Collection</span>
        </a>
        <a href="#" class="nav-link" data-page="community" onclick="navigateTo('community'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <span>Community</span>
        </a>
        <a href="#" class="nav-link" data-page="encounter-builder" onclick="navigateTo('encounter-builder'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          <span>Encounters</span>
        </a>
        <a href="#" class="nav-link admin-only hidden" id="adminNavLink" data-page="admin" onclick="navigateTo('admin'); return false;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 15v2"/>
            <path d="M12 11v.01"/>
            <path d="M3 21h18"/>
            <path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"/>
            <path d="M9 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"/>
          </svg>
          <span>Admin</span>
        </a>
      </div>

      <div class="navbar-right">
        <button class="faq-link" onclick="openFAQModal()" title="How It Works">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
            <circle cx="12" cy="12" r="10"/>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
            <circle cx="12" cy="17" r="0.5" fill="currentColor"/>
          </svg>
        </button>
        <a href="https://buymeacoffee.com/marcusu" target="_blank" rel="noopener" class="coffee-link" title="Buy me a coffee">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
            <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
            <line x1="6" y1="2" x2="6" y2="4"/>
            <line x1="10" y1="2" x2="10" y2="4"/>
            <line x1="14" y1="2" x2="14" y2="4"/>
          </svg>
        </a>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle light/dark mode" title="Toggle theme">
          <span class="theme-icon-dark" aria-hidden="true">☀️</span>
          <span class="theme-icon-light" aria-hidden="true">🌙</span>
        </button>
        <div id="authSection">
          <!-- Auth UI populated by JavaScript -->
        </div>
      </div>
    </div>
  </nav>

  <!-- Login Modal -->
  <div id="loginModal" class="login-modal hidden" onclick="closeLoginModal(event)">
    <div class="login-modal-content" onclick="event.stopPropagation()">
      <div class="login-modal-header">
        <h2>Welcome Back</h2>
        <p>Sign in to share conversions and vote</p>
      </div>
      <div class="login-modal-body">
        <a href="/auth/discord" class="btn-sso discord">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.317 4.492c-1.53-.69-3.17-1.2-4.885-1.49a.075.075 0 0 0-.079.036c-.21.369-.444.85-.608 1.23a18.566 18.566 0 0 0-5.487 0 12.36 12.36 0 0 0-.617-1.23A.077.077 0 0 0 8.562 3c-1.714.29-3.354.8-4.885 1.491a.07.07 0 0 0-.032.027C.533 9.093-.32 13.555.099 17.961a.08.08 0 0 0 .031.055 20.03 20.03 0 0 0 5.993 2.98.078.078 0 0 0 .084-.026c.462-.63.874-1.295 1.226-1.963a.074.074 0 0 0-.041-.104 13.201 13.201 0 0 1-1.872-.878.075.075 0 0 1-.008-.125c.126-.093.252-.19.372-.287a.075.075 0 0 1 .078-.01c3.927 1.764 8.18 1.764 12.061 0a.075.075 0 0 1 .079.009c.12.098.245.195.372.288a.075.075 0 0 1-.006.125c-.598.344-1.22.635-1.873.877a.075.075 0 0 0-.041.105c.36.687.772 1.341 1.225 1.962a.077.077 0 0 0 .084.028 19.963 19.963 0 0 0 6.002-2.981.076.076 0 0 0 .032-.054c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 0 0-.031-.028zM8.02 15.278c-1.182 0-2.157-1.069-2.157-2.38 0-1.312.956-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.956 2.38-2.157 2.38zm7.975 0c-1.183 0-2.157-1.069-2.157-2.38 0-1.312.955-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.946 2.38-2.157 2.38z"/>
          </svg>
          Continue with Discord
        </a>
      </div>
      <div class="login-modal-footer">
        By signing in, you agree to share your creations with the community.
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Modal -->
  <div id="keyboardModal" class="modal-overlay hidden" onclick="closeKeyboardModal(event)">
    <div class="modal-content keyboard-modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Keyboard Shortcuts</h2>
        <button class="modal-close" onclick="closeKeyboardModal()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="shortcut-section">
          <h3>Converter</h3>
          <div class="shortcut-row"><kbd>Ctrl</kbd>+<kbd>Enter</kbd><span>Convert stat block</span></div>
          <div class="shortcut-row"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>C</kbd><span>Copy JSON</span></div>
          <div class="shortcut-row"><kbd>Ctrl</kbd>+<kbd>Z</kbd><span>Undo</span></div>
          <div class="shortcut-row"><kbd>Ctrl</kbd>+<kbd>Y</kbd><span>Redo</span></div>
          <div class="shortcut-row"><kbd>Esc</kbd><span>Clear all</span></div>
        </div>
        <div class="shortcut-section">
          <h3>Navigation</h3>
          <div class="shortcut-row"><kbd>?</kbd><span>Show this help</span></div>
          <div class="shortcut-row"><kbd>Esc</kbd><span>Close modals</span></div>
        </div>
        <div class="shortcut-section">
          <h3>Accessibility</h3>
          <div class="shortcut-row"><kbd>Tab</kbd><span>Navigate elements</span></div>
          <div class="shortcut-row"><kbd>Enter</kbd>/<kbd>Space</kbd><span>Activate buttons</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Multi-Select Modal -->
  <div id="filterModal" class="modal-overlay hidden" onclick="closeFilterModal(event)">
    <div class="modal-content filter-modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="filterModalTitle">Select Tiers</h2>
        <button class="modal-close" onclick="closeFilterModal()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="filter-options" id="filterOptions">
          <!-- Options populated by JS -->
        </div>
      </div>
      <div class="modal-footer filter-modal-footer">
        <button class="btn btn-secondary btn-small" onclick="clearFilterSelection()">Clear All</button>
        <button class="btn btn-primary btn-small" onclick="applyFilter()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Converter Page -->
  <div id="converterPage" class="page-view active">
    <div class="container">
      <header class="page-header">
        <h1>Adversary Converter</h1>
        <p class="subtitle">Transform any creature from other popular TTRPGs into a Daggerheart stat block. Just paste and convert.</p>
        <div class="keyboard-hints" role="note" aria-label="Keyboard shortcuts">
          <span class="keyboard-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> Convert</span>
          <span class="keyboard-hint"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>C</kbd> Copy JSON</span>
          <span class="keyboard-hint"><kbd>Ctrl</kbd>+<kbd>Z</kbd> Undo</span>
          <span class="keyboard-hint"><kbd>Ctrl</kbd>+<kbd>Y</kbd> Redo</span>
          <span class="keyboard-hint"><kbd>Esc</kbd> Clear</span>
        </div>
      </header>

      <main id="main-content" class="main-grid">
      <!-- Input Panel -->
      <div class="panel" role="region" aria-label="Input panel">
        <div class="panel-header">
          <span class="panel-title">
            TTRPG Stat Block
            <span id="draftIndicator" class="draft-indicator hidden" title="Draft auto-saved">Draft saved</span>
          </span>
          <div class="btn-group">
            <div class="recent-dropdown">
              <button class="btn btn-secondary btn-small" onclick="toggleRecentMenu()"
                      aria-haspopup="true" aria-expanded="false" id="recentBtn">
                Recent
              </button>
              <div class="recent-menu" id="recentMenu" role="menu" aria-labelledby="recentBtn">
                <div id="recentList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- System Selector -->
        <div class="system-selector" style="margin-bottom: 1rem;">
          <label class="form-label" for="systemSelect">Source System</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <select id="systemSelect" class="form-select" style="flex: 1;" onchange="handleSystemChange()">
              <option value="auto">Auto-Detect</option>
              <option value="dnd5e">D&D 5th Edition</option>
              <option value="pf2e">Pathfinder 2e</option>
              <option value="dnd35e">D&D 3.5e / Pathfinder 1e</option>
              <option value="osr">OSR / B/X / Old-School</option>
            </select>
            <span id="detectedSystem" class="detected-system" style="font-size: 0.8rem; color: var(--text-secondary);"></span>
          </div>
        </div>

        <!-- Sample Buttons by System -->
        <div class="sample-buttons" style="margin-bottom: 1rem;">
          <span style="font-size: 0.8rem; color: var(--text-secondary); margin-right: 0.5rem;">Samples:</span>
          <div class="btn-group" id="sampleButtons">
            <button class="btn btn-secondary sample-btn" onclick="loadSample('dnd5e', 'ogre')">5e Ogre</button>
            <button class="btn btn-secondary sample-btn" onclick="loadSample('dnd5e', 'wight')">5e Wight</button>
            <button class="btn btn-secondary sample-btn" onclick="loadSample('pf2e', 'ironscale')">PF2e Warrior</button>
            <button class="btn btn-secondary sample-btn" onclick="loadSample('dnd35e', 'ogre')">3.5e Ogre</button>
            <button class="btn btn-secondary sample-btn" onclick="loadSample('osr', 'goblin')">OSR Goblin</button>
          </div>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle" role="tablist" aria-label="Conversion mode">
          <button class="mode-btn active" role="tab" aria-selected="true" data-mode="single" onclick="setMode('single')">
            Single
          </button>
          <button class="mode-btn" role="tab" aria-selected="false" data-mode="batch" onclick="setMode('batch')">
            Batch (separate with ---)
          </button>
        </div>

        <div class="drop-zone" id="dropZone">
          <textarea
            id="inputText"
            aria-label="TTRPG stat block input"
            placeholder="Paste a creature stat block here, or drag & drop a .txt file...

For batch mode, separate multiple stat blocks with ---

Supports most popular TTRPG stat block formats.
The converter will auto-detect the source system."
            oninput="handleLiveParse()"></textarea>
        </div>

        <div class="btn-group" style="margin-top: 1rem;">
          <button class="btn btn-primary" onclick="convert()" id="convertBtn" aria-describedby="convertHint">
            Convert to Daggerheart
          </button>
          <button class="btn btn-secondary" onclick="clearAll()" aria-label="Clear all input and output">
            Clear
          </button>
          <span id="convertHint" class="sr-only">Press Ctrl+Enter to convert</span>
        </div>

        <!-- Live Parse Preview -->
        <div id="liveParsePreview" class="live-parse hidden" role="status" aria-live="polite">
          <div class="live-parse-title">
            <span class="pulse" aria-hidden="true">●</span> Live Detection
          </div>
          <div class="live-parse-grid" id="liveParseGrid"></div>
          <div class="confidence-legend">
            <span class="confidence-legend-item"><span class="confidence-badge confidence-high" aria-hidden="true"></span> Detected</span>
            <span class="confidence-legend-item"><span class="confidence-badge confidence-medium" aria-hidden="true"></span> Inferred</span>
            <span class="confidence-legend-item"><span class="confidence-badge confidence-low" aria-hidden="true"></span> Not found</span>
          </div>
        </div>

        <!-- Adjustments -->
        <div id="adjustments" class="adjustments-section hidden">
          <div class="adjustments-title">Adjustments (Optional)</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="overrideTier">Override Tier</label>
              <select id="overrideTier" class="form-select" onchange="reconvert()">
                <option value="">Auto-detect</option>
                <option value="1">Tier 1 (CR 0-1)</option>
                <option value="2">Tier 2 (CR 2-4)</option>
                <option value="3">Tier 3 (CR 5-10)</option>
                <option value="4">Tier 4 (CR 11+)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="overrideType">Override Type</label>
              <select id="overrideType" class="form-select" onchange="reconvert()">
                <option value="">Auto-detect</option>
                <option value="Bruiser">Bruiser (high HP, melee)</option>
                <option value="Horde">Horde (groups, weak)</option>
                <option value="Leader">Leader (commands allies)</option>
                <option value="Minion">Minion (1 HP, fodder)</option>
                <option value="Ranged">Ranged (attacks from distance)</option>
                <option value="Skulk">Skulk (stealth, ambush)</option>
                <option value="Social">Social (non-combat)</option>
                <option value="Solo">Solo (fights whole party)</option>
                <option value="Standard">Standard (balanced)</option>
                <option value="Support">Support (buffs/debuffs)</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Output Panel -->
      <div class="panel" role="region" aria-label="Output panel">
        <div class="panel-header">
          <span class="panel-title">Daggerheart Output</span>
          <div class="undo-toolbar">
            <button class="btn btn-icon btn-small" onclick="undo()" id="undoBtn" disabled
                    aria-label="Undo" title="Undo (Ctrl+Z)">↶</button>
            <button class="btn btn-icon btn-small" onclick="redo()" id="redoBtn" disabled
                    aria-label="Redo" title="Redo (Ctrl+Y)">↷</button>
          </div>
          <div class="btn-group output-actions">
            <!-- Copy Dropdown -->
            <div class="action-dropdown">
              <button class="btn btn-success btn-small" onclick="copyJSON()" id="copyBtn" disabled>
                <span class="btn-icon-inline">📋</span> Copy
              </button>
              <button class="btn btn-success btn-small dropdown-toggle" onclick="toggleCopyMenu()" id="copyDropdownBtn" disabled aria-label="Copy options">▾</button>
              <div class="dropdown-menu" id="copyMenu">
                <button onclick="copyJSON(); closeCopyMenu()">JSON</button>
                <button onclick="copyMarkdown(); closeCopyMenu()">Markdown</button>
                <button onclick="copyText(); closeCopyMenu()">Plain Text</button>
              </div>
            </div>
            <button class="btn btn-secondary btn-small" onclick="downloadJSON()" id="downloadBtn" disabled title="Download JSON file">
              <span class="btn-icon-inline">⬇</span> Download
            </button>
            <button class="btn btn-share btn-small" onclick="saveAndPublish()" id="saveBtn" disabled title="Save to library and publish to community">
              <span class="btn-icon-inline">💾</span> Save
            </button>
            <!-- More Actions Dropdown -->
            <div class="action-dropdown">
              <button class="btn btn-secondary btn-small" onclick="toggleMoreMenu()" id="moreBtn" disabled title="More actions">
                ⋯
              </button>
              <div class="dropdown-menu dropdown-menu-right" id="moreMenu">
                <button onclick="addConvertedToGroup(); closeMoreMenu()"><span>📁</span> Add to Group</button>
                <button onclick="shareAsURL(); closeMoreMenu()"><span>🔗</span> Copy URL</button>
                <button onclick="window.print(); closeMoreMenu()"><span>🖨</span> Print</button>
              </div>
            </div>
          </div>
          <!-- Hidden buttons for compatibility -->
          <button id="copyMdBtn" class="hidden" disabled></button>
          <button id="copyTextBtn" class="hidden" disabled></button>
          <button id="groupBtn" class="hidden" disabled></button>
          <button id="printBtn" class="hidden" disabled></button>
          <button id="urlBtn" class="hidden" disabled></button>
          <button id="libraryBtn" class="hidden" disabled></button>
          <button id="shareBtn" class="hidden" disabled></button>
        </div>

        <div class="tabs" role="tablist">
          <button class="tab active" onclick="switchTab('preview')" data-tab="preview" role="tab" aria-selected="true">
            Preview
          </button>
          <button class="tab" onclick="switchTab('json')" data-tab="json" role="tab" aria-selected="false">
            JSON
          </button>
          <button class="tab" onclick="switchTab('markdown')" data-tab="markdown" role="tab" aria-selected="false">
            Markdown
          </button>
          <button class="tab" onclick="switchTab('text')" data-tab="text" role="tab" aria-selected="false">
            Text
          </button>
        </div>

        <!-- Preview Tab -->
        <div id="previewTab" role="tabpanel">
          <div id="statBlockPreview" class="stat-block">
            <div class="empty-state">
              <div class="empty-state-icon" aria-hidden="true">⚔️</div>
              <div>Paste a stat block and press <kbd>Ctrl</kbd>+<kbd>Enter</kbd></div>
              <div style="margin-top: 0.5rem; font-size: 0.85rem;">or click "Convert to Daggerheart"</div>
            </div>
          </div>
        </div>

        <!-- JSON Tab -->
        <div id="jsonTab" class="hidden" role="tabpanel">
          <div id="jsonOutput" class="json-output">// JSON output will appear here after conversion</div>
        </div>

        <!-- Markdown Tab -->
        <div id="markdownTab" class="hidden" role="tabpanel">
          <div id="markdownOutput" class="markdown-output">Markdown output will appear here after conversion</div>
        </div>

        <!-- Text Tab -->
        <div id="textTab" class="hidden" role="tabpanel">
          <div id="textOutput" class="text-output">Text output will appear here after conversion</div>
        </div>
      </div>
    </main>
    </div>
  </div>

  <!-- Community Library Page -->
  <div id="communityPage" class="page-view">
    <div class="community-page">
      <div class="community-header">
        <h1>Community</h1>
        <p>Browse and share Daggerheart conversions created by the community</p>
      </div>

      <div class="community-container">
        <div class="community-filters-row" id="communityFilterTabs">
          <button class="filter-btn active" onclick="setCommunityFilter('all')" data-filter="all">All Conversions</button>
          <button class="filter-btn" onclick="setCommunityFilter('mine')" data-filter="mine" id="mySubmissionsBtn" style="display: none;">My Submissions</button>
        </div>
        <div class="community-filters">
          <input type="text" class="search-input" id="communitySearch" placeholder="Search conversions..." oninput="debounceCommunitySearch()">
          <button class="filter-select-btn" onclick="openFilterModal('tier')" id="tierFilterBtn">
            <span id="tierFilterLabel">All Tiers</span>
            <span class="filter-arrow">▾</span>
          </button>
          <button class="filter-select-btn" onclick="openFilterModal('type')" id="typeFilterBtn">
            <span id="typeFilterLabel">All Types</span>
            <span class="filter-arrow">▾</span>
          </button>
          <select id="communitySort" class="form-select" onchange="loadCommunityConversions()">
            <option value="popular">Most Popular</option>
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>

        <div id="communityList" class="community-list">
          <div class="community-empty">
            <p>Click "Community" in the nav to browse shared conversions.</p>
          </div>
        </div>

        <div id="communityPagination" class="community-pagination hidden">
          <button class="btn btn-secondary btn-small" onclick="communityPrevPage()" id="communityPrevBtn" disabled>Previous</button>
          <span id="communityPageInfo">Page 1 of 1</span>
          <button class="btn btn-secondary btn-small" onclick="communityNextPage()" id="communityNextBtn" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Encounter Builder Page -->
  <div id="encounter-builderPage" class="page-view">
    <div class="encounter-builder-container">
      <!-- Header with party size and budget -->
      <div class="encounter-header">
        <h2>Encounter Builder</h2>
        <div class="encounter-controls">
          <div class="party-size-control">
            <label>Party Size:</label>
            <button class="party-btn" onclick="adjustPartySize(-1)">−</button>
            <span id="party-size-value">4</span>
            <button class="party-btn" onclick="adjustPartySize(1)">+</button>
          </div>
          <div class="budget-display">
            <span>Budget: <strong id="budget-total">14</strong> BP</span>
            <span class="budget-separator">|</span>
            <span>Used: <strong id="budget-used">0</strong> BP</span>
            <div class="budget-bar">
              <div class="budget-bar-fill" id="budget-bar-fill"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Two-column layout -->
      <div class="encounter-columns">
        <!-- Left: Library picker -->
        <div class="encounter-library-panel">
          <h3>Your Library</h3>
          <input type="text" id="encounter-library-search"
                 placeholder="Search adversaries..."
                 oninput="debouncedFilterEncounterLibrary()">
          <div id="encounter-library-list" class="encounter-list"></div>
        </div>

        <!-- Right: Current encounter -->
        <div class="encounter-roster-panel">
          <h3>Current Encounter</h3>
          <input type="text" id="encounter-name"
                 placeholder="Encounter Name (optional)"
                 oninput="encounterState.name = this.value">
          <div id="encounter-roster" class="encounter-list"></div>
          <div class="encounter-total">
            Total: <strong id="encounter-total-bp">0</strong> BP
          </div>
          <div class="encounter-actions">
            <button class="btn btn-secondary" onclick="clearEncounter()">Clear</button>
            <button class="btn btn-primary" onclick="saveEncounter()">Save Encounter</button>
          </div>
        </div>
      </div>

      <!-- Saved encounters section -->
      <div class="saved-encounters-section">
        <h3>Saved Encounters</h3>
        <div id="saved-encounters-list"></div>
      </div>
    </div>
  </div>

  <!-- Admin Page -->
  <div id="adminPage" class="page-view admin-only">
    <div class="admin-page">
      <div class="admin-header">
        <h1>Admin Panel</h1>
        <p>Manage community conversions and users</p>
      </div>

      <!-- Stats Section -->
      <div class="admin-stats" id="adminStats">
        <div class="stat-card">
          <div class="stat-value" id="statUsers">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statConversions">-</div>
          <div class="stat-label">Conversions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statVotes">-</div>
          <div class="stat-label">Total Votes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statRecentConversions">-</div>
          <div class="stat-label">New (7 days)</div>
        </div>
      </div>

      <!-- Analytics Section -->
      <div class="admin-analytics" id="adminAnalytics">
        <div class="analytics-toggle">
          <button onclick="toggleAnalytics()">Show/Hide Analytics</button>
        </div>
        <div id="analyticsContent" style="display: none;">
          <div class="analytics-grid">
            <div class="chart-card">
              <h3>Conversions (30 days)</h3>
              <div class="chart-container">
                <canvas id="conversionsChart" class="chart-canvas"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3>Users (30 days)</h3>
              <div class="chart-container">
                <canvas id="usersChart" class="chart-canvas"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3>Reports (30 days)</h3>
              <div class="chart-container">
                <canvas id="reportsChart" class="chart-canvas"></canvas>
              </div>
            </div>
            <div class="chart-card">
              <h3>Votes (30 days)</h3>
              <div class="chart-container">
                <canvas id="votesChart" class="chart-canvas"></canvas>
              </div>
            </div>
          </div>

          <div class="suspicious-section">
            <h3>Suspicious Activity Monitor</h3>
            <div class="suspicious-grid">
              <div class="suspicious-card">
                <h4>High Activity Users (24h)</h4>
                <ul id="suspiciousHighActivity">
                  <li class="empty">None detected</li>
                </ul>
              </div>
              <div class="suspicious-card">
                <h4>Heavily Reported Content</h4>
                <ul id="suspiciousHeavilyReported">
                  <li class="empty">None detected</li>
                </ul>
              </div>
              <div class="suspicious-card">
                <h4>Recently Banned Users</h4>
                <ul id="suspiciousRecentBans">
                  <li class="empty">None</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="admin-tabs">
        <button class="admin-tab active" onclick="switchAdminTab('conversions')">Conversions</button>
        <button class="admin-tab" onclick="switchAdminTab('users')">Users</button>
        <button class="admin-tab" onclick="switchAdminTab('reports')" id="adminReportsTab">
          Reports <span class="admin-badge-count" id="pendingReportsBadge"></span>
        </button>
      </div>

      <!-- Conversions Tab -->
      <div id="adminConversionsTab" class="admin-tab-content">
        <div class="admin-toolbar">
          <input type="text" class="form-input admin-search" id="adminConversionSearch" placeholder="Search conversions or authors..." onkeyup="debounceAdminSearch('conversions')">
        </div>
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Author</th>
                <th>Tier</th>
                <th>Type</th>
                <th>Score</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adminConversionsBody">
              <tr><td colspan="8" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="admin-pagination" id="adminConversionsPagination"></div>
      </div>

      <!-- Users Tab -->
      <div id="adminUsersTab" class="admin-tab-content hidden">
        <div class="admin-toolbar">
          <input type="text" class="form-input admin-search" id="adminUserSearch" placeholder="Search users..." onkeyup="debounceAdminSearch('users')">
        </div>
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Provider</th>
                <th>Conversions</th>
                <th>Votes</th>
                <th>Status</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adminUsersBody">
              <tr><td colspan="7" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="admin-pagination" id="adminUsersPagination"></div>
      </div>

      <!-- Reports Tab -->
      <div id="adminReportsTab" class="admin-tab-content hidden">
        <div class="admin-toolbar">
          <select class="form-select" id="adminReportStatusFilter" onchange="loadAdminReports(1)">
            <option value="all">All Reports</option>
            <option value="pending" selected>Pending</option>
            <option value="reviewed">Reviewed</option>
            <option value="dismissed">Dismissed</option>
            <option value="actioned">Actioned</option>
          </select>
        </div>
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Conversion</th>
                <th>Reported By</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adminReportsBody">
              <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="admin-pagination" id="adminReportsPagination"></div>
      </div>
    </div>
  </div>

  <!-- My Library Page -->
  <div id="myLibraryPage" class="page-view">
    <div class="my-library-page">
      <div class="my-library-header">
        <h1>Collection</h1>
        <p>Drag and drop adversaries to organize them into groups</p>
      </div>

      <div class="my-library-container">
        <!-- Folders Sidebar -->
        <div class="folders-sidebar">
          <div class="folders-header">
            <span class="folders-title">Folders</span>
            <button class="folder-add-btn" onclick="createNewGroup()" title="New Folder">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
            </button>
          </div>

          <div class="folders-tree" id="foldersTree">
            <!-- All Adversaries (root) -->
            <div class="folder-item folder-root active" data-folder="all" onclick="selectFolder('all')"
                 ondragover="handleFolderDragOver(event)" ondragleave="handleFolderDragLeave(event)" ondrop="handleFolderDrop(event, 'all')">
              <span class="folder-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
                </svg>
              </span>
              <span class="folder-name">All Adversaries</span>
              <span class="folder-count" id="allCount">0</span>
            </div>

            <!-- User-created folders -->
            <div class="folders-list" id="foldersList">
              <!-- Folders populated by JavaScript -->
            </div>

            <!-- Ungrouped -->
            <div class="folder-item folder-ungrouped" data-folder="ungrouped" onclick="selectFolder('ungrouped')"
                 ondragover="handleFolderDragOver(event)" ondragleave="handleFolderDragLeave(event)" ondrop="handleFolderDrop(event, 'ungrouped')">
              <span class="folder-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <path d="M9 9h6M9 15h6"/>
                </svg>
              </span>
              <span class="folder-name">Ungrouped</span>
              <span class="folder-count" id="ungroupedCount">0</span>
            </div>
          </div>

          <div class="folders-help">
            <small>Drag adversaries to folders to organize</small>
          </div>
        </div>

        <!-- Content Area -->
        <div class="library-content">
          <div class="library-content-header">
            <div class="library-title-section">
              <h2 id="currentFolderName">All Adversaries</h2>
              <span class="library-item-count" id="folderItemCount">(0 items)</span>
            </div>
            <div class="library-actions" id="folderActions">
              <input type="text" class="library-search" id="librarySearch" placeholder="Search..." oninput="filterLibraryItems()">
              <div class="folder-edit-actions" id="folderEditActions" style="display: none;">
                <button class="icon-btn" onclick="startRenameFolder()" title="Rename folder">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button class="icon-btn icon-btn-danger" onclick="deleteCurrentGroup()" title="Delete folder">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="library-items-container" id="libraryItemsContainer"
               ondragover="handleContainerDragOver(event)" ondrop="handleContainerDrop(event)">
            <div class="library-items" id="libraryItems">
              <!-- Items populated by JavaScript -->
            </div>
            <div class="library-empty-state" id="libraryEmptyState">
              <div class="empty-icon-large">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.4">
                  <path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
                </svg>
              </div>
              <p class="empty-title">No adversaries yet</p>
              <p class="empty-hint">Convert stat blocks or add from Community to get started</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add to Group Modal -->
  <div id="addToGroupModal" class="modal-overlay hidden" onclick="closeAddToGroupModal(event)">
    <div class="modal-content modal-small" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Add to Group</h2>
        <button class="modal-close" onclick="closeAddToGroupModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="add-to-group-name" id="addToGroupAdversaryName"></p>
        <div class="group-select-list" id="groupSelectList">
          <!-- Groups populated by JavaScript -->
        </div>
        <div class="create-new-group-inline">
          <input type="text" id="newGroupNameInline" placeholder="Or create new group..." class="form-input">
          <button class="btn btn-success btn-small" onclick="createGroupAndAdd()">Create & Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Adversary Detail Modal for My Library -->
  <div id="myLibraryModal" class="modal-overlay hidden" onclick="closeMyLibraryModal(event)">
    <div class="dh-modal-wrapper">
      <button class="dh-modal-close" onclick="closeMyLibraryModal()" aria-label="Close">&times;</button>
      <div class="dh-modal-card" onclick="event.stopPropagation()">
        <div id="myLibraryModalStatBlock"></div>
        <div class="dh-modal-footer">
          <div class="dh-modal-actions">
            <button class="btn" onclick="copyMyLibraryJSON()" title="Copy JSON">JSON</button>
            <button class="btn" onclick="moveToGroup()" title="Move to different group">Move</button>
            <button class="btn btn-danger" onclick="removeFromLibrary()" title="Remove from library">Remove</button>
            <button class="btn btn-danger hidden" id="deleteFromServerBtn" onclick="deleteFromServer()" title="Delete from community server">Delete from Server</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Community Detail Modal -->
  <div id="communityModal" class="modal-overlay hidden" onclick="closeCommunityModal(event)">
    <div class="dh-modal-wrapper">
      <button class="dh-modal-close" onclick="closeCommunityModal()" aria-label="Close">&times;</button>
      <div class="dh-modal-card" onclick="event.stopPropagation()">
        <div id="modalStatBlock"></div>
        <div class="dh-modal-footer">
          <div class="dh-modal-votes" id="modalVoteSection">
            <button class="vote-btn upvote" id="modalUpvoteBtn" onclick="voteOnConversion(1)" title="Upvote">&#9650;</button>
            <span class="vote-score" id="modalVoteScore">0</span>
            <button class="vote-btn downvote" id="modalDownvoteBtn" onclick="voteOnConversion(-1)" title="Downvote">&#9660;</button>
          </div>
          <div class="dh-modal-actions">
            <button class="btn" onclick="copyShareLink()" title="Copy share link">Share</button>
            <button class="btn" onclick="copyModalJSON()" title="Copy JSON">JSON</button>
            <button class="btn btn-save" onclick="addModalToLibrary()" title="Add to your library">Save</button>
            <button class="btn" onclick="addModalToGroup()" title="Add to a group">Group</button>
          </div>
          <div class="dh-modal-secondary">
            <span class="dh-modal-author" id="modalAuthor"></span>
            <div class="dh-modal-secondary-actions">
              <button class="dh-modal-delete hidden" id="modalDeleteBtn" onclick="deleteMyConversion()" title="Delete your submission">Delete</button>
              <button class="dh-modal-report" onclick="openReportModal()" title="Report this conversion">Report</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="reportModal" class="modal-overlay hidden" onclick="closeReportModal(event)">
    <div class="modal-content report-modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Report Conversion</h2>
        <button class="modal-close" onclick="closeReportModal()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <p class="report-conversion-name" id="reportConversionName"></p>
        <label class="form-label" for="reportReason">Why are you reporting this?</label>
        <textarea id="reportReason" class="form-textarea" rows="4" placeholder="Please describe the issue (e.g., inappropriate content, copyright violation, spam, incorrect data...)"></textarea>
        <p class="report-hint">Reports are reviewed by moderators. Please provide enough detail for us to understand the issue.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeReportModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitReport()">Submit Report</button>
      </div>
    </div>
  </div>

  <!-- Privacy Policy Modal -->
  <div id="privacyModal" class="privacy-modal" onclick="if(event.target === this) closePrivacyModal()">
    <div class="privacy-modal-content">
      <button class="close-btn" onclick="closePrivacyModal()" aria-label="Close">&times;</button>
      <h2>Privacy Policy</h2>

      <h3>What We Collect</h3>
      <p>When you sign in with Discord, we store only the following public profile information:</p>
      <ul>
        <li><strong>Discord Username</strong> - To show who created each submission</li>
        <li><strong>Discord Avatar URL</strong> - To display your profile picture</li>
        <li><strong>Discord User ID</strong> - To recognize you when you return</li>
      </ul>

      <h3>What We Don't Collect</h3>
      <p>We do not collect, store, or have access to:</p>
      <ul>
        <li>Your email address</li>
        <li>Your password</li>
        <li>Your Discord messages or servers</li>
        <li>Any private Discord information</li>
      </ul>

      <h3>How Your Data Is Used</h3>
      <p>Your information is used solely to:</p>
      <ul>
        <li>Attribute your community submissions to you</li>
        <li>Allow you to edit or delete your own submissions</li>
        <li>Track your votes (one vote per conversion)</li>
      </ul>

      <h3>Data Security</h3>
      <p>Your data is stored in a secure database hosted on Fly.io infrastructure. We use industry-standard JWT tokens for authentication, stored in secure HTTP-only cookies.</p>

      <h3>Data Deletion</h3>
      <p>You can delete your submissions at any time. If you wish to have your account completely removed, contact us and we will delete all your data.</p>

      <h3>Third Parties</h3>
      <p>We do not sell, share, or transfer your data to any third parties. Your information stays between you and this application.</p>

      <p style="margin-top: 2rem; font-size: 0.8rem; opacity: 0.7;">Last updated: January 2026</p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer">
    <p>This tool is not affiliated with, endorsed, or sponsored by Wizards of the Coast, Paizo Inc., or Darrington Press. All product names and trademarks are property of their respective owners.</p>
    <div class="footer-links">
      <a href="#" onclick="openFAQModal(); return false;">How's This Work?</a>
      <span class="footer-divider">|</span>
      <a href="#" onclick="openPrivacyModal(); return false;">Privacy Policy</a>
      <span class="footer-divider">|</span>
      <a href="https://buymeacoffee.com/marcusu" target="_blank" rel="noopener" class="coffee-footer-link">
        Help keep the lights on
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
          <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
          <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
          <line x1="6" y1="2" x2="6" y2="4"/>
          <line x1="10" y1="2" x2="10" y2="4"/>
          <line x1="14" y1="2" x2="14" y2="4"/>
        </svg>
      </a>
    </div>
    <div class="zs-credits" itemscope="" itemtype="https://schema.org/Organization">
      <a href="https://zealoussites.com" target="_blank" rel="noopener noreferrer nofollow" title="Website by Marcus Zeal @ Zealous Sites" aria-label="Website by Zealous Sites" itemprop="url">
        <span itemprop="name">
          Website by
          <svg height="20" viewBox="0 0 210 124" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M46.072 100V86.08L83.512 42.496L86.296 50.368H47.032V32.8H106.264V46.72L68.824 90.304L66.04 82.432H107.8V100H46.072ZM139.434 101.536C133.802 101.536 128.362 100.896 123.114 99.616C117.866 98.336 113.546 96.672 110.154 94.624L117.45 78.112C120.65 79.968 124.202 81.472 128.106 82.624C132.074 83.712 135.914 84.256 139.626 84.256C141.802 84.256 143.498 84.128 144.714 83.872C145.994 83.552 146.922 83.136 147.498 82.624C148.074 82.048 148.362 81.376 148.362 80.608C148.362 79.392 147.69 78.432 146.346 77.728C145.002 77.024 143.21 76.448 140.97 76C138.794 75.488 136.394 74.976 133.77 74.464C131.146 73.888 128.49 73.152 125.802 72.256C123.178 71.36 120.746 70.176 118.506 68.704C116.33 67.232 114.57 65.312 113.226 62.944C111.882 60.512 111.21 57.504 111.21 53.92C111.21 49.76 112.362 45.984 114.666 42.592C117.034 39.136 120.522 36.384 125.13 34.336C129.802 32.288 135.594 31.264 142.506 31.264C147.05 31.264 151.53 31.744 155.946 32.704C160.362 33.664 164.33 35.136 167.85 37.12L161.034 53.536C157.706 51.872 154.474 50.624 151.338 49.792C148.266 48.96 145.258 48.544 142.314 48.544C140.138 48.544 138.41 48.736 137.13 49.12C135.85 49.504 134.922 50.016 134.346 50.656C133.834 51.296 133.578 52 133.578 52.768C133.578 53.92 134.25 54.848 135.594 55.552C136.938 56.192 138.698 56.736 140.874 57.184C143.114 57.632 145.546 58.112 148.17 58.624C150.858 59.136 153.514 59.84 156.138 60.736C158.762 61.632 161.162 62.816 163.338 64.288C165.578 65.76 167.37 67.68 168.714 70.048C170.058 72.416 170.73 75.36 170.73 78.88C170.73 82.976 169.546 86.752 167.178 90.208C164.874 93.6 161.418 96.352 156.81 98.464C152.202 100.512 146.41 101.536 139.434 101.536Z" fill="currentColor"></path>
            <path d="M30.528 111.624C24.576 111.624 20.064 110.12 16.992 107.112C13.92 104.168 12.384 99.944 12.384 94.44V77.064C12.384 75.528 12 74.408 11.232 73.704C10.464 72.936 9.44 72.552 8.16 72.552H4.992V60.84H8.16C9.44 60.84 10.464 60.456 11.232 59.688C12 58.92 12.384 57.8 12.384 56.328V38.952C12.384 33.384 13.92 29.128 16.992 26.184C20.064 23.24 24.576 21.768 30.528 21.768H36.096V33.48H34.368C32.064 33.48 30.304 34.088 29.088 35.304C27.936 36.52 27.36 38.28 27.36 40.584V55.944C27.36 58.76 26.976 60.968 26.208 62.568C25.44 64.168 24.224 65.32 22.56 66.024C20.96 66.728 18.88 67.24 16.32 67.56V65.832C18.88 66.088 20.96 66.6 22.56 67.368C24.224 68.072 25.44 69.224 26.208 70.824C26.976 72.424 27.36 74.632 27.36 77.448V92.808C27.36 95.112 27.936 96.872 29.088 98.088C30.304 99.304 32.064 99.912 34.368 99.912H36.096V111.624H30.528Z" fill="currentColor"></path>
            <path d="M179.008 111.624H173.44V99.912H175.168C177.472 99.912 179.2 99.304 180.352 98.088C181.568 96.872 182.176 95.112 182.176 92.808V77.448C182.176 74.632 182.56 72.424 183.328 70.824C184.16 69.224 185.376 68.072 186.976 67.368C188.576 66.6 190.656 66.088 193.216 65.832V67.56C190.656 67.24 188.576 66.728 186.976 66.024C185.376 65.32 184.16 64.168 183.328 62.568C182.56 60.968 182.176 58.76 182.176 55.944V40.584C182.176 38.28 181.568 36.52 180.352 35.304C179.2 34.088 177.472 33.48 175.168 33.48H173.44V21.768H179.008C185.024 21.768 189.536 23.24 192.544 26.184C195.616 29.128 197.152 33.384 197.152 38.952V56.328C197.152 57.8 197.536 58.92 198.304 59.688C199.072 60.456 200.096 60.84 201.376 60.84H204.544V72.552H201.376C200.096 72.552 199.072 72.936 198.304 73.704C197.536 74.408 197.152 75.528 197.152 77.064V94.44C197.152 99.944 195.616 104.168 192.544 107.112C189.536 110.12 185.024 111.624 179.008 111.624Z" fill="currentColor"></path>
          </svg>
        </span>
      </a>
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast" role="alert" aria-live="assertive">
    <span class="toast-message" id="toastMessage"></span>
    <button class="toast-close" onclick="dismissToast()" aria-label="Dismiss notification">×</button>
    <div class="toast-progress" id="toastProgress"></div>
  </div>

  <!-- FAQ Modal -->
  <div id="faqModal" class="modal-overlay hidden" onclick="closeFAQModal(event)">
    <div class="modal-content faq-modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>How the Converter Works</h2>
        <button class="modal-close" onclick="closeFAQModal()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body faq-body">

        <section class="faq-section">
          <h3>Overview</h3>
          <p>This tool converts stat blocks from D&D 5e (and other systems) into Daggerheart format. It analyzes the original creature's statistics and translates them into Daggerheart's streamlined adversary system.</p>
        </section>

        <section class="faq-section">
          <h3>How are Tiers determined?</h3>
          <p>Daggerheart uses a 4-tier system instead of D&D's 30-level Challenge Rating scale. The conversion maps CR to tier as follows:</p>
          <table class="faq-table">
            <thead>
              <tr><th>D&D Challenge Rating</th><th>Daggerheart Tier</th></tr>
            </thead>
            <tbody>
              <tr><td>CR 0-1</td><td>Tier 1</td></tr>
              <tr><td>CR 2-4</td><td>Tier 2</td></tr>
              <tr><td>CR 5-10</td><td>Tier 3</td></tr>
              <tr><td>CR 11+</td><td>Tier 4</td></tr>
            </tbody>
          </table>
        </section>

        <section class="faq-section">
          <h3>How are Hit Points scaled?</h3>
          <p>Daggerheart uses much smaller HP pools than D&D 5e. Instead of directly converting HP, the tool assigns HP based on the creature's tier and type:</p>
          <table class="faq-table">
            <thead>
              <tr><th>Tier</th><th>Base HP</th></tr>
            </thead>
            <tbody>
              <tr><td>Tier 1</td><td>3 HP</td></tr>
              <tr><td>Tier 2</td><td>5 HP</td></tr>
              <tr><td>Tier 3</td><td>8 HP</td></tr>
              <tr><td>Tier 4</td><td>12 HP</td></tr>
            </tbody>
          </table>
          <p>Adversary types then modify this base HP. For example, Bruisers add +3 HP while Minions are always reduced to just 1 HP.</p>
        </section>

        <section class="faq-section">
          <h3>How is Difficulty set?</h3>
          <p>Difficulty is the target number players need to hit for attacks and ability checks against this adversary. It's determined purely by tier:</p>
          <table class="faq-table">
            <thead>
              <tr><th>Tier</th><th>Difficulty</th></tr>
            </thead>
            <tbody>
              <tr><td>Tier 1</td><td>11</td></tr>
              <tr><td>Tier 2</td><td>14</td></tr>
              <tr><td>Tier 3</td><td>17</td></tr>
              <tr><td>Tier 4</td><td>20</td></tr>
            </tbody>
          </table>
        </section>

        <section class="faq-section">
          <h3>How are Damage Thresholds calculated?</h3>
          <p>Damage thresholds determine when an adversary takes a Hit (Major threshold) or two Hits (Severe threshold). Base thresholds are set by tier:</p>
          <table class="faq-table">
            <thead>
              <tr><th>Tier</th><th>Major Threshold</th><th>Severe Threshold</th></tr>
            </thead>
            <tbody>
              <tr><td>Tier 1</td><td>7</td><td>12</td></tr>
              <tr><td>Tier 2</td><td>10</td><td>20</td></tr>
              <tr><td>Tier 3</td><td>20</td><td>32</td></tr>
              <tr><td>Tier 4</td><td>25</td><td>45</td></tr>
            </tbody>
          </table>
          <p>These are then modified by adversary type. Bruisers have 20% higher thresholds (harder to hurt), while Hordes have 20% lower thresholds (easier to damage).</p>
        </section>

        <section class="faq-section">
          <h3>How are Adversary Types chosen?</h3>
          <p>The converter analyzes the original creature to suggest the most appropriate Daggerheart adversary type:</p>
          <ul class="faq-list">
            <li><strong>Solo:</strong> Creatures with Legendary Actions become Solo adversaries (designed to fight an entire party)</li>
            <li><strong>Leader:</strong> High-CR creatures with Multiattack become Leaders (commanders that buff allies)</li>
            <li><strong>Bruiser:</strong> High-HP creatures (50+ HP) at CR 2+ become Bruisers (tough, close-quarters fighters)</li>
            <li><strong>Ranged:</strong> Creatures whose primary attack is ranged become Ranged adversaries</li>
            <li><strong>Skulk:</strong> Creatures with Stealth proficiency or ambush abilities become Skulks (hit-and-run tactics)</li>
            <li><strong>Support:</strong> Creatures with healing/buffing abilities at low CR become Support</li>
            <li><strong>Minion:</strong> Very low CR creatures (1/4 or less) become Minions (1 HP, defeated in groups)</li>
            <li><strong>Standard:</strong> Default for creatures that don't fit other categories</li>
          </ul>
        </section>

        <section class="faq-section">
          <h3>Type Modifiers</h3>
          <p>Each adversary type applies specific modifiers to the base statistics:</p>
          <table class="faq-table">
            <thead>
              <tr><th>Type</th><th>HP Mod</th><th>Stress Mod</th><th>Threshold Mod</th><th>Attack Mod</th></tr>
            </thead>
            <tbody>
              <tr><td>Bruiser</td><td>+3</td><td>+1</td><td>+20%</td><td>+0</td></tr>
              <tr><td>Horde</td><td>-1</td><td>+0</td><td>-20%</td><td>+0</td></tr>
              <tr><td>Leader</td><td>+1</td><td>+2</td><td>+10%</td><td>+1</td></tr>
              <tr><td>Minion</td><td>=1</td><td>+0</td><td>-50%</td><td>-1</td></tr>
              <tr><td>Ranged</td><td>-1</td><td>+0</td><td>-10%</td><td>+1</td></tr>
              <tr><td>Skulk</td><td>+0</td><td>+1</td><td>-10%</td><td>+0</td></tr>
              <tr><td>Social</td><td>-1</td><td>+2</td><td>-30%</td><td>-1</td></tr>
              <tr><td>Solo</td><td>+5</td><td>+3</td><td>+50%</td><td>+1</td></tr>
              <tr><td>Standard</td><td>+0</td><td>+0</td><td>+0%</td><td>+0</td></tr>
              <tr><td>Support</td><td>-1</td><td>+1</td><td>-20%</td><td>+0</td></tr>
            </tbody>
          </table>
        </section>

        <section class="faq-section">
          <h3>Damage Type Conversion</h3>
          <p>D&D has many damage types. Daggerheart simplifies these into two categories:</p>
          <ul class="faq-list">
            <li><strong>Physical (phy):</strong> Slashing, Piercing, Bludgeoning</li>
            <li><strong>Magic (mag):</strong> Fire, Cold, Lightning, Acid, Poison, Necrotic, Radiant, Force, Psychic, Thunder</li>
          </ul>
        </section>

        <section class="faq-section">
          <h3>Range Conversion</h3>
          <p>D&D ranges in feet are converted to Daggerheart's abstract range bands:</p>
          <table class="faq-table">
            <thead>
              <tr><th>D&D Range</th><th>Daggerheart Range</th></tr>
            </thead>
            <tbody>
              <tr><td>5 ft</td><td>Melee</td></tr>
              <tr><td>10 ft</td><td>Very Close</td></tr>
              <tr><td>11-30 ft</td><td>Close</td></tr>
              <tr><td>31-60 ft</td><td>Far</td></tr>
              <tr><td>60+ ft</td><td>Very Far</td></tr>
            </tbody>
          </table>
        </section>

        <section class="faq-section">
          <h3>Supported Input Formats</h3>
          <p>The converter accepts stat blocks in multiple formats:</p>
          <ul class="faq-list">
            <li><strong>Text:</strong> Copy-pasted stat blocks from PDFs, digital toolsets, VTTs, etc.</li>
            <li><strong>JSON:</strong> Most popular monster/creature JSON export formats are supported</li>
          </ul>
          <p>The system auto-detects the format - just paste and convert!</p>
        </section>

        <section class="faq-section">
          <h3>But these calculations SUCK!</h3>
          <p>You're kind of right. These calculations are not perfect for every adversary.</p>
          <p>A small fae may make more thematic sense to be difficult to hit. A beefy bruiser might be easy to hit but have a ton of HP. A cunning spellcaster might have low thresholds but dangerous abilities.</p>
          <p><strong>It is your job as the GM to edit these to fit your campaign.</strong></p>
          <p>I've given you the ability to edit every field after conversion and I highly recommend you do so to make the monster the best it can be. Use the converted stats as a starting point, then tweak the numbers until the adversary feels right for your table.</p>
        </section>

      </div>
    </div>
  </div>

  <!-- Load the modules -->
  <script src="/parsers/parser-manager.js"></script>
  <script src="/parsers/dnd5e-parser.js"></script>
  <script src="/parsers/pf2e-parser.js"></script>
  <script src="/parsers/dnd35e-parser.js"></script>
  <script src="/parsers/osr-parser.js"></script>
  <script src="/parsers/json-parser.js"></script>
  <script src="/dnd-parser.js"></script>
  <script src="/daggerheart-converter.js"></script>

  <script>
    // ==================== STATE ====================
    let currentParsed = null;
    let currentConverted = null;
    let parseDebounceTimer = null;
    let saveDebounceTimer = null;
    let currentMode = 'single';
    let currentSystem = 'auto';
    let detectedSystem = null;
    let batchResults = [];

    // Undo/Redo history
    let history = [];
    let historyIndex = -1;
    const MAX_HISTORY = 50;

    // Recent conversions
    const MAX_RECENT = 10;
    const STORAGE_KEYS = {
      recent: 'dnd-dh-recent',
      draft: 'dnd-dh-draft'
    };

    // ==================== SAMPLES BY SYSTEM ====================
    // These samples use SRD content (CC-BY-4.0 for 5e, OGL for 3.5e) or original creations
    const SAMPLES = {
      dnd5e: {
        // From 5e SRD (CC-BY-4.0)
        ogre: `Ogre
Large giant, chaotic evil
Armor Class 11 (hide armor)
Hit Points 59 (7d10 + 21)
Speed 40 ft.
STR 19 (+4) DEX 8 (-1) CON 16 (+3) INT 5 (-3) WIS 7 (-2) CHA 7 (-2)
Senses darkvision 60 ft., passive Perception 8
Languages Common, Giant
Challenge 2 (450 XP)

Actions
Greatclub. Melee Weapon Attack: +6 to hit, reach 5 ft., one target. Hit: 13 (2d8 + 4) bludgeoning damage.

Javelin. Melee or Ranged Weapon Attack: +6 to hit, reach 5 ft. or range 30/120 ft., one target. Hit: 11 (2d6 + 4) piercing damage.`,

        // From 5e SRD (CC-BY-4.0)
        wight: `Wight
Medium undead, neutral evil
Armor Class 14 (studded leather)
Hit Points 45 (6d8 + 18)
Speed 30 ft.
STR 15 (+2) DEX 14 (+2) CON 16 (+3) INT 10 (+0) WIS 13 (+1) CHA 15 (+2)
Skills Perception +3, Stealth +4
Damage Resistances necrotic; bludgeoning, piercing, and slashing from nonmagical attacks
Damage Immunities poison
Condition Immunities exhaustion, poisoned
Senses darkvision 60 ft., passive Perception 13
Languages the languages it knew in life
Challenge 3 (700 XP)

Sunlight Sensitivity. While in sunlight, the wight has disadvantage on attack rolls, as well as on Wisdom (Perception) checks that rely on sight.

Actions
Multiattack. The wight makes two longsword attacks or two longbow attacks. It can use its Life Drain in place of one longsword attack.

Life Drain. Melee Weapon Attack: +4 to hit, reach 5 ft., one creature. Hit: 5 (1d6 + 2) necrotic damage. The target must succeed on a DC 13 Constitution saving throw or its hit point maximum is reduced by an amount equal to the damage taken.

Longsword. Melee Weapon Attack: +4 to hit, reach 5 ft., one target. Hit: 6 (1d8 + 2) slashing damage.`
      },

      pf2e: {
        // Original creation in PF2e format
        ironscale: `Ironscale Warrior
Creature 3
[N] [Medium] [Humanoid] [Lizardfolk]
Perception +9; low-light vision
Languages Common, Draconic
Skills Athletics +10, Intimidation +7, Stealth +8, Survival +9
Str +4, Dex +2, Con +3, Int +0, Wis +2, Cha +1
Items hide armor, steel shield, trident
AC 19 (21 with shield raised); Fort +10, Ref +7, Will +7
HP 45
Shield Block [reaction]
Speed 25 feet, swim 20 feet

Melee [one-action] trident +11 (reach 10 feet), Damage 1d8+6 piercing
Melee [one-action] jaws +11, Damage 1d6+6 piercing
Melee [one-action] tail +11 (agile), Damage 1d4+6 bludgeoning
Ranged [one-action] trident +9 (thrown 20 feet), Damage 1d8+4 piercing

Deep Breath The ironscale warrior can hold their breath for 10 minutes.

Tail Sweep [two-actions] The warrior makes a tail Strike against each enemy within reach. Each attack counts toward their multiple attack penalty, but the penalty doesn't increase until after all attacks.`
      },

      dnd35e: {
        // From 3.5e SRD (OGL)
        ogre: `Ogre
CR 3
CE Large Giant
Init -1; Senses darkvision 60 ft., low-light vision; Listen +2, Spot +2

AC 16, touch 8, flat-footed 16 (-1 size, -1 Dex, +5 natural, +3 hide armor)
hp 29 (4d8+11)
Fort +6, Ref +0, Will +1

Speed 30 ft. (40 ft. base)
Melee greatclub +8 (2d8+7) or
Melee javelin +7 (1d8+5)
Ranged javelin +1 (1d8+5)
Space 10 ft.; Reach 10 ft.

Abilities Str 21, Dex 8, Con 15, Int 6, Wis 10, Cha 7
Base Atk +3; Grp +12
Feats Toughness, Weapon Focus (greatclub)
Skills Climb +5, Listen +2, Spot +2

Ogres are brutish creatures standing 9 to 10 feet tall and weighing 600 to 650 pounds. They favor overwhelming odds and ambush tactics.`
      },

      osr: {
        // Generic OSR stat block (common across many retroclones)
        skeleton: `Skeleton
AC: 7 [12]
HD: 1
Move: 60' (20')
Attacks: 1 (weapon)
Damage: 1d6 or by weapon
No. Appearing: 3d4 (3d10)
Save As: Fighter 1
Morale: 12
Treasure Type: None
Alignment: Chaotic

Animated bones of the dead, driven by dark magic. Immune to sleep, charm, and hold spells. Edged weapons deal half damage. Can be turned by clerics.`,

        // Generic OSR stat block
        goblin: `Goblin
AC: 6 [13]
HD: 1-1
Move: 60' (20')
Attacks: 1 (weapon)
Damage: 1d6 or by weapon
No. Appearing: 2d4 (6d10)
Save As: Normal Human
Morale: 7 (9 with leader)
Treasure Type: R (C)
Alignment: Chaotic

Small, cruel humanoids with sharp teeth and pointed ears. Fight with -1 penalty in bright sunlight. Often led by a chieftain (HD 2, 11 hp). Favor ambushes and overwhelming numbers.`
      }
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
      setupDragAndDrop();
      setupKeyboardShortcuts();
      loadDraft();
      renderRecentList();
      loadThemePreference();
      setupToastInteraction();
      checkAuthState();
      handleAuthRedirect();
      handleUrlRouting();
      loadFromURL();
      initDiceTooltips();
      initStickyHeaders();
    });

    // ==================== THEME TOGGLE ====================
    function toggleTheme() {
      const isLight = document.documentElement.classList.toggle('light-mode');
      localStorage.setItem('dnd-dh-theme', isLight ? 'light' : 'dark');
      showToast(isLight ? 'Light mode enabled' : 'Dark mode enabled', 'info');
    }

    function loadThemePreference() {
      const savedTheme = localStorage.getItem('dnd-dh-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
        document.documentElement.classList.add('light-mode');
      }

      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('dnd-dh-theme')) {
          document.documentElement.classList.toggle('light-mode', !e.matches);
        }
      });

      // Sync theme across tabs
      window.addEventListener('storage', (e) => {
        if (e.key === 'dnd-dh-theme') {
          document.documentElement.classList.toggle('light-mode', e.newValue === 'light');
        }
      });
    }

    // ==================== DRAG AND DROP ====================
    function setupDragAndDrop() {
      const dropZone = document.getElementById('dropZone');
      const textarea = document.getElementById('inputText');

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
      });

      dropZone.addEventListener('drop', handleDrop);

      function handleDrop(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            const reader = new FileReader();
            reader.onload = (event) => {
              textarea.value = event.target.result;
              handleLiveParse();
              saveDraft();
              showToast('File loaded: ' + file.name, 'info');
            };
            reader.readAsText(file);
          } else {
            showToast('Please drop a .txt file', 'error');
          }
        }
      }
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    const isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform) ||
                  (navigator.userAgentData?.platform === 'macOS');
    const modKey = isMac ? 'Cmd' : 'Ctrl';

    function hasModifier(e) {
      return isMac ? e.metaKey : e.ctrlKey;
    }

    function updateKeyboardHints() {
      // Update inline hints
      document.querySelectorAll('.keyboard-hint kbd, .shortcut-row kbd').forEach(kbd => {
        if (kbd.textContent === 'Ctrl' || kbd.textContent === 'Cmd') {
          kbd.textContent = modKey;
        }
      });
    }

    function setupKeyboardShortcuts() {
      // Update displayed keys on load
      updateKeyboardHints();

      document.addEventListener('keydown', (e) => {
        const isTyping = document.activeElement.tagName === 'TEXTAREA' ||
                         document.activeElement.tagName === 'INPUT';

        // ?: Show keyboard shortcuts (only when not typing)
        if (e.key === '?' && !isTyping) {
          e.preventDefault();
          openKeyboardModal();
          return;
        }
        // Cmd/Ctrl+Enter: Convert
        if (hasModifier(e) && e.key === 'Enter') {
          e.preventDefault();
          convert();
        }
        // Cmd/Ctrl+Shift+C: Copy JSON
        if (hasModifier(e) && e.shiftKey && e.key === 'C') {
          e.preventDefault();
          copyJSON();
        }
        // Cmd/Ctrl+Z: Undo
        if (hasModifier(e) && e.key === 'z' && !e.shiftKey) {
          if (!isTyping) {
            e.preventDefault();
            undo();
          }
        }
        // Cmd/Ctrl+Y or Cmd/Ctrl+Shift+Z: Redo
        if ((hasModifier(e) && e.key === 'y') || (hasModifier(e) && e.shiftKey && e.key === 'z')) {
          e.preventDefault();
          redo();
        }
        // Escape: Clear (only when not in modals)
        if (e.key === 'Escape') {
          const keyboardModal = document.getElementById('keyboardModal');
          if (keyboardModal && !keyboardModal.classList.contains('hidden')) {
            closeKeyboardModal();
            return;
          }
          e.preventDefault();
          clearAll();
        }
      });
    }

    // ==================== MODE TOGGLE ====================
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
        btn.setAttribute('aria-selected', btn.dataset.mode === mode);
      });
    }

    // ==================== DRAFT AUTO-SAVE ====================
    function saveDraft() {
      clearTimeout(saveDebounceTimer);
      saveDebounceTimer = setTimeout(() => {
        const input = document.getElementById('inputText').value;
        if (input.trim()) {
          localStorage.setItem(STORAGE_KEYS.draft, JSON.stringify({
            input: input,
            timestamp: Date.now()
          }));
          document.getElementById('draftIndicator').classList.remove('hidden');
          setTimeout(() => {
            document.getElementById('draftIndicator').classList.add('hidden');
          }, 2000);
        }
      }, 1000);
    }

    function loadDraft() {
      try {
        const draft = JSON.parse(localStorage.getItem(STORAGE_KEYS.draft));
        if (draft && draft.input) {
          const age = Date.now() - draft.timestamp;
          // Only load drafts less than 24 hours old
          if (age < 24 * 60 * 60 * 1000) {
            document.getElementById('inputText').value = draft.input;
            handleLiveParse();
            showToast('Draft restored', 'info');
          }
        }
      } catch (e) {
        // Ignore errors
      }
    }

    function clearDraft() {
      localStorage.removeItem(STORAGE_KEYS.draft);
    }

    // ==================== RECENT CONVERSIONS ====================
    function getRecent() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEYS.recent)) || [];
      } catch (e) {
        return [];
      }
    }

    function saveToRecent(converted) {
      const recent = getRecent();
      // Remove duplicates
      const filtered = recent.filter(r => r.id !== converted.id);
      // Add to front
      filtered.unshift({
        id: converted.id,
        name: converted.name,
        tier: converted.tier,
        advType: converted.advType,
        data: converted,
        timestamp: Date.now()
      });
      // Limit size
      const limited = filtered.slice(0, MAX_RECENT);
      localStorage.setItem(STORAGE_KEYS.recent, JSON.stringify(limited));
      renderRecentList();
    }

    function renderRecentList() {
      const recent = getRecent();
      const list = document.getElementById('recentList');

      if (recent.length === 0) {
        list.innerHTML = '<div class="recent-item" style="color: var(--text-secondary);">No recent conversions</div>';
        return;
      }

      list.innerHTML = recent.map((r, i) => `
        <div class="recent-item" role="menuitem" onclick="loadRecent(${i})">
          <div>
            <span class="recent-item-name">${escapeHtml(r.name)}</span>
            <span class="recent-item-tier">T${r.tier} ${r.advType}</span>
          </div>
          <span class="recent-item-delete" onclick="event.stopPropagation(); deleteRecent(${i})"
                title="Remove" aria-label="Remove from recent">×</span>
        </div>
      `).join('');
    }

    function loadRecent(index) {
      const recent = getRecent();
      if (recent[index]) {
        currentConverted = recent[index].data;
        currentParsed = null; // We don't have the parsed data
        pushHistory();
        renderPreview();
        renderJSON();
        renderMarkdown();
        renderText();
        enableButtons();
        toggleRecentMenu();
        showToast('Loaded: ' + recent[index].name, 'info');
      }
    }

    function deleteRecent(index) {
      const recent = getRecent();
      recent.splice(index, 1);
      localStorage.setItem(STORAGE_KEYS.recent, JSON.stringify(recent));
      renderRecentList();
    }

    function toggleRecentMenu() {
      const menu = document.getElementById('recentMenu');
      const btn = document.getElementById('recentBtn');
      const isOpen = menu.classList.toggle('show');
      btn.setAttribute('aria-expanded', isOpen);
    }

    function toggleCopyMenu() {
      closeMoreMenu();
      document.getElementById('copyMenu').classList.toggle('show');
    }

    function closeCopyMenu() {
      document.getElementById('copyMenu').classList.remove('show');
    }

    function toggleMoreMenu() {
      closeCopyMenu();
      document.getElementById('moreMenu').classList.toggle('show');
    }

    function closeMoreMenu() {
      document.getElementById('moreMenu').classList.remove('show');
    }

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.recent-dropdown')) {
        document.getElementById('recentMenu').classList.remove('show');
        document.getElementById('recentBtn').setAttribute('aria-expanded', 'false');
      }
      if (!e.target.closest('.action-dropdown')) {
        closeCopyMenu();
        closeMoreMenu();
      }
    });

    // ==================== UNDO/REDO ====================
    function pushHistory() {
      if (!currentConverted) return;

      // Remove any redo history
      history = history.slice(0, historyIndex + 1);

      // Add current state
      history.push(JSON.stringify(currentConverted));

      // Limit history size
      if (history.length > MAX_HISTORY) {
        history.shift();
      }

      historyIndex = history.length - 1;
      updateUndoRedoButtons();
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        currentConverted = JSON.parse(history[historyIndex]);
        renderAll();
        updateUndoRedoButtons();
        showToast('Undo', 'info');
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        currentConverted = JSON.parse(history[historyIndex]);
        renderAll();
        updateUndoRedoButtons();
        showToast('Redo', 'info');
      }
    }

    function updateUndoRedoButtons() {
      document.getElementById('undoBtn').disabled = historyIndex <= 0;
      document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
    }

    // ==================== LIVE PARSING ====================
    function handleLiveParse() {
      saveDraft();

      clearTimeout(parseDebounceTimer);
      parseDebounceTimer = setTimeout(() => {
        const input = document.getElementById('inputText').value.trim();

        if (input.length < 20) {
          document.getElementById('liveParsePreview').classList.add('hidden');
          updateDetectedSystemDisplay(null);
          return;
        }

        try {
          // For batch mode, only parse the first block for preview
          const firstBlock = currentMode === 'batch'
            ? input.split(/\n-{3,}\n/)[0]
            : input;

          let parsed;

          // Check for JSON input first (supports 5e.tools, Open5e, World Anvil, CritterDB, Foundry, Improved Initiative)
          if (typeof JSONParser !== 'undefined' && isJSONInput(firstBlock)) {
            try {
              parsed = JSONParser.parse(firstBlock);
              detectedSystem = parsed._meta?.system || 'json';
              updateDetectedSystemDisplay(parsed._meta?.detected);
              renderLivePreview(parsed);
              document.getElementById('liveParsePreview').classList.remove('hidden');
              return;
            } catch (e) {
              // Fall through to text parsers
              console.log('JSON parse failed, trying text parsers:', e.message);
            }
          }

          // Detect system if in auto mode
          if (typeof ParserManager !== 'undefined' && currentSystem === 'auto') {
            const detected = ParserManager.detectSystem(firstBlock);
            detectedSystem = detected.system;
            updateDetectedSystemDisplay(detected);
          }

          // Parse using appropriate parser
          if (typeof ParserManager !== 'undefined') {
            parsed = ParserManager.parse(firstBlock, { system: currentSystem });
          } else {
            parsed = DnDParser.parse(firstBlock);
          }

          renderLivePreview(parsed);
          document.getElementById('liveParsePreview').classList.remove('hidden');
        } catch (e) {
          console.error('Parse error:', e);
          document.getElementById('liveParsePreview').classList.add('hidden');
        }
      }, 300);
    }

    function renderLivePreview(parsed) {
      // Add system info if available
      const systemInfo = parsed._meta?.systemInfo;
      const systemLabel = systemInfo ? systemInfo.shortName : 'Unknown';

      const fields = [
        { label: 'System', value: systemLabel, confidence: parsed._meta?.detected?.confidence > 0.5 ? 'high' : 'medium' },
        { label: 'Name', value: parsed.name, confidence: parsed.name !== 'Unknown Creature' ? 'high' : 'low' },
        { label: 'CR/Lvl', value: parsed.level ? `Lvl ${parsed.level}` : parsed.cr.string, confidence: parsed.cr.numeric > 0 || parsed.level ? 'high' : 'medium' },
        { label: 'HP', value: parsed.hp.value, confidence: parsed.hp.value > 0 ? 'high' : 'low' },
        { label: 'AC', value: parsed.ac.value, confidence: parsed.ac.value > 0 ? 'high' : 'low' },
        { label: 'Type', value: parsed.typeInfo.type, confidence: parsed.typeInfo.type !== 'creature' ? 'high' : 'medium' },
        { label: 'Size', value: parsed.typeInfo.size, confidence: 'high' },
        { label: 'Actions', value: parsed.actions.length, confidence: parsed.actions.length > 0 ? 'high' : 'low' },
      ];

      document.getElementById('liveParseGrid').innerHTML = fields.map(f => `
        <div class="parse-field">
          <span class="confidence-badge confidence-${f.confidence}" aria-label="${f.confidence} confidence"></span>
          <span class="parse-field-label">${f.label}:</span>
          <span class="parse-field-value">${f.value}</span>
        </div>
      `).join('');
    }

    // ==================== SYSTEM HANDLING ====================
    function handleSystemChange() {
      currentSystem = document.getElementById('systemSelect').value;
      handleLiveParse();
    }

    function getActiveParser() {
      const system = currentSystem === 'auto' ? (detectedSystem || 'dnd5e') : currentSystem;

      // Use ParserManager if available, otherwise fall back to DnDParser
      if (typeof ParserManager !== 'undefined') {
        return { parser: ParserManager, system: system };
      }
      return { parser: DnDParser, system: 'dnd5e' };
    }

    function updateDetectedSystemDisplay(detected) {
      const display = document.getElementById('detectedSystem');
      if (detected && currentSystem === 'auto') {
        const confidence = Math.round(detected.confidence * 100);
        const name = detected.info?.shortName || detected.system;
        display.textContent = `Detected: ${name} (${confidence}%)`;
        display.style.color = confidence > 60 ? 'var(--success)' : 'var(--warning)';
      } else {
        display.textContent = '';
      }
    }

    // ==================== LOAD SAMPLE ====================
    function loadSample(system, name) {
      if (SAMPLES[system] && SAMPLES[system][name]) {
        document.getElementById('inputText').value = SAMPLES[system][name];
        // Set the system selector to match the sample
        document.getElementById('systemSelect').value = system;
        currentSystem = system;
        handleLiveParse();
        convert();
      } else {
        showToast('Sample not found', 'error');
      }
    }

    // ==================== CONVERT ====================
    function convert() {
      const input = document.getElementById('inputText').value.trim();
      if (!input) {
        showToast('Please paste a stat block to convert', 'error');
        return;
      }

      try {
        if (currentMode === 'batch') {
          convertBatch(input);
        } else {
          convertSingle(input);
        }

        clearDraft();
        showToast('Converted successfully!', 'success');
      } catch (e) {
        console.error('Conversion error:', e);
        handleParserError(e, input);
      }
    }

    function handleParserError(error, input) {
      let message = 'Error parsing stat block';
      let details = '';

      // Identify common parsing issues
      if (!input || input.length < 10) {
        message = 'Input too short';
        details = 'Please paste a complete stat block.';
      } else if (error.message.includes('undefined') || error.message.includes('null')) {
        message = 'Could not extract required fields';
        details = 'The stat block format may not be recognized. Try a different source format.';
      } else if (error.message.includes('name')) {
        message = 'Could not find creature name';
        details = 'Make sure the stat block includes the creature name at the top.';
      } else if (error.message.includes('HP') || error.message.includes('hit point')) {
        message = 'Could not parse hit points';
        details = 'Check that HP/Hit Points are included in the stat block.';
      } else if (error.message.includes('AC') || error.message.includes('armor')) {
        message = 'Could not parse armor class';
        details = 'Check that AC is included in the stat block.';
      } else {
        details = error.message;
      }

      showToast(`${message}: ${details}`, 'error');

      // Show more help in the preview area
      document.getElementById('statBlockPreview').innerHTML = `
        <div class="parser-error">
          <h3>Parsing Failed</h3>
          <p><strong>${message}</strong></p>
          <p>${details}</p>
          <h4>Tips:</h4>
          <ul>
            <li>Make sure you're pasting a complete stat block</li>
            <li>Try selecting "Auto-detect" for the source system</li>
            <li>Supported formats: D&D 5e, D&D 2024, Pathfinder 2e, 13th Age</li>
            <li>Copy stat blocks from official sources or VTTs</li>
          </ul>
        </div>
      `;
    }

    function convertSingle(input) {
      // Check for JSON input first (supports 5e.tools, Open5e, World Anvil, CritterDB, Foundry, Improved Initiative)
      if (typeof JSONParser !== 'undefined' && isJSONInput(input)) {
        try {
          currentParsed = JSONParser.parse(input);
          detectedSystem = currentParsed._meta?.system || 'json';
          updateDetectedSystemDisplay(currentParsed._meta?.detected);
          document.getElementById('adjustments').classList.remove('hidden');
          reconvert();
          return;
        } catch (e) {
          console.log('JSON parse failed, trying text parsers:', e.message);
        }
      }

      // Use ParserManager if available, otherwise fall back to DnDParser
      if (typeof ParserManager !== 'undefined') {
        currentParsed = ParserManager.parse(input, { system: currentSystem });
        // Update detected system display
        if (currentParsed._meta && currentParsed._meta.detected) {
          updateDetectedSystemDisplay(currentParsed._meta.detected);
        }
      } else {
        currentParsed = DnDParser.parse(input);
      }
      document.getElementById('adjustments').classList.remove('hidden');
      reconvert();
    }

    // Helper to detect if input looks like JSON
    function isJSONInput(input) {
      const trimmed = input.trim();
      return (trimmed.startsWith('{') && trimmed.endsWith('}')) ||
             (trimmed.startsWith('[') && trimmed.endsWith(']'));
    }

    function convertBatch(input) {
      const blocks = input.split(/\n-{3,}\n/).filter(b => b.trim());
      batchResults = [];

      const overrideTier = document.getElementById('overrideTier').value;
      const overrideType = document.getElementById('overrideType').value;
      const options = {};
      if (overrideTier) options.tier = parseInt(overrideTier);
      if (overrideType) options.type = overrideType;

      for (const block of blocks) {
        try {
          // Use ParserManager if available
          let parsed;
          if (typeof ParserManager !== 'undefined') {
            parsed = ParserManager.parse(block.trim(), { system: currentSystem });
          } else {
            parsed = DnDParser.parse(block.trim());
          }
          const converted = DaggerheartConverter.convert(parsed, options);
          batchResults.push({ success: true, data: converted });
          saveToRecent(converted);
        } catch (e) {
          batchResults.push({ success: false, error: e.message, input: block.substring(0, 50) });
        }
      }

      renderBatchResults();
      enableButtons();
    }

    function renderBatchResults() {
      const container = document.getElementById('statBlockPreview');

      const html = batchResults.map((result, i) => {
        if (result.success) {
          return `
            <div class="batch-item" data-index="${i}">
              <div class="batch-item-header" onclick="toggleBatchItem(${i})">
                <span><strong>${escapeHtml(result.data.name)}</strong> - Tier ${result.data.tier} ${result.data.advType}</span>
                <span class="collapsible-icon">▼</span>
              </div>
              <div class="batch-item-content">
                ${renderStatBlockHTML(result.data)}
              </div>
            </div>
          `;
        } else {
          return `
            <div class="batch-item" style="border-color: var(--error);">
              <div class="batch-item-header">
                <span style="color: var(--error);">Failed: ${escapeHtml(result.input)}...</span>
              </div>
              <div class="batch-item-content">
                <p style="color: var(--error);">${escapeHtml(result.error)}</p>
              </div>
            </div>
          `;
        }
      }).join('');

      container.innerHTML = `<div class="batch-results">${html}</div>`;

      // Set first successful result as current
      const firstSuccess = batchResults.find(r => r.success);
      if (firstSuccess) {
        currentConverted = firstSuccess.data;
        pushHistory();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    function toggleBatchItem(index) {
      const item = document.querySelector(`.batch-item[data-index="${index}"]`);
      item.classList.toggle('collapsed');
    }

    function reconvert() {
      if (!currentParsed) return;

      const overrideTier = document.getElementById('overrideTier').value;
      const overrideType = document.getElementById('overrideType').value;

      const options = {};
      if (overrideTier) options.tier = parseInt(overrideTier);
      if (overrideType) options.type = overrideType;

      currentConverted = DaggerheartConverter.convert(currentParsed, options);

      pushHistory();
      saveToRecent(currentConverted);
      renderAll();
      enableButtons();
    }

    function renderAll() {
      renderPreview();
      renderJSON();
      renderMarkdown();
      renderText();
    }

    function enableButtons() {
      document.getElementById('copyBtn').disabled = false;
      document.getElementById('copyDropdownBtn').disabled = false;
      document.getElementById('copyMdBtn').disabled = false;
      document.getElementById('copyTextBtn').disabled = false;
      document.getElementById('downloadBtn').disabled = false;
      document.getElementById('libraryBtn').disabled = false;
      document.getElementById('groupBtn').disabled = false;
      document.getElementById('shareBtn').disabled = false;
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('moreBtn').disabled = false;
      document.getElementById('printBtn').disabled = false;
      document.getElementById('urlBtn').disabled = false;
      updateSaveButtonState();
    }

    function updateSaveButtonState() {
      const saveBtn = document.getElementById('saveBtn');
      if (saveBtn) {
        if (!currentUser) {
          saveBtn.disabled = true;
          saveBtn.title = 'Sign in to save and publish';
        } else if (!currentConverted) {
          saveBtn.disabled = true;
          saveBtn.title = 'Convert a stat block first';
        } else {
          saveBtn.disabled = false;
          saveBtn.title = 'Save to library and publish to community';
        }
      }
    }

    // ==================== RENDER PREVIEW ====================
    function renderPreview() {
      if (!currentConverted) return;
      document.getElementById('statBlockPreview').innerHTML = renderStatBlockHTML(currentConverted);
      // Auto-resize all textareas
      document.querySelectorAll('.feature-desc-input').forEach(autoResizeTextarea);
    }

    function renderStatBlockHTML(c) {
      const featuresHTML = c.features.map((f, i) => `
        <div class="feature" data-index="${i}">
          <div class="feature-header">
            <input type="text" class="feature-name-input" value="${escapeHtml(f.name)}"
                   onchange="updateFeature(${i}, 'name', this.value)"
                   aria-label="Feature name">
            <button class="feature-type feature-type-${f.type.toLowerCase()}"
                  onclick="cycleFeatureType(${i})" title="Click to change type"
                  aria-label="Feature type: ${f.type}. Click to cycle.">${f.type}</button>
            <span class="feature-actions">
              <button class="feature-btn" onclick="removeFeature(${i})" title="Remove feature"
                      aria-label="Remove feature">✕</button>
            </span>
          </div>
          <textarea class="feature-desc-input"
                    onchange="updateFeature(${i}, 'desc', this.value)"
                    oninput="autoResizeTextarea(this)"
                    aria-label="Feature description">${escapeHtml(f.desc)}</textarea>
        </div>
      `).join('');

      const tagsHTML = c.tags.map((t, i) => `
        <span class="tag" onclick="removeTag(${i})">
          ${escapeHtml(t)}<span class="tag-remove" aria-label="Remove tag">×</span>
        </span>
      `).join('');

      const imageHTML = c.imageUrl
        ? `<img src="${escapeHtml(c.imageUrl)}" alt="${escapeHtml(c.name)}"
               class="stat-block-image-preview" onclick="document.getElementById('imageUrlInput').focus()"
               onerror="this.style.display='none'; document.querySelector('.image-placeholder').style.display='flex';">`
        : `<div class="image-placeholder" onclick="document.getElementById('imageUrlInput').focus()">
             Click to add image URL
           </div>`;

      return `
        <div class="stat-block-header">
          <input type="text" class="stat-block-name-input" value="${escapeHtml(c.name)}"
                 onchange="updateName(this.value)" aria-label="Adversary name">
          <div class="stat-block-type">Tier ${c.tier} ${c.advType}</div>
        </div>

        <div class="stat-block-image-section">
          ${imageHTML}
          <div class="image-input-row">
            <input type="url" id="imageUrlInput" class="image-url-input"
                   placeholder="Paste image URL or upload file"
                   value="${c.imageUrl ? escapeHtml(c.imageUrl) : ''}"
                   onchange="updateImageUrl(this.value)"
                   aria-label="Image URL">
            <label class="image-upload-btn" for="imageFileInput">Upload</label>
            <input type="file" id="imageFileInput" class="image-upload-input"
                   accept="image/*" onchange="handleImageUpload(this)">
          </div>
          <div class="image-hint">
            Max 1MB. Auto-resized to 600px wide, converted to WebP.
            <span class="image-hint-icon">?
              <span class="image-tooltip">
                Large image? Try <a href="https://squoosh.app" target="_blank" rel="noopener">Squoosh.app</a> to compress it first.
              </span>
            </span>
          </div>
          <div id="imageProcessing" class="image-processing" style="display: none;">Processing image...</div>
        </div>

        <div class="stat-block-desc">${escapeHtml(c.description)}</div>

        <div class="stat-line">
          <span class="stat-label">Motives:</span>
          <input type="text" class="stat-value-editable" value="${escapeHtml(c.motives)}"
                 onchange="updateStat('motives', this.value)" aria-label="Motives">
        </div>
        <div class="stat-line">
          <span class="stat-label">Tactics:</span>
          <input type="text" class="stat-value-editable" value="${escapeHtml(c.tactics)}"
                 onchange="updateStat('tactics', this.value)" aria-label="Tactics">
        </div>

        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-item-label">Difficulty</div>
            <input type="number" class="stat-item-input" value="${c.difficulty}"
                   onchange="updateStat('difficulty', parseInt(this.value))" aria-label="Difficulty">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Major</div>
            <input type="number" class="stat-item-input" value="${c.majorThresh}"
                   onchange="updateStat('majorThresh', parseInt(this.value))" aria-label="Major threshold">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Severe</div>
            <input type="number" class="stat-item-input" value="${c.severeThresh}"
                   onchange="updateStat('severeThresh', parseInt(this.value))" aria-label="Severe threshold">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">HP</div>
            <input type="number" class="stat-item-input" value="${c.hp}"
                   onchange="updateStat('hp', parseInt(this.value))" aria-label="Hit points">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Stress</div>
            <input type="number" class="stat-item-input" value="${c.stress}"
                   onchange="updateStat('stress', parseInt(this.value))" aria-label="Stress">
          </div>
          <div class="stat-item">
            <div class="stat-item-label">Attack</div>
            <input type="text" class="stat-item-input" value="${c.atkMod}"
                   onchange="updateStat('atkMod', this.value)" aria-label="Attack modifier">
          </div>
        </div>

        <div class="stat-line">
          <span class="stat-label">Weapon:</span>
          <input type="text" class="stat-value-editable" value="${escapeHtml(c.weapon)}"
                 onchange="updateStat('weapon', this.value)" style="width: 120px;" aria-label="Weapon">
          <span>(</span>
          <input type="text" class="stat-value-editable" value="${c.range}"
                 onchange="updateStat('range', this.value)" style="width: 80px;" aria-label="Range">
          <span>)</span>
        </div>
        <div class="stat-line">
          <span class="stat-label">Damage:</span>
          <input type="text" class="stat-value-editable" value="${c.damage}"
                 onchange="updateStat('damage', this.value)" style="width: 80px;" aria-label="Damage dice">
          <input type="text" class="stat-value-editable" value="${c.dmgType}"
                 onchange="updateStat('dmgType', this.value)" style="width: 40px;" aria-label="Damage type">
        </div>
        <div class="stat-line">
          <span class="stat-label">Experience:</span>
          <input type="text" class="stat-value-editable" value="${escapeHtml(c.experience)}"
                 onchange="updateStat('experience', this.value)" aria-label="Experience">
        </div>

        <!-- Features Section -->
        <div class="collapsible" id="featuresCollapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('featuresCollapsible')"
               role="button" aria-expanded="true" tabindex="0"
               onkeypress="if(event.key==='Enter')toggleCollapsible('featuresCollapsible')">
            <span class="collapsible-title">
              Features (${c.features.length})
              <span style="font-weight: normal; font-size: 0.75rem; color: var(--text-secondary);">click to edit</span>
            </span>
            <span class="collapsible-icon" aria-hidden="true">▼</span>
          </div>
          <div class="collapsible-content features-section">
            ${featuresHTML}
            <button class="add-feature-btn" onclick="addFeature()" aria-label="Add new feature">
              + Add Feature
            </button>
          </div>
        </div>

        <!-- Tags Section -->
        <div class="collapsible" id="tagsCollapsible">
          <div class="collapsible-header" onclick="toggleCollapsible('tagsCollapsible')"
               role="button" aria-expanded="true" tabindex="0"
               onkeypress="if(event.key==='Enter')toggleCollapsible('tagsCollapsible')">
            <span class="collapsible-title">Tags (${c.tags.length})</span>
            <span class="collapsible-icon" aria-hidden="true">▼</span>
          </div>
          <div class="collapsible-content tags-section">
            <div class="tags">
              ${tagsHTML}
              <input type="text" class="add-tag-input" placeholder="+ tag"
                     onkeypress="if(event.key==='Enter'){addTag(this.value);this.value='';}"
                     aria-label="Add new tag">
            </div>
          </div>
        </div>
      `;
    }

    function toggleCollapsible(id) {
      const el = document.getElementById(id);
      el.classList.toggle('collapsed');
      const header = el.querySelector('.collapsible-header');
      header.setAttribute('aria-expanded', !el.classList.contains('collapsed'));
    }

    // Read-only version for community viewing - Daggerheart rulebook style
    function renderStatBlockReadOnly(c) {
      if (!c) return '<p>No data available</p>';

      // Build features HTML
      const featuresHTML = (c.features || []).map(f => {
        const typeClass = (f.type || 'passive').toLowerCase();
        // Escape first, then highlight dice rolls
        const descWithDice = highlightDiceRolls(escapeHtml(f.desc || ''));
        return `
          <div class="dh-stat-block-feature">
            <span class="dh-stat-block-feature-name">${escapeHtml(f.name)}</span> -
            <span class="dh-stat-block-feature-type ${typeClass}">${f.type || 'Passive'}</span>:
            ${descWithDice}
          </div>
        `;
      }).join('');

      // Build tags HTML
      const tagsHTML = (c.tags || []).map(t => `
        <span class="dh-stat-block-tag">${escapeHtml(t)}</span>
      `).join('');

      // Build motives & tactics line
      let motivesLine = '';
      if (c.motives || c.tactics) {
        const parts = [];
        if (c.motives) parts.push(escapeHtml(c.motives));
        if (c.tactics) parts.push(escapeHtml(c.tactics));
        motivesLine = `
          <div class="dh-stat-block-motives">
            <strong>Motives & Tactics:</strong> ${parts.join('. ')}
          </div>
        `;
      }

      // Build attack line with dice highlighting
      let attackLine = '';
      if (c.atkMod) {
        const damageWithHighlight = highlightDiceRolls(escapeHtml(c.damage || '?'));
        attackLine = `
          <div class="dh-stat-block-stats-line">
            <span class="stat-item"><span class="label">ATK:</span> ${c.atkMod}</span><span class="separator">|</span><span class="stat-item"><span class="label">${escapeHtml(c.weapon || 'Attack')}:</span> ${c.range || 'Melee'}</span><span class="separator">|</span><span class="stat-item">${damageWithHighlight} ${c.dmgType || 'phy'}</span>
          </div>
        `;
      }

      // Build experience line
      let expLine = '';
      if (c.experience) {
        expLine = `
          <div class="dh-stat-block-experience">
            <strong>Experience:</strong> ${escapeHtml(c.experience)}
          </div>
        `;
      }

      // Image (floated right if present)
      const imageHTML = c.imageUrl
        ? `<img src="${escapeHtml(c.imageUrl)}" alt="${escapeHtml(c.name)}" class="dh-stat-block-image">`
        : '';

      const advTypeClass = (c.advType || 'standard').toLowerCase().trim();

      return `
        <div class="dh-stat-block">
          <div class="dh-stat-block-header" data-type="${advTypeClass}">
            <div class="dh-header-main">
              <div class="dh-stat-block-name">${escapeHtml(c.name || 'Unknown')}</div>
              <div class="dh-stat-block-tier">Tier ${c.tier || '?'} ${c.advType || 'Standard'}</div>
            </div>
            <div class="dh-compact-stats">
              <span class="dh-compact-stat"><strong>Diff:</strong> ${c.difficulty || '?'}</span>
              <span class="dh-compact-divider">|</span>
              <span class="dh-compact-stat">${c.majorThresh || '?'}/${c.severeThresh || '?'}</span>
              <span class="dh-compact-divider">|</span>
              <span class="dh-compact-stat"><i class="fa-solid fa-heart"></i> ${c.hp || '?'}</span>
              <span class="dh-compact-divider">|</span>
              <span class="dh-compact-stat"><i class="fa-solid fa-bolt"></i> ${c.stress || '?'}</span>
            </div>
          </div>
          <div class="dh-stat-block-body">
            ${imageHTML}
            ${c.description ? `<div class="dh-stat-block-desc">${escapeHtml(c.description)}</div>` : ''}
            ${motivesLine}
            <div class="dh-vitals-row">
              <div class="dh-vital-box difficulty">
                <span class="dh-vital-value">${c.difficulty || '?'}</span>
                <span class="dh-vital-label">Difficulty</span>
              </div>
              <div class="dh-vital-box hp">
                <span class="dh-vital-value">${c.hp || '?'}</span>
                <span class="dh-vital-label">HP</span>
              </div>
              <div class="dh-vital-box stress">
                <span class="dh-vital-value">${c.stress || '?'}</span>
                <span class="dh-vital-label">Stress</span>
              </div>
            </div>
            <div class="damage-tracker-container">
              <div class="damage-scale-wrapper">
                <div class="damage-cards-row">
                  <!-- Card 1: Minor Damage (Symmetrical notches) -->
                  <div class="damage-card-wrapper">
                    <div class="damage-card-container">
                      <div class="damage-card-body">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 250 120">
                          <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975" stroke="none">
                            <path d="M -974.223 2292.978 L -974.223 2042.978 L -874.223 1942.978 L -874.223 1442.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                          </g>
                        </svg>
                      </div>
                      <div class="damage-card-text">Minor<br>Damage</div>
                    </div>
                    <div class="damage-card-footer">
                      <p class="damage-card-footer-text">Mark 1 HP</p>
                    </div>
                  </div>

                  <!-- Connector 1 -->
                  <div class="damage-connector">
                    <span class="damage-connector-number">${c.majorThresh || '?'}</span>
                  </div>

                  <!-- Card 2: Major Damage (Arrow on left) -->
                  <div class="damage-card-wrapper">
                    <div class="damage-card-container">
                      <div class="damage-card-body">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 250 120">
                          <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975" stroke="none">
                            <path d="M -974.223 2292.978 L -974.223 2042.978 L -624.223 1692.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                            <path d="M -974.223 1842.978 L -974.223 1542.978 L -824.223 1692.978 L -974.223 1842.978 Z"/>
                          </g>
                        </svg>
                      </div>
                      <div class="damage-card-text">Major<br>Damage</div>
                    </div>
                    <div class="damage-card-footer">
                      <p class="damage-card-footer-text">Mark 2 HP</p>
                    </div>
                  </div>

                  <!-- Connector 2 -->
                  <div class="damage-connector">
                    <span class="damage-connector-number">${c.severeThresh || '?'}</span>
                  </div>

                  <!-- Card 3: Severe Damage (Arrow on left) -->
                  <div class="damage-card-wrapper">
                    <div class="damage-card-container">
                      <div class="damage-card-body">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 250 120">
                          <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975" stroke="none">
                            <path d="M -974.223 2292.978 L -974.223 2042.978 L -624.223 1692.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                            <path d="M -974.223 1842.978 L -974.223 1542.978 L -824.223 1692.978 L -974.223 1842.978 Z"/>
                          </g>
                        </svg>
                      </div>
                      <div class="damage-card-text">Severe<br>Damage</div>
                    </div>
                    <div class="damage-card-footer">
                      <p class="damage-card-footer-text">Mark 3 HP</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            ${attackLine}
            ${expLine}
            ${(c.features && c.features.length > 0) ? `
              <div class="dh-stat-block-features">
                <div class="dh-stat-block-features-title">Features</div>
                ${featuresHTML}
              </div>
            ` : ''}
            ${(c.tags && c.tags.length > 0) ? `
              <div class="dh-stat-block-tags">${tagsHTML}</div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // ==================== EDITING FUNCTIONS ====================
    function updateStat(key, value) {
      if (currentConverted) {
        currentConverted[key] = value;
        pushHistory();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    function updateImageUrl(url) {
      if (currentConverted) {
        currentConverted.imageUrl = url.trim();
        pushHistory();
        renderPreview();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    function updateName(name) {
      if (currentConverted) {
        currentConverted.name = name.trim();
        currentConverted.id = 'adv-' + name.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '');
        pushHistory();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    async function handleImageUpload(input) {
      const file = input.files?.[0];
      if (!file) return;

      const MAX_SIZE = 1 * 1024 * 1024; // 1MB
      const TARGET_WIDTH = 600;

      // Check file size
      if (file.size > MAX_SIZE) {
        showToast('Image too large. Max size is 1MB. Try compressing it with Squoosh.app', 'error');
        input.value = '';
        return;
      }

      const processingEl = document.getElementById('imageProcessing');
      if (processingEl) processingEl.style.display = 'block';

      try {
        // Read file as data URL
        const dataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        // Load image
        const img = await new Promise((resolve, reject) => {
          const image = new Image();
          image.onload = () => resolve(image);
          image.onerror = reject;
          image.src = dataUrl;
        });

        // Calculate new dimensions (resize to 600px wide, maintain aspect ratio)
        let width = img.width;
        let height = img.height;

        if (width > TARGET_WIDTH) {
          height = Math.round((height * TARGET_WIDTH) / width);
          width = TARGET_WIDTH;
        }

        // Create canvas and draw resized image
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        // Convert to WebP
        const webpDataUrl = canvas.toDataURL('image/webp', 0.85);

        // Check final size
        const base64Length = webpDataUrl.length - 'data:image/webp;base64,'.length;
        const finalSize = Math.ceil(base64Length * 0.75);

        if (finalSize > MAX_SIZE) {
          showToast('Processed image still too large. Try a smaller image or use Squoosh.app', 'error');
          input.value = '';
          return;
        }

        // Update the image URL input and save
        document.getElementById('imageUrlInput').value = webpDataUrl;
        updateImageUrl(webpDataUrl);

        const sizeKB = Math.round(finalSize / 1024);
        showToast(`Image uploaded: ${width}x${height}, ${sizeKB}KB`, 'success');

      } catch (err) {
        showToast('Failed to process image: ' + err.message, 'error');
      } finally {
        if (processingEl) processingEl.style.display = 'none';
        input.value = ''; // Reset input for future uploads
      }
    }

    function updateFeature(index, field, value) {
      if (currentConverted && currentConverted.features[index]) {
        currentConverted.features[index][field] = value;
        pushHistory();
        renderJSON();
        renderMarkdown();
        renderText();
      }
    }

    function cycleFeatureType(index) {
      if (!currentConverted || !currentConverted.features[index]) return;
      const types = ['Passive', 'Action', 'Reaction'];
      const current = currentConverted.features[index].type;
      const nextIndex = (types.indexOf(current) + 1) % types.length;
      currentConverted.features[index].type = types[nextIndex];
      pushHistory();
      renderPreview();
      renderJSON();
      renderMarkdown();
      renderText();
    }

    function removeFeature(index) {
      if (currentConverted && currentConverted.features[index]) {
        currentConverted.features.splice(index, 1);
        pushHistory();
        renderPreview();
        renderJSON();
        renderMarkdown();
        renderText();
        showToast('Feature removed', 'info');
      }
    }

    function addFeature() {
      if (!currentConverted) return;
      currentConverted.features.push({
        name: 'New Feature',
        type: 'Passive',
        desc: 'Description here...'
      });
      pushHistory();
      renderPreview();
      renderJSON();
      renderMarkdown();
      renderText();
      // Focus the new feature name input
      setTimeout(() => {
        const inputs = document.querySelectorAll('.feature-name-input');
        if (inputs.length > 0) {
          inputs[inputs.length - 1].focus();
          inputs[inputs.length - 1].select();
        }
      }, 50);
    }

    function addTag(tag) {
      if (!currentConverted || !tag.trim()) return;
      currentConverted.tags.push(tag.trim().toLowerCase());
      pushHistory();
      renderPreview();
      renderJSON();
    }

    function removeTag(index) {
      if (currentConverted && currentConverted.tags[index] !== undefined) {
        currentConverted.tags.splice(index, 1);
        pushHistory();
        renderPreview();
        renderJSON();
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * Calculate dice roll range (min and max)
     * @param {string} diceNotation - e.g., "2d6+3", "1d8", "3d12-2"
     * @returns {object} - { min, max, avg }
     */
    function calculateDiceRange(diceNotation) {
      // Pattern: XdY+Z or XdY-Z or just XdY
      const match = diceNotation.match(/(\d+)d(\d+)([+-]\d+)?/i);
      if (!match) return null;

      const numDice = parseInt(match[1]);
      const dieSize = parseInt(match[2]);
      const modifier = match[3] ? parseInt(match[3]) : 0;

      const min = numDice + modifier; // All 1s
      const max = (numDice * dieSize) + modifier; // All max
      const avg = Math.floor((min + max) / 2);

      return { min, max, avg };
    }

    /**
     * Highlight dice notation in text with interactive tooltips
     * @param {string} text - Text containing dice notation
     * @returns {string} - HTML with highlighted dice rolls
     */
    function highlightDiceRolls(text) {
      if (!text) return '';

      // Pattern to match dice notation: 1d6, 2d8+3, 3d12-2, etc.
      const dicePattern = /(\d+d\d+(?:[+-]\d+)?)/gi;

      return text.replace(dicePattern, (match) => {
        const range = calculateDiceRange(match);
        if (range) {
          const rangeText = `Range: ${range.min}–${range.max} (avg ${range.avg})`;
          return `<span class="dice-roll" data-range="${rangeText}">${match}</span>`;
        }
        return match;
      });
    }

    /**
     * Initialize dice roll tooltip system
     * Uses a fixed-position element to escape modal overflow clipping
     */
    function initDiceTooltips() {
      const tooltip = document.getElementById('dice-tooltip');
      if (!tooltip) return;

      // Use event delegation on document to catch all dice rolls
      document.addEventListener('mouseenter', (e) => {
        const diceRoll = e.target.closest('.dice-roll[data-range]');
        if (!diceRoll) return;

        const range = diceRoll.getAttribute('data-range');
        if (!range) return;

        tooltip.textContent = range;

        // Position the tooltip
        const rect = diceRoll.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();

        // Calculate center position above the element
        let left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);
        let top = rect.top - tooltip.offsetHeight - 8;

        // Ensure tooltip stays within viewport bounds
        const padding = 10;

        // Check left edge
        if (left < padding) {
          left = padding;
        }
        // Check right edge
        if (left + tooltip.offsetWidth > window.innerWidth - padding) {
          left = window.innerWidth - tooltip.offsetWidth - padding;
        }
        // If too close to top, show below instead
        if (top < padding) {
          top = rect.bottom + 8;
        }

        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        tooltip.classList.add('visible');
      }, true);

      document.addEventListener('mouseleave', (e) => {
        const diceRoll = e.target.closest('.dice-roll[data-range]');
        if (!diceRoll) return;
        tooltip.classList.remove('visible');
      }, true);
    }

    // Legacy function - now a no-op since tooltips use event delegation
    function positionDiceTooltips(container) {
      // Tooltips now use fixed positioning with event delegation
      // This function is kept for backward compatibility
    }

    /**
     * Initialize sticky header scroll behavior for modals
     * Headers shrink when user scrolls down
     */
    function initStickyHeaders() {
      // Use event delegation for scroll events on modal cards
      document.querySelectorAll('.dh-modal-card').forEach(modal => {
        modal.addEventListener('scroll', () => {
          const header = modal.querySelector('.dh-stat-block-header');
          if (header) {
            // Use hysteresis: compact at 30px, but only expand back at 5px
            // This prevents the animation from interfering with scroll-to-top
            if (modal.scrollTop > 30) {
              header.classList.add('compact');
            } else if (modal.scrollTop <= 5) {
              header.classList.remove('compact');
            }
          }
        });
      });
    }

    // Escape for use in JavaScript string literals inside HTML attributes
    // Must escape for JS first, then HTML-encode for the attribute context
    function escapeJsString(text) {
      if (!text) return '';
      return String(text)
        // First: escape for JavaScript
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        // Then: HTML-encode special chars for the HTML attribute context
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    // ==================== RENDER JSON ====================
    function renderJSON() {
      if (!currentConverted) return;
      const exportObj = getExportObject();
      document.getElementById('jsonOutput').textContent = JSON.stringify(exportObj, null, 2);
    }

    // ==================== RENDER MARKDOWN ====================
    function renderMarkdown() {
      if (!currentConverted) return;
      const c = currentConverted;

      const featuresText = c.features.map(f =>
        `**${f.name}** *(${f.type})*: ${f.desc}`
      ).join('\n\n');

      const imageSection = c.imageUrl ? `![${c.name}](${c.imageUrl})\n\n` : '';

      const md = `# ${c.name}
*Tier ${c.tier} ${c.advType}*

${imageSection}${c.description}

**Motives:** ${c.motives}
**Tactics:** ${c.tactics}

| Stat | Value |
|------|-------|
| Difficulty | ${c.difficulty} |
| Thresholds | ${c.majorThresh}/${c.severeThresh} |
| HP | ${c.hp} |
| Stress | ${c.stress} |
| Attack | ${c.atkMod} |
| Damage | ${c.damage} ${c.dmgType} |

**Weapon:** ${c.weapon} (${c.range})
**Experience:** ${c.experience}

## Features

${featuresText}

---
*Tags: ${c.tags.join(', ')}*`;

      document.getElementById('markdownOutput').textContent = md;
    }

    // ==================== RENDER TEXT ====================
    function renderText() {
      if (!currentConverted) return;
      const c = currentConverted;

      const featuresText = c.features.map(f =>
        `${f.name} - ${f.type}: ${f.desc}`
      ).join('\n');

      const imageSection = c.imageUrl ? `Image: ${c.imageUrl}\n\n` : '';

      const text = `${c.name.toUpperCase()}
Tier ${c.tier} ${c.advType}

${imageSection}${c.description}
Motives & Tactics: ${c.motives}
Difficulty: ${c.difficulty} | Thresholds: ${c.majorThresh}/${c.severeThresh} | HP: ${c.hp} | Stress: ${c.stress}
ATK: ${c.atkMod} | ${c.weapon}: ${c.range} | ${c.damage} ${c.dmgType}
Experience: ${c.experience}

FEATURES
${featuresText}

Tags: ${c.tags.join(', ')}`;

      document.getElementById('textOutput').textContent = text;
    }

    // ==================== TABS ====================
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => {
        const isActive = t.dataset.tab === tab;
        t.classList.toggle('active', isActive);
        t.setAttribute('aria-selected', isActive);
      });

      ['preview', 'json', 'markdown', 'text'].forEach(t => {
        document.getElementById(t + 'Tab').classList.toggle('hidden', t !== tab);
      });
    }

    // ==================== EXPORT FUNCTIONS ====================
    function getExportObject() {
      const exportObj = { ...currentConverted };
      delete exportObj._converted;
      delete exportObj._sourceCR;
      delete exportObj._sourceHP;
      return exportObj;
    }

    function animateCopyButton(buttonId, originalText) {
      const btn = document.getElementById(buttonId);
      if (!btn) return;
      btn.innerHTML = '✓ Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('copied');
      }, 2000);
    }

    function copyJSON() {
      if (!currentConverted) {
        showToast('Nothing to copy. Convert a stat block first.', 'error');
        return;
      }
      const exportObj = getExportObject();
      navigator.clipboard.writeText(JSON.stringify(exportObj, null, 2))
        .then(() => {
          showToast('JSON copied!', 'success');
          animateCopyButton('copyBtn', 'Copy JSON');
        })
        .catch(() => showToast('Failed to copy', 'error'));
    }

    function copyMarkdown() {
      if (!currentConverted) {
        showToast('Nothing to copy. Convert a stat block first.', 'error');
        return;
      }
      navigator.clipboard.writeText(document.getElementById('markdownOutput').textContent)
        .then(() => {
          showToast('Markdown copied!', 'success');
          animateCopyButton('copyMdBtn', 'Copy MD');
        })
        .catch(() => showToast('Failed to copy', 'error'));
    }

    function copyText() {
      if (!currentConverted) {
        showToast('Nothing to copy. Convert a stat block first.', 'error');
        return;
      }
      navigator.clipboard.writeText(document.getElementById('textOutput').textContent)
        .then(() => {
          showToast('Text copied!', 'success');
          animateCopyButton('copyTextBtn', 'Copy Text');
        })
        .catch(() => showToast('Failed to copy', 'error'));
    }

    function downloadJSON() {
      if (!currentConverted) {
        showToast('Nothing to download. Convert a stat block first.', 'error');
        return;
      }
      const exportObj = getExportObject();
      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentConverted.id}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Downloaded: ' + currentConverted.id + '.json', 'success');
    }

    function shareAsURL() {
      if (!currentConverted) {
        showToast('Nothing to share. Convert a stat block first.', 'error');
        return;
      }
      try {
        const exportObj = getExportObject();
        const json = JSON.stringify(exportObj);
        const encoded = btoa(encodeURIComponent(json));
        const shareUrl = `${window.location.origin}${window.location.pathname}?d=${encoded}`;

        if (shareUrl.length > 8000) {
          showToast('Conversion too large to share via URL. Use JSON copy instead.', 'warning');
          return;
        }

        navigator.clipboard.writeText(shareUrl)
          .then(() => {
            showToast('Share URL copied! Anyone with this link can view this conversion.', 'success');
            animateCopyButton('urlBtn', 'URL');
          })
          .catch(() => showToast('Failed to copy URL', 'error'));
      } catch (e) {
        console.error('Share URL error:', e);
        showToast('Failed to create share URL', 'error');
      }
    }

    function loadFromURL() {
      const params = new URLSearchParams(window.location.search);
      const data = params.get('d');

      if (data) {
        try {
          const json = decodeURIComponent(atob(data));
          const conversion = JSON.parse(json);

          // Validate it looks like a conversion
          if (!conversion.name || !conversion.category) {
            throw new Error('Invalid conversion data');
          }

          // Load the conversion
          currentConverted = conversion;
          renderAll();
          enableButtons();

          // Clear the URL parameter to avoid confusion
          window.history.replaceState({}, '', window.location.pathname);

          showToast(`Loaded shared conversion: ${conversion.name}`, 'success');
          showPage('converter');
        } catch (e) {
          console.error('Failed to load from URL:', e);
          showToast('Invalid or corrupted share link', 'error');
        }
      }
    }

    function addToLibrary() {
      if (!currentConverted) {
        showToast('Nothing to add. Convert a stat block first.', 'error');
        return;
      }

      // Try to add to the main app's library if available
      try {
        // Check if we're in an iframe or have access to parent
        if (window.opener && window.opener.addToLibraryFromConverter) {
          window.opener.addToLibraryFromConverter(getExportObject());
          showToast('Added to library!', 'success');
          return;
        }

        // Check localStorage for the main app's library
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const exportObj = getExportObject();
        exportObj._userCreated = true;

        // Check for duplicates
        const exists = existingLibrary.some(item => item.id === exportObj.id);
        if (exists) {
          // Update existing
          const index = existingLibrary.findIndex(item => item.id === exportObj.id);
          existingLibrary[index] = exportObj;
          showToast('Updated in library!', 'success');
        } else {
          existingLibrary.push(exportObj);
          showToast('Added to library!', 'success');
        }

        localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
      } catch (e) {
        console.error(e);
        showToast('Could not add to library: ' + e.message, 'error');
      }
    }

    function addConvertedToGroup() {
      if (!currentConverted) {
        showToast('Nothing to add. Convert a stat block first.', 'error');
        return;
      }

      // First add to library if not already there
      try {
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const exportObj = getExportObject();
        exportObj._userCreated = true;

        const existing = existingLibrary.findIndex(item => item.id === exportObj.id);
        if (existing < 0) {
          existingLibrary.push(exportObj);
          localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
        }

        // Then open group selection modal
        addAdversaryToGroup(exportObj);
      } catch (e) {
        console.error(e);
        showToast('Could not add to group: ' + e.message, 'error');
      }
    }

    // ==================== CLEAR ====================
    function clearAll() {
      document.getElementById('inputText').value = '';
      document.getElementById('liveParsePreview').classList.add('hidden');
      document.getElementById('adjustments').classList.add('hidden');
      document.getElementById('overrideTier').value = '';
      document.getElementById('overrideType').value = '';

      ['copyBtn', 'copyDropdownBtn', 'copyMdBtn', 'copyTextBtn', 'downloadBtn', 'libraryBtn', 'groupBtn', 'shareBtn', 'saveBtn', 'moreBtn', 'printBtn', 'urlBtn'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = true;
      });

      document.getElementById('statBlockPreview').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon" aria-hidden="true">⚔️</div>
          <div>Paste a stat block and press <kbd>Ctrl</kbd>+<kbd>Enter</kbd></div>
          <div style="margin-top: 0.5rem; font-size: 0.85rem;">or click "Convert to Daggerheart"</div>
        </div>
      `;
      document.getElementById('jsonOutput').textContent = '// JSON output will appear here';
      document.getElementById('markdownOutput').textContent = 'Markdown output will appear here';
      document.getElementById('textOutput').textContent = 'Text output will appear here';

      currentParsed = null;
      currentConverted = null;
      batchResults = [];
      history = [];
      historyIndex = -1;
      updateUndoRedoButtons();

      clearDraft();
      showToast('Cleared', 'info');
    }

    // ==================== TOAST ====================
    let toastTimeout = null;
    let toastStartTime = null;
    let toastDuration = 3000;
    let toastRemainingTime = 0;
    let toastProgressInterval = null;

    function setupToastInteraction() {
      const toast = document.getElementById('toast');

      toast.addEventListener('mouseenter', () => {
        pauseToast();
      });

      toast.addEventListener('mouseleave', () => {
        resumeToast();
      });

      // Also pause on focus (for keyboard users)
      toast.addEventListener('focusin', () => {
        pauseToast();
      });

      toast.addEventListener('focusout', (e) => {
        // Only resume if focus left the toast entirely
        if (!toast.contains(e.relatedTarget)) {
          resumeToast();
        }
      });
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastProgress = document.getElementById('toastProgress');

      // Clear any existing timeout
      if (toastTimeout) {
        clearTimeout(toastTimeout);
      }
      if (toastProgressInterval) {
        clearInterval(toastProgressInterval);
      }

      toastMessage.textContent = message;
      toast.className = `toast toast-${type} show`;
      toastProgress.style.width = '100%';

      toastDuration = 3000;
      toastStartTime = Date.now();
      toastRemainingTime = toastDuration;

      // Animate progress bar
      toastProgressInterval = setInterval(() => {
        const elapsed = Date.now() - toastStartTime;
        const remaining = Math.max(0, toastDuration - elapsed);
        const percent = (remaining / toastDuration) * 100;
        toastProgress.style.width = percent + '%';
      }, 50);

      // Auto-dismiss after duration
      toastTimeout = setTimeout(() => {
        dismissToast();
      }, toastDuration);
    }

    function pauseToast() {
      const toast = document.getElementById('toast');
      if (!toast.classList.contains('show')) return;

      toast.classList.add('paused');
      toastRemainingTime = Math.max(0, toastDuration - (Date.now() - toastStartTime));

      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
      if (toastProgressInterval) {
        clearInterval(toastProgressInterval);
        toastProgressInterval = null;
      }
    }

    function resumeToast() {
      const toast = document.getElementById('toast');
      const toastProgress = document.getElementById('toastProgress');
      if (!toast.classList.contains('show')) return;

      toast.classList.remove('paused');
      toastStartTime = Date.now();
      toastDuration = toastRemainingTime;

      // Resume progress bar animation
      toastProgressInterval = setInterval(() => {
        const elapsed = Date.now() - toastStartTime;
        const remaining = Math.max(0, toastDuration - elapsed);
        const percent = (remaining / toastDuration) * 100;
        toastProgress.style.width = percent + '%';
      }, 50);

      // Resume auto-dismiss
      toastTimeout = setTimeout(() => {
        dismissToast();
      }, toastRemainingTime);
    }

    function dismissToast() {
      const toast = document.getElementById('toast');
      const toastProgress = document.getElementById('toastProgress');

      toast.classList.remove('show', 'paused');

      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
      if (toastProgressInterval) {
        clearInterval(toastProgressInterval);
        toastProgressInterval = null;
      }

      toastProgress.style.width = '0%';
    }

    // ==================== AUTH STATE ====================
    let currentUser = null;

    async function checkAuthState() {
      try {
        const response = await fetch('/api/auth/me');
        const data = await response.json();
        currentUser = data.user;
        renderAuthUI();
      } catch (err) {
        console.log('Auth check failed (server may not be running):', err.message);
        currentUser = null;
        renderAuthUI();
      }
    }

    function handleAuthRedirect() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('login') === 'success') {
        showToast('Logged in successfully!', 'success');
        window.history.replaceState({}, '', window.location.pathname);
      } else if (params.get('error') === 'auth_failed') {
        showToast('Login failed. Please try again.', 'error');
        window.history.replaceState({}, '', window.location.pathname);
      }
    }

    function renderAuthUI() {
      const authSection = document.getElementById('authSection');
      if (!authSection) return;

      // Show/hide My Submissions filter button
      const mySubmissionsBtn = document.getElementById('mySubmissionsBtn');
      if (mySubmissionsBtn) {
        mySubmissionsBtn.style.display = currentUser ? '' : 'none';
      }

      // Update save button state based on login
      updateSaveButtonState();

      // Show/hide admin elements
      const adminNavLink = document.getElementById('adminNavLink');
      if (adminNavLink) {
        adminNavLink.classList.toggle('hidden', !currentUser?.is_admin);
      }

      if (currentUser) {
        const initial = currentUser.username.charAt(0).toUpperCase();
        authSection.innerHTML = `
          <div class="user-menu">
            <button class="user-menu-toggle" onclick="toggleUserMenu()" aria-haspopup="true" aria-expanded="false">
              <div class="user-avatar">
                ${currentUser.avatar_url
                  ? `<img src="${currentUser.avatar_url}" alt="${currentUser.username}">`
                  : initial}
              </div>
              <span>${currentUser.username}</span>
            </button>
            <div class="user-dropdown" id="userDropdown">
              <button class="user-dropdown-item" onclick="navigateTo('community'); setCommunityFilter('mine'); toggleUserMenu();">My Submissions</button>
              <button class="user-dropdown-item danger" onclick="logout()">Logout</button>
            </div>
          </div>
        `;
      } else {
        authSection.innerHTML = `
          <button class="btn-login" onclick="openLoginModal()">
            Sign In
          </button>
        `;
      }
    }

    // ==================== PAGE NAVIGATION ====================
    let currentPage = 'converter';

    function navigateTo(page) {
      currentPage = page;

      // Update nav links
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.toggle('active', link.dataset.page === page);
      });

      // Update page views
      document.querySelectorAll('.page-view').forEach(view => {
        view.classList.toggle('active', view.id === page + 'Page');
      });

      // Load community when navigating to it
      if (page === 'community' && !communityLoaded) {
        loadCommunityConversions();
      }

      // Load My Library when navigating to it
      if (page === 'myLibrary') {
        loadMyLibrary();
      }

      // Load admin data when navigating to it
      if (page === 'admin' && currentUser?.is_admin) {
        loadAdminData();
      }

      // Initialize encounter builder when navigating to it
      if (page === 'encounter-builder') {
        initEncounterBuilder();
      }
    }

    // ==================== ENCOUNTER BUILDER ====================

    // Battle Points costs by adversary type
    const ADV_TYPE_BATTLE_POINTS = {
      'Minion': 1, 'Social': 1, 'Support': 1,
      'Horde': 2, 'Ranged': 2, 'Skulk': 2, 'Standard': 2,
      'Leader': 3, 'Bruiser': 4, 'Solo': 5
    };

    // Encounter state
    let encounterState = {
      partySize: 4,
      name: '',
      roster: [] // [{adversaryId, adversary, count}]
    };

    // Debounce for search
    let encounterSearchTimeout = null;
    function debouncedFilterEncounterLibrary() {
      clearTimeout(encounterSearchTimeout);
      encounterSearchTimeout = setTimeout(renderEncounterLibrary, 150);
    }

    // XSS prevention
    function escapeHtmlEncounter(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function getAdvTypeBattlePoints(advType) {
      return ADV_TYPE_BATTLE_POINTS[advType] || 2;
    }

    function calculateBudget(partySize) {
      return (3 * partySize) + 2;
    }

    function calculateUsedPoints() {
      return encounterState.roster.reduce((sum, item) => {
        const bp = getAdvTypeBattlePoints(item.adversary.advType);
        return sum + (bp * item.count);
      }, 0);
    }

    function adjustPartySize(delta) {
      encounterState.partySize = Math.max(1, Math.min(10, encounterState.partySize + delta));
      document.getElementById('party-size-value').textContent = encounterState.partySize;
      updateBudgetDisplay();
    }

    function updateBudgetDisplay() {
      const budget = calculateBudget(encounterState.partySize);
      const used = calculateUsedPoints();
      const percent = Math.min(100, (used / budget) * 100);

      document.getElementById('budget-total').textContent = budget;
      document.getElementById('budget-used').textContent = used;
      document.getElementById('encounter-total-bp').textContent = used;

      const fill = document.getElementById('budget-bar-fill');
      fill.style.width = percent + '%';
      fill.classList.remove('warning', 'danger');
      if (used > budget) fill.classList.add('danger');
      else if (percent > 75) fill.classList.add('warning');
    }

    function addToEncounter(adversaryId) {
      const existing = encounterState.roster.find(r => r.adversaryId === adversaryId);
      if (existing) {
        existing.count++;
      } else {
        const adversary = getAllLibraryAdversaries().find(a => a.id === adversaryId);
        if (adversary) {
          encounterState.roster.push({ adversaryId, adversary, count: 1 });
        }
      }
      renderEncounterRoster();
      updateBudgetDisplay();
    }

    function removeFromEncounter(adversaryId) {
      const idx = encounterState.roster.findIndex(r => r.adversaryId === adversaryId);
      if (idx !== -1) {
        if (encounterState.roster[idx].count > 1) {
          encounterState.roster[idx].count--;
        } else {
          encounterState.roster.splice(idx, 1);
        }
      }
      renderEncounterRoster();
      updateBudgetDisplay();
    }

    function renderEncounterLibrary() {
      const container = document.getElementById('encounter-library-list');
      if (!container) return;

      const search = document.getElementById('encounter-library-search')?.value?.toLowerCase() || '';
      const adversaries = getAllLibraryAdversaries().filter(a =>
        a.name.toLowerCase().includes(search) ||
        (a.advType || '').toLowerCase().includes(search)
      );

      if (adversaries.length === 0) {
        container.innerHTML = '<div class="empty-state">No adversaries in library. Add some from the Converter!</div>';
        return;
      }

      container.innerHTML = adversaries.map(adv => {
        const bp = getAdvTypeBattlePoints(adv.advType);
        return `
          <div class="encounter-item" data-adversary-id="${escapeHtmlEncounter(adv.id)}" onclick="addToEncounter('${escapeHtmlEncounter(adv.id)}')">
            <div class="encounter-item-info">
              <span class="encounter-item-name">${escapeHtmlEncounter(adv.name)}</span>
              <span class="encounter-item-meta">T${escapeHtmlEncounter(String(adv.tier || '?'))} ${escapeHtmlEncounter(adv.advType || 'Standard')}</span>
            </div>
            <span class="encounter-bp-badge">${bp} BP</span>
          </div>
        `;
      }).join('');
    }

    function renderEncounterRoster() {
      const container = document.getElementById('encounter-roster');
      if (!container) return;

      if (encounterState.roster.length === 0) {
        container.innerHTML = '<div class="empty-state">Click adversaries from your library to add them</div>';
        return;
      }

      container.innerHTML = encounterState.roster.map(item => {
        const bp = getAdvTypeBattlePoints(item.adversary.advType);
        const totalBp = bp * item.count;
        return `
          <div class="encounter-item">
            <div class="encounter-item-info">
              <span class="encounter-item-name">${escapeHtmlEncounter(item.adversary.name)}</span>
              <span class="encounter-item-meta">${item.count > 1 ? `×${item.count}` : ''} ${escapeHtmlEncounter(item.adversary.advType || 'Standard')}</span>
            </div>
            <div class="encounter-item-controls">
              <button class="party-btn" onclick="removeFromEncounter('${escapeHtmlEncounter(item.adversaryId)}')">−</button>
              <span class="encounter-count">${item.count}</span>
              <button class="party-btn" onclick="addToEncounter('${escapeHtmlEncounter(item.adversaryId)}')">+</button>
              <span class="encounter-bp-badge">${totalBp} BP</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function clearEncounter() {
      encounterState.roster = [];
      encounterState.name = '';
      const nameInput = document.getElementById('encounter-name');
      if (nameInput) nameInput.value = '';
      renderEncounterRoster();
      updateBudgetDisplay();
    }

    function saveEncounter() {
      if (encounterState.roster.length === 0) {
        showToast('Add adversaries before saving', 'error');
        return;
      }

      const saved = JSON.parse(localStorage.getItem('dh-saved-encounters') || '[]');
      const encounter = {
        id: 'enc-' + Date.now(),
        name: encounterState.name || 'Unnamed Encounter',
        partySize: encounterState.partySize,
        totalBp: calculateUsedPoints(),
        roster: encounterState.roster.map(r => ({
          adversaryId: r.adversaryId,
          name: r.adversary.name,
          advType: r.adversary.advType,
          tier: r.adversary.tier,
          count: r.count
        })),
        createdAt: new Date().toISOString()
      };

      saved.unshift(encounter);
      localStorage.setItem('dh-saved-encounters', JSON.stringify(saved));
      showToast('Encounter saved!', 'success');
      renderSavedEncounters();
    }

    function loadEncounter(encounterId) {
      const saved = JSON.parse(localStorage.getItem('dh-saved-encounters') || '[]');
      const encounter = saved.find(e => e.id === encounterId);
      if (!encounter) return;

      encounterState.partySize = encounter.partySize;
      encounterState.name = encounter.name;
      encounterState.roster = [];

      // Rebuild roster from library
      const library = getAllLibraryAdversaries();
      const missingAdversaries = [];

      for (const item of encounter.roster) {
        const adversary = library.find(a => a.id === item.adversaryId);
        if (adversary) {
          encounterState.roster.push({
            adversaryId: item.adversaryId,
            adversary,
            count: item.count
          });
        } else {
          missingAdversaries.push(item.name);
        }
      }

      // Warn about missing adversaries
      if (missingAdversaries.length > 0) {
        showToast(`Warning: ${missingAdversaries.length} adversary(s) no longer in library: ${missingAdversaries.join(', ')}`, 'error');
      }

      document.getElementById('party-size-value').textContent = encounterState.partySize;
      const nameInput = document.getElementById('encounter-name');
      if (nameInput) nameInput.value = encounterState.name;
      renderEncounterRoster();
      updateBudgetDisplay();
    }

    function deleteEncounter(encounterId) {
      const saved = JSON.parse(localStorage.getItem('dh-saved-encounters') || '[]');
      const filtered = saved.filter(e => e.id !== encounterId);
      localStorage.setItem('dh-saved-encounters', JSON.stringify(filtered));
      showToast('Encounter deleted', 'success');
      renderSavedEncounters();
    }

    function renderSavedEncounters() {
      const container = document.getElementById('saved-encounters-list');
      if (!container) return;

      const saved = JSON.parse(localStorage.getItem('dh-saved-encounters') || '[]');

      if (saved.length === 0) {
        container.innerHTML = '<div class="empty-state">No saved encounters yet</div>';
        return;
      }

      container.innerHTML = saved.map(enc => `
        <div class="saved-encounter-item">
          <div>
            <strong>${escapeHtmlEncounter(enc.name)}</strong>
            <span class="encounter-item-meta">${enc.roster.length} type${enc.roster.length !== 1 ? 's' : ''} • ${enc.totalBp} BP • ${enc.partySize} players</span>
          </div>
          <div class="encounter-item-controls">
            <button class="btn btn-secondary btn-small" onclick="loadEncounter('${escapeHtmlEncounter(enc.id)}')">Load</button>
            <button class="btn btn-secondary btn-small" onclick="deleteEncounter('${escapeHtmlEncounter(enc.id)}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function initEncounterBuilder() {
      renderEncounterLibrary();
      renderEncounterRoster();
      renderSavedEncounters();
      updateBudgetDisplay();
    }

    // ==================== ADMIN PANEL ====================
    let adminConversionsPage = 1;
    let adminUsersPage = 1;
    let adminSearchTimeout = null;

    async function loadAdminData() {
      loadAdminStats();
      loadAdminConversions();
    }

    async function loadAdminStats() {
      try {
        const response = await fetch('/api/admin/stats');
        if (!response.ok) throw new Error('Failed to load stats');
        const stats = await response.json();

        document.getElementById('statUsers').textContent = stats.totalUsers;
        document.getElementById('statConversions').textContent = stats.totalConversions;
        document.getElementById('statVotes').textContent = stats.totalVotes;
        document.getElementById('statRecentConversions').textContent = stats.recentConversions;

        // Update pending reports badge
        const badge = document.getElementById('pendingReportsBadge');
        if (badge) {
          badge.textContent = stats.pendingReports > 0 ? stats.pendingReports : '';
        }
      } catch (err) {
        console.error('Failed to load admin stats:', err);
      }
    }

    let analyticsVisible = false;

    function toggleAnalytics() {
      analyticsVisible = !analyticsVisible;
      const content = document.getElementById('analyticsContent');
      content.style.display = analyticsVisible ? 'block' : 'none';
      if (analyticsVisible) {
        loadAdminAnalytics();
      }
    }

    async function loadAdminAnalytics() {
      try {
        const response = await fetch('/api/admin/analytics?days=30');
        if (!response.ok) throw new Error('Failed to load analytics');
        const data = await response.json();

        // Render charts
        renderLineChart('conversionsChart', data.conversionsOverTime, '#22c55e');
        renderLineChart('usersChart', data.usersOverTime, '#3b82f6');
        renderLineChart('reportsChart', data.reportsOverTime, '#ef4444');
        renderLineChart('votesChart', data.votesOverTime, '#e1b74a');

        // Render suspicious activity
        renderSuspiciousActivity(data.suspiciousActivity);
      } catch (err) {
        console.error('Failed to load analytics:', err);
      }
    }

    function renderLineChart(canvasId, data, color) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      const width = rect.width;
      const height = rect.height;
      const padding = { top: 10, right: 10, bottom: 25, left: 35 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      ctx.clearRect(0, 0, width, height);

      if (!data || data.length === 0) {
        ctx.fillStyle = '#888';
        ctx.font = '12px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('No data', width / 2, height / 2);
        return;
      }

      // Fill dates for last 30 days
      const today = new Date();
      const filledData = [];
      for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const existing = data.find(d => d.date === dateStr);
        filledData.push({ date: dateStr, count: existing ? existing.count : 0 });
      }

      const maxValue = Math.max(...filledData.map(d => d.count), 1);
      const xStep = chartWidth / (filledData.length - 1 || 1);

      // Draw grid lines
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 0.5;
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
      }

      // Draw line
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      filledData.forEach((d, i) => {
        const x = padding.left + i * xStep;
        const y = padding.top + chartHeight - (d.count / maxValue) * chartHeight;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Fill area under line
      ctx.globalAlpha = 0.1;
      ctx.fillStyle = color;
      ctx.lineTo(padding.left + (filledData.length - 1) * xStep, padding.top + chartHeight);
      ctx.lineTo(padding.left, padding.top + chartHeight);
      ctx.closePath();
      ctx.fill();
      ctx.globalAlpha = 1;

      // Draw dots on data points
      ctx.fillStyle = color;
      filledData.forEach((d, i) => {
        if (d.count > 0) {
          const x = padding.left + i * xStep;
          const y = padding.top + chartHeight - (d.count / maxValue) * chartHeight;
          ctx.beginPath();
          ctx.arc(x, y, 3, 0, Math.PI * 2);
          ctx.fill();
        }
      });

      // Draw Y-axis labels
      ctx.fillStyle = '#888';
      ctx.font = '10px system-ui';
      ctx.textAlign = 'right';
      for (let i = 0; i <= 4; i++) {
        const value = Math.round((maxValue / 4) * (4 - i));
        const y = padding.top + (chartHeight / 4) * i + 3;
        ctx.fillText(value.toString(), padding.left - 5, y);
      }

      // Draw X-axis labels (first and last date)
      ctx.textAlign = 'center';
      ctx.fillText(filledData[0].date.slice(5), padding.left, height - 5);
      ctx.fillText(filledData[filledData.length - 1].date.slice(5), width - padding.right, height - 5);
    }

    function renderSuspiciousActivity(data) {
      // High activity users
      const highActivityEl = document.getElementById('suspiciousHighActivity');
      if (highActivityEl) {
        if (data.highActivityUsers && data.highActivityUsers.length > 0) {
          highActivityEl.innerHTML = data.highActivityUsers.map(u =>
            `<li>@${escapeHtml(u.username)} - ${u.conversions_24h} conversions, ${u.votes_24h} votes</li>`
          ).join('');
        } else {
          highActivityEl.innerHTML = '<li class="empty">None detected</li>';
        }
      }

      // Heavily reported
      const heavilyReportedEl = document.getElementById('suspiciousHeavilyReported');
      if (heavilyReportedEl) {
        if (data.heavilyReported && data.heavilyReported.length > 0) {
          heavilyReportedEl.innerHTML = data.heavilyReported.map(c =>
            `<li>"${escapeHtml(c.name)}" - ${c.report_count} reports</li>`
          ).join('');
        } else {
          heavilyReportedEl.innerHTML = '<li class="empty">None detected</li>';
        }
      }

      // Recent bans
      const recentBansEl = document.getElementById('suspiciousRecentBans');
      if (recentBansEl) {
        if (data.recentBans && data.recentBans.length > 0) {
          recentBansEl.innerHTML = data.recentBans.map(u =>
            `<li>@${escapeHtml(u.username)}</li>`
          ).join('');
        } else {
          recentBansEl.innerHTML = '<li class="empty">None</li>';
        }
      }
    }

    async function loadAdminConversions(page = 1) {
      adminConversionsPage = page;
      const search = document.getElementById('adminConversionSearch')?.value || '';
      const tbody = document.getElementById('adminConversionsBody');
      tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`/api/admin/conversions?page=${page}&search=${encodeURIComponent(search)}`);
        if (!response.ok) throw new Error('Failed to load conversions');
        const data = await response.json();

        if (data.conversions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="loading">No conversions found</td></tr>';
          renderAdminPagination('adminConversionsPagination', data.pagination, loadAdminConversions);
          return;
        }

        tbody.innerHTML = data.conversions.map(c => `
          <tr>
            <td>${escapeHtml(c.name)}</td>
            <td>
              <div class="admin-author">
                ${c.author.avatarUrl ? `<img src="${c.author.avatarUrl}" alt="">` : ''}
                <span>${escapeHtml(c.author.username || 'Unknown')}${c.author.isBanned ? ' <span class="admin-badge banned">Banned</span>' : ''}</span>
              </div>
            </td>
            <td>T${c.tier}</td>
            <td>${c.advType}</td>
            <td>${c.score}</td>
            <td><span class="admin-badge ${c.isPublished ? 'published' : 'unpublished'}">${c.isPublished ? 'Published' : 'Hidden'}</span></td>
            <td>${new Date(c.createdAt).toLocaleDateString()}</td>
            <td>
              <div class="admin-actions">
                <button class="admin-btn" onclick="adminTogglePublish('${c.id}', ${!c.isPublished})">${c.isPublished ? 'Hide' : 'Show'}</button>
                <button class="admin-btn danger" onclick="adminDeleteConversion('${c.id}', '${escapeJsString(c.name)}')">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');

        renderAdminPagination('adminConversionsPagination', data.pagination, loadAdminConversions);
      } catch (err) {
        console.error('Failed to load admin conversions:', err);
        tbody.innerHTML = '<tr><td colspan="8" class="loading">Failed to load conversions</td></tr>';
      }
    }

    async function loadAdminUsers(page = 1) {
      adminUsersPage = page;
      const search = document.getElementById('adminUserSearch')?.value || '';
      const tbody = document.getElementById('adminUsersBody');
      tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`/api/admin/users?page=${page}&search=${encodeURIComponent(search)}`);
        if (!response.ok) throw new Error('Failed to load users');
        const data = await response.json();

        if (data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="loading">No users found</td></tr>';
          renderAdminPagination('adminUsersPagination', data.pagination, loadAdminUsers);
          return;
        }

        tbody.innerHTML = data.users.map(u => `
          <tr>
            <td>
              <div class="admin-author">
                ${u.avatarUrl ? `<img src="${u.avatarUrl}" alt="">` : ''}
                <span>${escapeHtml(u.username)}</span>
              </div>
            </td>
            <td>${u.provider}</td>
            <td>${u.conversionCount}</td>
            <td>${u.voteCount}</td>
            <td>
              ${u.isAdmin ? '<span class="admin-badge admin">Admin</span>' : ''}
              ${u.isBanned ? '<span class="admin-badge banned">Banned</span>' : '<span class="admin-badge active">Active</span>'}
            </td>
            <td>${new Date(u.createdAt).toLocaleDateString()}</td>
            <td>
              <div class="admin-actions">
                ${!u.isAdmin ? `<button class="admin-btn ${u.isBanned ? '' : 'danger'}" onclick="adminToggleBan('${u.id}', ${!u.isBanned}, '${escapeHtml(u.username)}')">${u.isBanned ? 'Unban' : 'Ban'}</button>` : ''}
              </div>
            </td>
          </tr>
        `).join('');

        renderAdminPagination('adminUsersPagination', data.pagination, loadAdminUsers);
      } catch (err) {
        console.error('Failed to load admin users:', err);
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Failed to load users</td></tr>';
      }
    }

    function renderAdminPagination(containerId, pagination, loadFn) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = `
        <button class="btn btn-secondary btn-small" onclick="${loadFn.name}(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>Prev</button>
        <span>Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} total)</span>
        <button class="btn btn-secondary btn-small" onclick="${loadFn.name}(${pagination.page + 1})" ${pagination.page >= pagination.totalPages ? 'disabled' : ''}>Next</button>
      `;
    }

    function switchAdminTab(tab) {
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));

      document.querySelector(`.admin-tab[onclick*="${tab}"]`)?.classList.add('active');
      document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`)?.classList.remove('hidden');

      if (tab === 'users') {
        loadAdminUsers();
      } else if (tab === 'reports') {
        loadAdminReports();
      } else {
        loadAdminConversions();
      }
    }

    function debounceAdminSearch(type) {
      clearTimeout(adminSearchTimeout);
      adminSearchTimeout = setTimeout(() => {
        if (type === 'conversions') {
          loadAdminConversions(1);
        } else {
          loadAdminUsers(1);
        }
      }, 300);
    }

    async function adminTogglePublish(id, publish) {
      try {
        const response = await fetch(`/api/admin/conversions/${id}/publish`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isPublished: publish })
        });
        if (!response.ok) throw new Error('Failed to update');
        showToast(publish ? 'Conversion published' : 'Conversion hidden', 'success');
        loadAdminConversions(adminConversionsPage);
      } catch (err) {
        showToast('Failed to update conversion', 'error');
      }
    }

    async function adminDeleteConversion(id, name) {
      if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/admin/conversions/${id}`, { method: 'DELETE' });
        if (!response.ok) {
          const data = await response.json().catch(() => ({}));
          throw new Error(data.error || 'Failed to delete');
        }
        showToast('Conversion deleted', 'success');
        loadAdminConversions(adminConversionsPage);
        loadAdminStats();
      } catch (err) {
        showToast(err.message || 'Failed to delete conversion', 'error');
      }
    }

    async function adminToggleBan(id, ban, username) {
      if (ban && !confirm(`Ban user "${username}"? They will no longer be able to log in.`)) return;

      try {
        const response = await fetch(`/api/admin/users/${id}/ban`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isBanned: ban })
        });
        if (!response.ok) throw new Error('Failed to update');
        showToast(ban ? 'User banned' : 'User unbanned', 'success');
        loadAdminUsers(adminUsersPage);
        loadAdminStats();
      } catch (err) {
        showToast('Failed to update user', 'error');
      }
    }

    // ==================== ADMIN REPORTS ====================
    let adminReportsPage = 1;

    async function loadAdminReports(page = 1) {
      adminReportsPage = page;
      const status = document.getElementById('adminReportStatusFilter')?.value || 'pending';
      const tbody = document.getElementById('adminReportsBody');
      tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';

      try {
        const response = await fetch(`/api/admin/reports?page=${page}&status=${status}`);
        const data = await response.json();

        if (data.reports.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="loading">No reports found</td></tr>';
          renderAdminPagination('adminReportsPagination', data.pagination, loadAdminReports);
          return;
        }

        tbody.innerHTML = data.reports.map(r => `
          <tr>
            <td>
              <div><strong>${escapeHtml(r.conversion.name)}</strong></div>
              <div style="font-size: 0.75rem; color: var(--text-secondary);">
                T${r.conversion.tier} ${r.conversion.type} · by @${escapeHtml(r.author.username)}
              </div>
            </td>
            <td>
              <div class="admin-author">
                ${r.reporter.avatarUrl ? `<img src="${r.reporter.avatarUrl}" alt="">` : ''}
                <span>@${escapeHtml(r.reporter.username)}</span>
              </div>
            </td>
            <td><div class="admin-report-reason" title="${escapeHtml(r.reason)}">${escapeHtml(r.reason)}</div></td>
            <td><span class="admin-badge ${r.status}">${r.status}</span></td>
            <td>${new Date(r.createdAt).toLocaleDateString()}</td>
            <td>
              <div class="admin-actions">
                <button class="admin-btn" onclick="viewReportedConversion('${r.conversion.id}')" title="View">View</button>
                ${r.status === 'pending' ? `
                  <button class="admin-btn" onclick="dismissReport('${r.id}')" title="Dismiss">Dismiss</button>
                  <button class="admin-btn danger" onclick="actionReport('${r.id}', 'hide')" title="Hide conversion">Hide</button>
                  <button class="admin-btn danger" onclick="actionReport('${r.id}', 'delete')" title="Delete conversion">Delete</button>
                ` : ''}
              </div>
            </td>
          </tr>
        `).join('');

        renderAdminPagination('adminReportsPagination', data.pagination, loadAdminReports);
      } catch (err) {
        console.error('Failed to load reports:', err);
        tbody.innerHTML = '<tr><td colspan="6" class="loading">Failed to load reports</td></tr>';
      }
    }

    async function viewReportedConversion(conversionId) {
      // Switch to community and open the modal
      navigateTo('community');
      setTimeout(() => openCommunityModal(conversionId), 300);
    }

    async function dismissReport(reportId) {
      if (!confirm('Dismiss this report? The conversion will remain visible.')) return;

      try {
        const response = await fetch(`/api/admin/reports/${reportId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'dismissed', adminNotes: 'Dismissed by admin' })
        });
        if (!response.ok) throw new Error('Failed to dismiss');
        showToast('Report dismissed', 'success');
        loadAdminReports(adminReportsPage);
        loadAdminStats();
      } catch (err) {
        showToast('Failed to dismiss report', 'error');
      }
    }

    async function actionReport(reportId, action) {
      const actionLabel = action === 'hide' ? 'hide' : 'delete';
      if (!confirm(`${action === 'hide' ? 'Hide' : 'Delete'} this conversion? ${action === 'delete' ? 'This cannot be undone.' : ''}`)) return;

      try {
        const response = await fetch(`/api/admin/reports/${reportId}/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        });
        if (!response.ok) throw new Error('Failed to action');
        showToast(`Conversion ${actionLabel}d and report resolved`, 'success');
        loadAdminReports(adminReportsPage);
        loadAdminStats();
      } catch (err) {
        showToast('Failed to action report', 'error');
      }
    }

    // ==================== MY LIBRARY (Drag & Drop Folder System) ====================
    let myLibraryGroups = [];
    let selectedFolderId = 'all';
    let selectedMyLibraryAdversary = null;
    let adversaryToAdd = null;
    let draggedAdversary = null;
    let librarySearchFilter = '';

    function loadMyLibrary() {
      loadGroupsFromStorage();
      renderFoldersList();
      updateFolderCounts();
      selectFolder(selectedFolderId || 'all');
    }

    function loadGroupsFromStorage() {
      try {
        const stored = localStorage.getItem('dh-groups');
        myLibraryGroups = stored ? JSON.parse(stored) : [];
      } catch (e) {
        console.error('Failed to load groups:', e);
        myLibraryGroups = [];
      }
    }

    function saveGroupsToStorage() {
      try {
        localStorage.setItem('dh-groups', JSON.stringify(myLibraryGroups));
      } catch (e) {
        console.error('Failed to save groups:', e);
        showToast('Failed to save', 'error');
      }
    }

    function getAllLibraryAdversaries() {
      try {
        return JSON.parse(localStorage.getItem('dh-user-library') || '[]');
      } catch (e) {
        return [];
      }
    }

    function getUngroupedAdversaries() {
      const library = getAllLibraryAdversaries();
      const groupedIds = new Set();
      myLibraryGroups.forEach(g => {
        (g.adversaries || []).forEach(a => groupedIds.add(a.id));
      });
      return library.filter(a => !groupedIds.has(a.id));
    }

    function renderFoldersList() {
      const container = document.getElementById('foldersList');
      if (!container) return;

      if (myLibraryGroups.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = myLibraryGroups.map(folder => `
        <div class="folder-item ${selectedFolderId === folder.id ? 'active' : ''}"
             data-folder="${folder.id}"
             onclick="selectFolder('${folder.id}')"
             ondragover="handleFolderDragOver(event)"
             ondragleave="handleFolderDragLeave(event)"
             ondrop="handleFolderDrop(event, '${folder.id}')">
          <span class="folder-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/>
            </svg>
          </span>
          <span class="folder-name">${escapeHtml(folder.name)}</span>
          <span class="folder-count">${(folder.adversaries || []).length}</span>
        </div>
      `).join('');
    }

    function updateFolderCounts() {
      const allCount = document.getElementById('allCount');
      const ungroupedCount = document.getElementById('ungroupedCount');
      if (allCount) allCount.textContent = getAllLibraryAdversaries().length;
      if (ungroupedCount) ungroupedCount.textContent = getUngroupedAdversaries().length;
    }

    function selectFolder(folderId) {
      selectedFolderId = folderId;

      // Update folder selection in sidebar
      document.querySelectorAll('.folder-item').forEach(el => {
        el.classList.toggle('active', el.dataset.folder === folderId);
      });

      // Update content header
      const nameEl = document.getElementById('currentFolderName');
      const countEl = document.getElementById('folderItemCount');
      const editActionsEl = document.getElementById('folderEditActions');

      let adversaries = [];
      let folderName = 'All Adversaries';

      if (folderId === 'all') {
        adversaries = getAllLibraryAdversaries();
        folderName = 'All Adversaries';
        if (editActionsEl) editActionsEl.style.display = 'none';
      } else if (folderId === 'ungrouped') {
        adversaries = getUngroupedAdversaries();
        folderName = 'Ungrouped';
        if (editActionsEl) editActionsEl.style.display = 'none';
      } else {
        const folder = myLibraryGroups.find(g => g.id === folderId);
        if (folder) {
          adversaries = folder.adversaries || [];
          folderName = folder.name;
          if (editActionsEl) editActionsEl.style.display = 'flex';
        }
      }

      if (nameEl) nameEl.textContent = folderName;
      if (countEl) countEl.textContent = `(${adversaries.length} items)`;

      renderLibraryItems(adversaries);
    }

    function renderLibraryItems(adversaries) {
      const container = document.getElementById('libraryItems');
      const emptyState = document.getElementById('libraryEmptyState');
      if (!container) return;

      // Apply search filter
      let filtered = adversaries;
      if (librarySearchFilter) {
        const search = librarySearchFilter.toLowerCase();
        filtered = adversaries.filter(a =>
          (a.name || '').toLowerCase().includes(search) ||
          (a.advType || '').toLowerCase().includes(search)
        );
      }

      if (filtered.length === 0) {
        container.innerHTML = '';
        if (emptyState) emptyState.classList.remove('hidden');
        return;
      }

      if (emptyState) emptyState.classList.add('hidden');

      container.innerHTML = filtered.map(adv => {
        const hp = adv.hp || '?';
        const stress = adv.stress || '?';
        const difficulty = adv.difficulty || '?';
        const majorThresh = adv.majorThresh || '?';
        const severeThresh = adv.severeThresh || '?';
        const description = adv.description || '';
        const motives = adv.motives || '';
        const cardTypeClass = (adv.advType || 'standard').toLowerCase().trim();

        // Build attack line
        let attackLine = '';
        if (adv.atkMod && adv.atkMod !== '?') {
          attackLine = `<span class="dh-stat-item"><span class="dh-stat-label">ATK:</span> ${adv.atkMod}</span>`;
          if (adv.weapon) attackLine += `<span class="dh-stat-separator">|</span><span class="dh-stat-item">${adv.weapon}: ${adv.range || ''}</span>`;
          if (adv.damage) attackLine += `<span class="dh-stat-separator">|</span><span class="dh-stat-item">${adv.damage}${adv.dmgType ? ' ' + adv.dmgType : ''}</span>`;
        }

        return `
          <div class="community-item library-draggable"
               draggable="true"
               data-adversary-id="${adv.id}"
               ondragstart="handleAdversaryDragStart(event, '${adv.id}')"
               ondragend="handleAdversaryDragEnd(event)"
               onclick="openMyLibraryAdversary('${adv.id}')">
            <div class="dh-card-header" data-type="${cardTypeClass}">
              <div class="dh-card-name">${escapeHtml(adv.name || 'Unknown')}</div>
              <div class="dh-card-tier-type">Tier ${adv.tier || '?'} ${adv.advType || 'Standard'}</div>
            </div>
            <div class="dh-card-body">
              ${description ? `<div class="dh-card-description">${escapeHtml(description)}</div>` : ''}
              ${motives ? `<div class="dh-card-motives"><strong>Motives & Tactics:</strong> ${escapeHtml(motives)}</div>` : ''}
              <div class="mini-stats-container">
                <div class="mini-vitals-row">
                  <div class="mini-vital-box difficulty">
                    <span class="mini-vital-value">${difficulty}</span>
                    <span class="mini-vital-label">Diff</span>
                  </div>
                  <div class="mini-vital-box hp">
                    <span class="mini-vital-value">${hp}</span>
                    <span class="mini-vital-label">HP</span>
                  </div>
                  <div class="mini-vital-box stress">
                    <span class="mini-vital-value">${stress}</span>
                    <span class="mini-vital-label">Stress</span>
                  </div>
                </div>
                <div class="mini-damage-tracker">
                  <div class="mini-damage-card">
                    <svg viewBox="0 0 250 120" preserveAspectRatio="xMidYMid meet">
                      <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975">
                        <path d="M -974.223 2292.978 L -974.223 2042.978 L -874.223 1942.978 L -874.223 1442.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                      </g>
                    </svg>
                    <span class="mini-card-label">Minor</span>
                  </div>
                  <div class="mini-connector"><span class="mini-connector-number">${majorThresh}</span></div>
                  <div class="mini-damage-card">
                    <svg viewBox="0 0 250 120" preserveAspectRatio="xMidYMid meet">
                      <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975">
                        <path d="M -974.223 2292.978 L -974.223 2042.978 L -624.223 1692.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                        <path d="M -974.223 1842.978 L -974.223 1542.978 L -824.223 1692.978 L -974.223 1842.978 Z"/>
                      </g>
                    </svg>
                    <span class="mini-card-label">Major</span>
                  </div>
                  <div class="mini-connector"><span class="mini-connector-number">${severeThresh}</span></div>
                  <div class="mini-damage-card">
                    <svg viewBox="0 0 250 120" preserveAspectRatio="xMidYMid meet">
                      <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975">
                        <path d="M -974.223 2292.978 L -974.223 2042.978 L -624.223 1692.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                        <path d="M -974.223 1842.978 L -974.223 1542.978 L -824.223 1692.978 L -974.223 1842.978 Z"/>
                      </g>
                    </svg>
                    <span class="mini-card-label">Severe</span>
                  </div>
                </div>
                ${attackLine ? `<div class="dh-card-stats-row">${attackLine}</div>` : ''}
              </div>
            </div>
            <div class="library-drag-hint">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="9" cy="5" r="2"/><circle cx="15" cy="5" r="2"/>
                <circle cx="9" cy="12" r="2"/><circle cx="15" cy="12" r="2"/>
                <circle cx="9" cy="19" r="2"/><circle cx="15" cy="19" r="2"/>
              </svg>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterLibraryItems() {
      const input = document.getElementById('librarySearch');
      librarySearchFilter = input ? input.value : '';
      selectFolder(selectedFolderId);
    }

    // ==================== DRAG & DROP HANDLERS ====================
    function handleAdversaryDragStart(event, adversaryId) {
      // Find the adversary data
      let adv = getAllLibraryAdversaries().find(a => a.id === adversaryId);
      if (!adv) return;

      draggedAdversary = adv;
      event.target.classList.add('dragging');

      // Set drag data
      event.dataTransfer.setData('text/plain', adversaryId);
      event.dataTransfer.effectAllowed = 'move';
    }

    function handleAdversaryDragEnd(event) {
      event.target.classList.remove('dragging');
      draggedAdversary = null;

      // Remove drag-over from all folders
      document.querySelectorAll('.folder-item').forEach(el => {
        el.classList.remove('drag-over');
      });
    }

    function handleFolderDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
      event.currentTarget.classList.add('drag-over');
    }

    function handleFolderDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    function handleFolderDrop(event, targetFolderId) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');

      if (!draggedAdversary) return;

      const advId = draggedAdversary.id;

      // Special handling for 'all' folder - do nothing (can't move to "all")
      if (targetFolderId === 'all') {
        showToast('Items are always visible in All Adversaries', 'info');
        return;
      }

      // Remove from all groups first
      myLibraryGroups.forEach(g => {
        g.adversaries = (g.adversaries || []).filter(a => a.id !== advId);
      });

      // If target is a specific folder (not ungrouped), add to it
      if (targetFolderId !== 'ungrouped') {
        const targetFolder = myLibraryGroups.find(g => g.id === targetFolderId);
        if (targetFolder) {
          if (!targetFolder.adversaries) targetFolder.adversaries = [];
          targetFolder.adversaries.push(draggedAdversary);
          showToast(`Moved to "${targetFolder.name}"`, 'success');
        }
      } else {
        showToast('Moved to Ungrouped', 'success');
      }

      saveGroupsToStorage();
      renderFoldersList();
      updateFolderCounts();
      selectFolder(selectedFolderId);
    }

    function handleContainerDragOver(event) {
      event.preventDefault();
    }

    function handleContainerDrop(event) {
      event.preventDefault();
      // Container drops do nothing extra - folder drops handle everything
    }

    // ==================== FOLDER MANAGEMENT ====================
    function createNewGroup() {
      const name = prompt('Enter folder name:');
      if (!name || !name.trim()) return;

      const newFolder = {
        id: 'folder-' + Date.now(),
        name: name.trim(),
        adversaries: [],
        createdAt: new Date().toISOString()
      };

      myLibraryGroups.push(newFolder);
      saveGroupsToStorage();
      renderFoldersList();
      updateFolderCounts();
      selectFolder(newFolder.id);
      showToast(`Folder "${name}" created`, 'success');
    }

    function startRenameFolder() {
      if (!selectedFolderId || selectedFolderId === 'all' || selectedFolderId === 'ungrouped') return;

      const folder = myLibraryGroups.find(g => g.id === selectedFolderId);
      if (!folder) return;

      const newName = prompt('Enter new name:', folder.name);
      if (!newName || !newName.trim()) return;

      folder.name = newName.trim();
      saveGroupsToStorage();
      renderFoldersList();
      document.getElementById('currentFolderName').textContent = folder.name;
      showToast('Folder renamed', 'success');
    }

    function deleteCurrentGroup() {
      if (!selectedFolderId || selectedFolderId === 'all' || selectedFolderId === 'ungrouped') return;

      const folder = myLibraryGroups.find(g => g.id === selectedFolderId);
      if (!folder) return;

      if (!confirm(`Delete folder "${folder.name}"? Adversaries will be moved to Ungrouped.`)) {
        return;
      }

      myLibraryGroups = myLibraryGroups.filter(g => g.id !== selectedFolderId);
      saveGroupsToStorage();
      selectedFolderId = 'all';
      renderFoldersList();
      updateFolderCounts();
      selectFolder('all');
      showToast(`Folder deleted`, 'info');
    }

    // ==================== ADVERSARY DETAIL MODAL ====================
    function openMyLibraryAdversary(adversaryId) {
      const adversary = getAllLibraryAdversaries().find(a => a.id === adversaryId);
      if (!adversary) {
        showToast('Adversary not found', 'error');
        return;
      }

      selectedMyLibraryAdversary = adversary;
      document.getElementById('myLibraryModalStatBlock').innerHTML = renderStatBlockReadOnly(adversary);

      // Show delete from server button only if user is creator and logged in
      const deleteServerBtn = document.getElementById('deleteFromServerBtn');
      if (deleteServerBtn) {
        const canDeleteFromServer = currentUser && adversary._isCreator && adversary._communityId;
        deleteServerBtn.classList.toggle('hidden', !canDeleteFromServer);
      }

      document.getElementById('myLibraryModal').classList.remove('hidden');

      // Position dice tooltips after modal is visible
      setTimeout(() => positionDiceTooltips(document.getElementById('myLibraryModal')), 50);
    }

    function closeMyLibraryModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('myLibraryModal').classList.add('hidden');
      selectedMyLibraryAdversary = null;
    }

    function copyMyLibraryJSON() {
      if (!selectedMyLibraryAdversary) return;
      navigator.clipboard.writeText(JSON.stringify(selectedMyLibraryAdversary, null, 2));
      showToast('JSON copied', 'success');
    }

    function moveToGroup() {
      if (!selectedMyLibraryAdversary) return;
      adversaryToAdd = selectedMyLibraryAdversary;
      openAddToGroupModal(selectedMyLibraryAdversary.name, true);
    }

    function removeFromLibrary() {
      if (!selectedMyLibraryAdversary) return;
      if (!confirm(`Remove "${selectedMyLibraryAdversary.name}" from your library?`)) return;

      const advId = selectedMyLibraryAdversary.id;

      // Remove from groups
      myLibraryGroups.forEach(g => {
        g.adversaries = (g.adversaries || []).filter(a => a.id !== advId);
      });
      saveGroupsToStorage();

      // Remove from main library
      try {
        let library = getAllLibraryAdversaries().filter(a => a.id !== advId);
        localStorage.setItem('dh-user-library', JSON.stringify(library));
      } catch (e) {
        console.error('Failed to remove:', e);
      }

      closeMyLibraryModal();
      loadMyLibrary();
      showToast('Removed from library', 'info');
    }

    async function deleteFromServer() {
      if (!selectedMyLibraryAdversary) return;
      if (!currentUser) {
        showToast('Please sign in to delete', 'error');
        return;
      }

      const communityId = selectedMyLibraryAdversary._communityId;
      if (!communityId) {
        showToast('This monster is not on the server', 'error');
        return;
      }

      if (!confirm(`Delete "${selectedMyLibraryAdversary.name}" from the community server? This will remove it for everyone and cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/community/conversions/${communityId}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to delete');
        }

        // Also remove from local library
        const advId = selectedMyLibraryAdversary.id;
        myLibraryGroups.forEach(g => {
          g.adversaries = (g.adversaries || []).filter(a => a.id !== advId);
        });
        saveGroupsToStorage();

        try {
          let library = getAllLibraryAdversaries().filter(a => a.id !== advId);
          localStorage.setItem('dh-user-library', JSON.stringify(library));
        } catch (e) {
          console.error('Failed to remove from local library:', e);
        }

        closeMyLibraryModal();
        loadMyLibrary();

        // Reload community if loaded
        if (communityLoaded) {
          communityPage = 1;
          loadCommunityConversions();
        }

        showToast('Deleted from server', 'success');
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // ==================== ADD TO GROUP MODAL ====================
    function openAddToGroupModal(adversaryName, isMove = false) {
      document.getElementById('addToGroupAdversaryName').textContent =
        isMove ? `Move "${adversaryName}" to:` : `Add "${adversaryName}" to:`;

      const listEl = document.getElementById('groupSelectList');

      if (myLibraryGroups.length === 0) {
        listEl.innerHTML = `<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">No folders yet. Create one below.</p>`;
      } else {
        listEl.innerHTML = myLibraryGroups.map(folder => `
          <div class="group-select-item" onclick="addToGroup('${folder.id}')">
            <span class="folder-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></span>
            <span class="folder-name">${escapeHtml(folder.name)}</span>
            <span class="folder-count">${(folder.adversaries || []).length}</span>
          </div>
        `).join('');
      }

      document.getElementById('newGroupNameInline').value = '';
      document.getElementById('addToGroupModal').classList.remove('hidden');
    }

    function closeAddToGroupModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('addToGroupModal').classList.add('hidden');
      adversaryToAdd = null;
    }

    function addToGroup(folderId) {
      if (!adversaryToAdd) return;

      const folder = myLibraryGroups.find(g => g.id === folderId);
      if (!folder) {
        showToast('Folder not found', 'error');
        return;
      }

      // Remove from other groups
      myLibraryGroups.forEach(g => {
        g.adversaries = (g.adversaries || []).filter(a => a.id !== adversaryToAdd.id);
      });

      // Add to target folder
      if (!folder.adversaries) folder.adversaries = [];
      folder.adversaries.push(adversaryToAdd);

      saveGroupsToStorage();
      closeAddToGroupModal();
      closeMyLibraryModal();

      if (currentPage === 'myLibrary') {
        loadMyLibrary();
        selectFolder(folderId);
      }

      showToast(`Added to "${folder.name}"`, 'success');
    }

    function createGroupAndAdd() {
      const nameInput = document.getElementById('newGroupNameInline');
      const name = nameInput.value.trim();
      if (!name) {
        showToast('Enter a folder name', 'error');
        return;
      }

      const newFolder = {
        id: 'folder-' + Date.now(),
        name: name,
        adversaries: adversaryToAdd ? [adversaryToAdd] : [],
        createdAt: new Date().toISOString()
      };

      // Remove from other groups if adding
      if (adversaryToAdd) {
        myLibraryGroups.forEach(g => {
          g.adversaries = (g.adversaries || []).filter(a => a.id !== adversaryToAdd.id);
        });
      }

      myLibraryGroups.push(newFolder);
      saveGroupsToStorage();

      closeAddToGroupModal();
      closeMyLibraryModal();

      if (currentPage === 'myLibrary') {
        loadMyLibrary();
        selectFolder(newFolder.id);
      }

      showToast(`Folder "${name}" created`, 'success');
    }

    function addAdversaryToGroup(adversary) {
      adversaryToAdd = adversary;
      loadGroupsFromStorage();
      openAddToGroupModal(adversary.name);
    }

    // Backward compatibility aliases
    function selectGroup(id) { selectFolder(id); }
    function renderGroupsList() { renderFoldersList(); }
    function renderUngroupedCount() { updateFolderCounts(); }

    // ==================== LOGIN MODAL ====================
    function openLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
    }

    function closeLoginModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('loginModal').classList.add('hidden');
    }

    // ==================== KEYBOARD SHORTCUTS MODAL ====================
    function openKeyboardModal() {
      document.getElementById('keyboardModal').classList.remove('hidden');
    }

    function closeKeyboardModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('keyboardModal').classList.add('hidden');
    }

    // ==================== PRIVACY MODAL ====================
    function openPrivacyModal() {
      document.getElementById('privacyModal').classList.add('active');
    }

    function closePrivacyModal() {
      document.getElementById('privacyModal').classList.remove('active');
    }

    function openFAQModal() {
      document.getElementById('faqModal').classList.remove('hidden');
      document.getElementById('faqModal').classList.add('active');
    }

    function closeFAQModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('faqModal').classList.remove('active');
      document.getElementById('faqModal').classList.add('hidden');
    }

    function toggleUserMenu() {
      const dropdown = document.getElementById('userDropdown');
      if (dropdown) {
        dropdown.classList.toggle('show');
      }
    }

    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        currentUser = null;
        renderAuthUI();
        showToast('Logged out successfully', 'info');
      } catch (err) {
        showToast('Logout failed', 'error');
      }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-menu')) {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown) dropdown.classList.remove('show');
      }
    });

    // ==================== COMMUNITY LIBRARY ====================
    let communityLoaded = false;
    let communityConversions = [];
    let communityPage = 1;
    let communityTotalPages = 1;
    let communitySearchDebounce = null;
    let selectedConversion = null;

    // Multi-select filter state
    let selectedTiers = [];
    let selectedTypes = [];
    let currentFilterType = null; // 'tier' or 'type'

    const TIER_OPTIONS = [
      { value: '1', label: 'Tier 1' },
      { value: '2', label: 'Tier 2' },
      { value: '3', label: 'Tier 3' },
      { value: '4', label: 'Tier 4' }
    ];

    const TYPE_OPTIONS = [
      { value: 'Bruiser', label: 'Bruiser' },
      { value: 'Horde', label: 'Horde' },
      { value: 'Leader', label: 'Leader' },
      { value: 'Minion', label: 'Minion' },
      { value: 'Ranged', label: 'Ranged' },
      { value: 'Skulk', label: 'Skulk' },
      { value: 'Social', label: 'Social' },
      { value: 'Solo', label: 'Solo' },
      { value: 'Standard', label: 'Standard' },
      { value: 'Support', label: 'Support' }
    ];

    function openFilterModal(filterType) {
      currentFilterType = filterType;
      const modal = document.getElementById('filterModal');
      const title = document.getElementById('filterModalTitle');
      const optionsContainer = document.getElementById('filterOptions');

      const options = filterType === 'tier' ? TIER_OPTIONS : TYPE_OPTIONS;
      const selected = filterType === 'tier' ? selectedTiers : selectedTypes;

      title.textContent = filterType === 'tier' ? 'Select Tiers' : 'Select Types';

      optionsContainer.innerHTML = options.map(opt => `
        <div class="filter-option ${selected.includes(opt.value) ? 'selected' : ''}" onclick="toggleFilterOption('${opt.value}')">
          <input type="checkbox" id="filter-${opt.value}" ${selected.includes(opt.value) ? 'checked' : ''}>
          <label for="filter-${opt.value}">${opt.label}</label>
        </div>
      `).join('');

      modal.classList.remove('hidden');
    }

    function closeFilterModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('filterModal').classList.add('hidden');
      currentFilterType = null;
    }

    function toggleFilterOption(value) {
      const selected = currentFilterType === 'tier' ? selectedTiers : selectedTypes;
      const index = selected.indexOf(value);

      if (index === -1) {
        selected.push(value);
      } else {
        selected.splice(index, 1);
      }

      // Update UI
      const optionEl = document.querySelector(`.filter-option input[id="filter-${value}"]`);
      if (optionEl) {
        optionEl.checked = selected.includes(value);
        optionEl.closest('.filter-option').classList.toggle('selected', selected.includes(value));
      }
    }

    function clearFilterSelection() {
      if (currentFilterType === 'tier') {
        selectedTiers = [];
      } else {
        selectedTypes = [];
      }

      // Uncheck all
      document.querySelectorAll('.filter-option').forEach(opt => {
        opt.classList.remove('selected');
        opt.querySelector('input').checked = false;
      });
    }

    function applyFilter() {
      updateFilterButtonLabels();
      closeFilterModal();
      communityPage = 1;
      loadCommunityConversions();
    }

    function updateFilterButtonLabels() {
      const tierBtn = document.getElementById('tierFilterBtn');
      const typeBtn = document.getElementById('typeFilterBtn');
      const tierLabel = document.getElementById('tierFilterLabel');
      const typeLabel = document.getElementById('typeFilterLabel');

      if (selectedTiers.length === 0) {
        tierLabel.textContent = 'All Tiers';
        tierBtn.classList.remove('has-selection');
      } else if (selectedTiers.length === 1) {
        tierLabel.textContent = `Tier ${selectedTiers[0]}`;
        tierBtn.classList.add('has-selection');
      } else {
        tierLabel.textContent = `${selectedTiers.length} Tiers`;
        tierBtn.classList.add('has-selection');
      }

      if (selectedTypes.length === 0) {
        typeLabel.textContent = 'All Types';
        typeBtn.classList.remove('has-selection');
      } else if (selectedTypes.length === 1) {
        typeLabel.textContent = selectedTypes[0];
        typeBtn.classList.add('has-selection');
      } else {
        typeLabel.textContent = `${selectedTypes.length} Types`;
        typeBtn.classList.add('has-selection');
      }
    }

    async function loadCommunityConversions() {
      const listEl = document.getElementById('communityList');
      listEl.innerHTML = `
        <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton-tags"><div class="skeleton skeleton-tag"></div><div class="skeleton skeleton-tag"></div></div></div>
        <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton-tags"><div class="skeleton skeleton-tag"></div><div class="skeleton skeleton-tag"></div></div></div>
        <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton-tags"><div class="skeleton skeleton-tag"></div><div class="skeleton skeleton-tag"></div></div></div>
        <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton-tags"><div class="skeleton skeleton-tag"></div><div class="skeleton skeleton-tag"></div></div></div>
      `;

      try {
        const search = document.getElementById('communitySearch').value;
        const sort = document.getElementById('communitySort').value;

        const params = new URLSearchParams({
          page: communityPage,
          limit: 20,
          search,
          sort
        });

        // Add multi-select filters as comma-separated values
        if (selectedTiers.length > 0) {
          params.set('tier', selectedTiers.join(','));
        }
        if (selectedTypes.length > 0) {
          params.set('type', selectedTypes.join(','));
        }

        const response = await fetch(`/api/community/conversions?${params}`);
        const data = await response.json();

        communityConversions = data.conversions || [];
        communityTotalPages = data.pagination?.totalPages || 1;
        communityLoaded = true;

        renderCommunityList();
        updateCommunityPagination();

      } catch (err) {
        console.error('Failed to load community conversions:', err);
        listEl.innerHTML = `
          <div class="community-empty">
            <p>Could not load community conversions.</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Make sure the server is running.</p>
          </div>
        `;
      }
    }

    function renderCommunityList() {
      const listEl = document.getElementById('communityList');

      if (communityConversions.length === 0) {
        listEl.innerHTML = `
          <div class="community-empty">
            <p>No conversions found.</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Be the first to share your creation!</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = communityConversions.map(conv => {
        const data = conv.data || {};
        const hp = data.hp || '?';
        const stress = data.stress || '?';
        const difficulty = data.difficulty || '?';
        const majorThresh = data.majorThresh || data.thresholds?.major || '?';
        const severeThresh = data.severeThresh || data.thresholds?.severe || '?';
        const description = data.description || '';
        const motives = data.motives || '';
        const atkMod = data.atkMod || data.attack?.modifier || '?';
        const weapon = data.weapon || data.attack?.name || '';
        const range = data.range || data.attack?.range || '';
        const damage = data.damage || data.attack?.damage || '';
        const dmgType = data.dmgType || data.attack?.type || '';
        const sourceSystem = conv.sourceSystem || data.sourceSystem;
        const authorAvatar = conv.author?.avatarUrl
          ? `<img src="${conv.author.avatarUrl}" alt="">`
          : '';

        // Build attack line
        let attackLine = '';
        if (atkMod && atkMod !== '?') {
          attackLine = `<span class="dh-stat-item"><span class="dh-stat-label">ATK:</span> ${atkMod}</span>`;
          if (weapon) attackLine += `<span class="dh-stat-separator">|</span><span class="dh-stat-item">${weapon}: ${range}</span>`;
          if (damage) attackLine += `<span class="dh-stat-separator">|</span><span class="dh-stat-item">${damage}${dmgType ? ' ' + dmgType : ''}</span>`;
        }

        const cardTypeClass = (conv.advType || 'standard').toLowerCase().trim();

        return `
          <div class="community-item" onclick="openCommunityModal('${conv.id}')">
            <div class="dh-card-header" data-type="${cardTypeClass}">
              <div class="dh-card-name">${escapeHtml(conv.name)}</div>
              <div class="dh-card-tier-type">Tier ${conv.tier} ${conv.advType}</div>
            </div>
            <div class="dh-card-body">
              ${description ? `<div class="dh-card-description">${escapeHtml(description)}</div>` : ''}
              ${motives ? `<div class="dh-card-motives"><strong>Motives & Tactics:</strong> ${escapeHtml(motives)}</div>` : ''}
              <div class="mini-stats-container">
                <div class="mini-vitals-row">
                  <div class="mini-vital-box difficulty">
                    <span class="mini-vital-value">${difficulty}</span>
                    <span class="mini-vital-label">Diff</span>
                  </div>
                  <div class="mini-vital-box hp">
                    <span class="mini-vital-value">${hp}</span>
                    <span class="mini-vital-label">HP</span>
                  </div>
                  <div class="mini-vital-box stress">
                    <span class="mini-vital-value">${stress}</span>
                    <span class="mini-vital-label">Stress</span>
                  </div>
                </div>
                <div class="mini-damage-tracker">
                  <div class="mini-damage-card">
                    <svg viewBox="0 0 250 120" preserveAspectRatio="xMidYMid meet">
                      <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975">
                        <path d="M -974.223 2292.978 L -974.223 2042.978 L -874.223 1942.978 L -874.223 1442.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                      </g>
                    </svg>
                    <span class="mini-card-label">Minor</span>
                  </div>
                  <div class="mini-connector"><span class="mini-connector-number">${majorThresh}</span></div>
                  <div class="mini-damage-card">
                    <svg viewBox="0 0 250 120" preserveAspectRatio="xMidYMid meet">
                      <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975">
                        <path d="M -974.223 2292.978 L -974.223 2042.978 L -624.223 1692.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                        <path d="M -974.223 1842.978 L -974.223 1542.978 L -824.223 1692.978 L -974.223 1842.978 Z"/>
                      </g>
                    </svg>
                    <span class="mini-card-label">Major</span>
                  </div>
                  <div class="mini-connector"><span class="mini-connector-number">${severeThresh}</span></div>
                  <div class="mini-damage-card">
                    <svg viewBox="0 0 250 120" preserveAspectRatio="xMidYMid meet">
                      <g transform="matrix(0.1, 0, 0, -0.1, 97.422302, 229.297806)" fill="#5F6975">
                        <path d="M -974.223 2292.978 L -974.223 2042.978 L -624.223 1692.978 L -974.223 1342.978 L -974.223 1092.978 L -724.223 1092.978 L -624.223 1192.978 L 1175.777 1192.978 L 1275.777 1092.978 L 1525.777 1092.978 L 1525.777 1342.978 L 1425.777 1442.978 L 1425.777 1942.978 L 1525.777 2042.978 L 1525.777 2292.978 L 1275.777 2292.978 L 1175.777 2192.978 L -624.223 2192.978 L -724.223 2292.978 L -974.223 2292.978 Z"/>
                        <path d="M -974.223 1842.978 L -974.223 1542.978 L -824.223 1692.978 L -974.223 1842.978 Z"/>
                      </g>
                    </svg>
                    <span class="mini-card-label">Severe</span>
                  </div>
                </div>
                ${attackLine ? `<div class="dh-card-stats-row">${attackLine}</div>` : ''}
              </div>
            </div>
            <div class="dh-card-footer">
              <div class="dh-card-author">${authorAvatar}@${escapeHtml(conv.author?.username || 'Unknown')}</div>
              <div class="dh-card-footer-right">
                ${sourceSystem ? `<span class="dh-card-source">${escapeHtml(sourceSystem)}</span>` : ''}
                <button class="share-link-btn" onclick="event.stopPropagation(); copyShareLinkFor('${conv.id}')" title="Copy share link">&#128279;</button>
              </div>
            </div>
            <div class="community-item-votes">
              <button class="vote-btn upvote ${conv.userVote === 1 ? 'active' : ''}"
                      onclick="event.stopPropagation(); quickVote('${conv.id}', 1)">&#9650;</button>
              <span class="vote-score ${conv.score > 0 ? 'positive' : conv.score < 0 ? 'negative' : ''}">${conv.score}</span>
              <button class="vote-btn downvote ${conv.userVote === -1 ? 'active' : ''}"
                      onclick="event.stopPropagation(); quickVote('${conv.id}', -1)">&#9660;</button>
              <button class="quick-save-btn ${isInLibrary(conv.data?.id) ? 'saved' : ''}"
                      onclick="event.stopPropagation(); quickSaveToLibrary('${conv.id}')"
                      title="${isInLibrary(conv.data?.id) ? 'Remove from library' : 'Save to library'}">
                ${isInLibrary(conv.data?.id) ? '★' : '☆'}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateCommunityPagination() {
      const paginationEl = document.getElementById('communityPagination');
      const pageInfo = document.getElementById('communityPageInfo');
      const prevBtn = document.getElementById('communityPrevBtn');
      const nextBtn = document.getElementById('communityNextBtn');

      if (communityTotalPages <= 1) {
        paginationEl.classList.add('hidden');
        return;
      }

      paginationEl.classList.remove('hidden');
      pageInfo.textContent = `Page ${communityPage} of ${communityTotalPages}`;
      prevBtn.disabled = communityPage <= 1;
      nextBtn.disabled = communityPage >= communityTotalPages;
    }

    function communityPrevPage() {
      if (communityPage > 1) {
        communityPage--;
        loadCommunityConversions();
      }
    }

    function communityNextPage() {
      if (communityPage < communityTotalPages) {
        communityPage++;
        loadCommunityConversions();
      }
    }

    function debounceCommunitySearch() {
      clearTimeout(communitySearchDebounce);
      communitySearchDebounce = setTimeout(() => {
        communityPage = 1;
        loadCommunityConversions();
      }, 300);
    }

    async function quickVote(conversionId, vote) {
      if (!currentUser) {
        showToast('Please log in to vote', 'info');
        return;
      }

      const conv = communityConversions.find(c => c.id === conversionId);
      if (!conv) return;

      // Toggle vote if clicking the same button
      const newVote = conv.userVote === vote ? 0 : vote;

      try {
        const response = await fetch(`/api/community/conversions/${conversionId}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vote: newVote })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Vote failed');
        }

        const data = await response.json();

        // Update local state
        conv.userVote = data.userVote;
        conv.upvotes = data.upvotes;
        conv.downvotes = data.downvotes;
        conv.score = data.score;

        renderCommunityList();

      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // ==================== COMMUNITY MODAL ====================
    async function openCommunityModal(conversionId) {
      const modal = document.getElementById('communityModal');
      const statBlockEl = document.getElementById('modalStatBlock');

      // Find in local cache first
      selectedConversion = communityConversions.find(c => c.id === conversionId);

      if (!selectedConversion) {
        // Fetch from server
        try {
          const response = await fetch(`/api/community/conversions/${conversionId}`);
          selectedConversion = await response.json();
        } catch (err) {
          showToast('Failed to load conversion', 'error');
          return;
        }
      }

      statBlockEl.innerHTML = renderStatBlockReadOnly(selectedConversion.data);
      updateModalVotes();
      updateModalAuthor();
      updateDeleteButton();

      // Update URL for direct linking (only if not already on this URL)
      if (window.location.pathname !== `/community/${conversionId}`) {
        window.history.pushState({ conversionId }, '', `/community/${conversionId}`);
      }

      modal.classList.remove('hidden');

      // Position dice tooltips after modal is visible
      setTimeout(() => positionDiceTooltips(modal), 50);
    }

    function updateDeleteButton() {
      const deleteBtn = document.getElementById('modalDeleteBtn');
      if (!deleteBtn) return;

      // Show delete button only if user owns this conversion
      deleteBtn.classList.toggle('hidden', !selectedConversion?.isOwner);
    }

    async function deleteMyConversion() {
      if (!selectedConversion || !currentUser) return;

      if (!confirm(`Are you sure you want to delete "${selectedConversion.name || selectedConversion.data?.name || 'this conversion'}"? This cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/community/conversions/${selectedConversion.id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to delete');
        }

        showToast('Conversion deleted', 'success');
        closeCommunityModal();
        loadCommunityConversions();
      } catch (err) {
        showToast(err.message || 'Failed to delete conversion', 'error');
      }
    }

    function closeCommunityModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('communityModal').classList.add('hidden');
      selectedConversion = null;
      // Reset URL if we're on a community detail page
      if (window.location.pathname.startsWith('/community/')) {
        window.history.pushState({}, '', '/');
      }
    }

    function updateModalAuthor() {
      const authorEl = document.getElementById('modalAuthor');
      if (!selectedConversion || !authorEl) return;

      const author = selectedConversion.author;
      if (author) {
        const avatarHtml = author.avatarUrl
          ? `<img src="${author.avatarUrl}" alt="">`
          : '';
        const date = selectedConversion.createdAt
          ? new Date(selectedConversion.createdAt).toLocaleDateString()
          : '';
        authorEl.innerHTML = `${avatarHtml}Shared by @${escapeHtml(author.username)}${date ? ` on ${date}` : ''}`;
      } else {
        authorEl.innerHTML = '';
      }
    }

    function updateModalVotes() {
      if (!selectedConversion) return;

      const scoreEl = document.getElementById('modalVoteScore');
      const upBtn = document.getElementById('modalUpvoteBtn');
      const downBtn = document.getElementById('modalDownvoteBtn');

      scoreEl.textContent = selectedConversion.score;
      scoreEl.className = 'vote-score';
      if (selectedConversion.score > 0) scoreEl.classList.add('positive');
      if (selectedConversion.score < 0) scoreEl.classList.add('negative');

      upBtn.classList.toggle('active', selectedConversion.userVote === 1);
      downBtn.classList.toggle('active', selectedConversion.userVote === -1);
    }

    async function voteOnConversion(vote) {
      if (!currentUser) {
        showToast('Please log in to vote', 'info');
        return;
      }

      if (!selectedConversion) return;

      const newVote = selectedConversion.userVote === vote ? 0 : vote;

      try {
        const response = await fetch(`/api/community/conversions/${selectedConversion.id}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vote: newVote })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Vote failed');
        }

        const data = await response.json();

        selectedConversion.userVote = data.userVote;
        selectedConversion.score = data.score;

        // Update in list if exists
        const listConv = communityConversions.find(c => c.id === selectedConversion.id);
        if (listConv) {
          listConv.userVote = data.userVote;
          listConv.score = data.score;
          listConv.upvotes = data.upvotes;
          listConv.downvotes = data.downvotes;
        }

        updateModalVotes();
        renderCommunityList();

      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    function copyModalJSON() {
      if (!selectedConversion) return;
      navigator.clipboard.writeText(JSON.stringify(selectedConversion.data, null, 2))
        .then(() => showToast('JSON copied to clipboard!', 'success'))
        .catch(() => showToast('Failed to copy', 'error'));
    }

    function addModalToLibrary() {
      if (!selectedConversion) return;

      try {
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const data = {
          ...selectedConversion.data,
          _communityId: selectedConversion.id,
          _isCreator: selectedConversion.isOwner || false
        };

        const existing = existingLibrary.findIndex(item => item.id === data.id);
        if (existing >= 0) {
          existingLibrary[existing] = data;
          showToast('Updated in library!', 'success');
        } else {
          existingLibrary.push(data);
          showToast('Added to library!', 'success');
        }

        localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
      } catch (err) {
        showToast('Could not add to library: ' + err.message, 'error');
      }
    }

    function quickSaveToLibrary(conversionId) {
      const conv = communityConversions.find(c => c.id === conversionId);
      if (!conv) return;

      try {
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const data = {
          ...conv.data,
          _communityId: conv.id,
          _isCreator: conv.isOwner || false
        };

        const existingIdx = existingLibrary.findIndex(item => item.id === data.id);
        if (existingIdx >= 0) {
          // Already in library - remove it (toggle off)
          existingLibrary.splice(existingIdx, 1);
          localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
          showToast('Removed from library', 'info');
        } else {
          // Add to library
          existingLibrary.push(data);
          localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
          showToast('Saved to library!', 'success');
        }

        // Re-render to update star state
        renderCommunityList();
      } catch (err) {
        showToast('Could not save: ' + err.message, 'error');
      }
    }

    function isInLibrary(dataId) {
      try {
        const library = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        return library.some(item => item.id === dataId);
      } catch {
        return false;
      }
    }

    function addModalToGroup() {
      if (!selectedConversion) return;

      // First add to library if not already there
      try {
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const data = { ...selectedConversion.data, _userCreated: true };

        const existing = existingLibrary.findIndex(item => item.id === data.id);
        if (existing < 0) {
          existingLibrary.push(data);
          localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));
        }
      } catch (err) {
        console.error('Failed to add to library:', err);
      }

      // Then open group selection modal
      addAdversaryToGroup(selectedConversion.data);
    }

    function copyShareLink() {
      if (!selectedConversion) return;
      const url = `${window.location.origin}/community/${selectedConversion.id}`;
      navigator.clipboard.writeText(url)
        .then(() => showToast('Share link copied!', 'success'))
        .catch(() => showToast('Failed to copy link', 'error'));
    }

    function copyShareLinkFor(conversionId) {
      const url = `${window.location.origin}/community/${conversionId}`;
      navigator.clipboard.writeText(url)
        .then(() => showToast('Share link copied!', 'success'))
        .catch(() => showToast('Failed to copy link', 'error'));
    }

    function openReportModal() {
      if (!selectedConversion) return;
      if (!currentUser) {
        showToast('Please log in to report content', 'info');
        return;
      }
      document.getElementById('reportConversionName').textContent = `Reporting: ${selectedConversion.name}`;
      document.getElementById('reportReason').value = '';
      document.getElementById('reportModal').classList.remove('hidden');
    }

    function closeReportModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('reportModal').classList.add('hidden');
    }

    async function submitReport() {
      if (!selectedConversion) return;

      const reason = document.getElementById('reportReason').value.trim();
      if (reason.length < 10) {
        showToast('Please provide more detail (at least 10 characters)', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/community/conversions/${selectedConversion.id}/report`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to submit report');
        }

        closeReportModal();
        showToast('Report submitted. Thank you for helping keep the community safe.', 'success');
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // ==================== COMMUNITY FILTERS ====================
    let communityFilterMode = 'all';

    function setCommunityFilter(mode) {
      communityFilterMode = mode;
      communityPage = 1;

      // Update active state
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === mode);
      });

      if (mode === 'mine') {
        loadMySubmissions();
      } else {
        loadCommunityConversions();
      }
    }

    async function loadMySubmissions() {
      const listEl = document.getElementById('communityList');
      listEl.innerHTML = `
        <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton-tags"><div class="skeleton skeleton-tag"></div><div class="skeleton skeleton-tag"></div></div></div>
        <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text"></div><div class="skeleton-tags"><div class="skeleton skeleton-tag"></div><div class="skeleton skeleton-tag"></div></div></div>
      `;

      try {
        const response = await fetch('/api/community/my-submissions');
        if (!response.ok) throw new Error('Failed to load');

        const data = await response.json();
        communityConversions = data.conversions || [];
        communityTotalPages = 1;

        if (communityConversions.length === 0) {
          listEl.innerHTML = `
            <div class="community-empty">
              <h3>No submissions yet</h3>
              <p>Convert a stat block and click "Share to Community" to get started!</p>
            </div>
          `;
        } else {
          renderCommunityList();
        }

        document.getElementById('communityPagination').classList.add('hidden');

      } catch (err) {
        listEl.innerHTML = `
          <div class="community-empty">
            <p>Could not load your submissions.</p>
          </div>
        `;
      }
    }

    // ==================== URL ROUTING ====================
    function handleUrlRouting() {
      const path = window.location.pathname;

      // Handle /community/:id routes
      const communityMatch = path.match(/^\/community\/(.+)$/);
      if (communityMatch) {
        const conversionId = communityMatch[1];
        navigateTo('community');
        // Wait for community page to load, then open modal
        setTimeout(() => openCommunityModal(conversionId), 100);
        return;
      }
    }

    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      if (e.state?.conversionId) {
        openCommunityModal(e.state.conversionId);
      } else {
        closeCommunityModal();
      }
    });

    // ==================== SAVE AND PUBLISH ====================
    async function saveAndPublish() {
      if (!currentUser) {
        showToast('Please sign in to save and publish', 'info');
        return;
      }

      if (!currentConverted) {
        showToast('Nothing to save. Convert a stat block first.', 'error');
        return;
      }

      try {
        // Publish to community
        const response = await fetch('/api/community/conversions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: currentConverted.name,
            tier: currentConverted.tier,
            advType: currentConverted.advType,
            sourceSystem: detectedSystem,
            data: getExportObject()
          })
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Failed to save');
        }

        const result = await response.json();
        const communityId = result.id;

        // Save to local library with creator info
        const existingLibrary = JSON.parse(localStorage.getItem('dh-user-library') || '[]');
        const exportObj = getExportObject();
        exportObj._communityId = communityId;
        exportObj._isCreator = true;

        const existingIdx = existingLibrary.findIndex(item => item.id === exportObj.id);
        if (existingIdx >= 0) {
          existingLibrary[existingIdx] = exportObj;
        } else {
          existingLibrary.push(exportObj);
        }
        localStorage.setItem('dh-user-library', JSON.stringify(existingLibrary));

        showToast('Saved and published!', 'success');

        // Reload if on community tab
        if (communityLoaded) {
          communityPage = 1;
          loadCommunityConversions();
        }

      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // Legacy function for backwards compatibility
    async function shareToCommunity() {
      return saveAndPublish();
    }

    // Close modals on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const communityModal = document.getElementById('communityModal');
        const loginModal = document.getElementById('loginModal');
        const keyboardModal = document.getElementById('keyboardModal');

        if (keyboardModal && !keyboardModal.classList.contains('hidden')) {
          closeKeyboardModal();
        }
        if (communityModal && !communityModal.classList.contains('hidden')) {
          closeCommunityModal();
        }
        if (loginModal && !loginModal.classList.contains('hidden')) {
          closeLoginModal();
        }
      }
    });
  </script>

  <!-- Fixed tooltip for dice rolls (escapes modal overflow) -->
  <div id="dice-tooltip"></div>
</body>
</html>
